# BuyGo Plus One - æ¸¬è©¦æ¨¡å¼è¨­å®š

## ğŸ§ª å•Ÿç”¨ Webhook æ¸¬è©¦æ¨¡å¼

åœ¨é–‹ç™¼éšæ®µï¼Œä½ å¯ä»¥å•Ÿç”¨æ¸¬è©¦æ¨¡å¼ä¾†è·³éæ¬Šé™æª¢æŸ¥ï¼Œè®“æ‰€æœ‰ç¶å®š LINE çš„ä½¿ç”¨è€…éƒ½èƒ½ä½¿ç”¨ Webhook åŠŸèƒ½ã€‚

### è¨­å®šæ–¹å¼

åœ¨ `wp-config.php` æª”æ¡ˆä¸­åŠ å…¥ä»¥ä¸‹å¸¸æ•¸ï¼ˆåœ¨ `/* That's all, stop editing! */` ä¹‹å‰ï¼‰ï¼š

```php
/**
 * BuyGo Plus One - æ¸¬è©¦æ¨¡å¼
 * 
 * å•Ÿç”¨å¾Œï¼Œæ‰€æœ‰ç¶å®š LINE çš„ä½¿ç”¨è€…éƒ½èƒ½ä½¿ç”¨ Webhook åŠŸèƒ½ï¼ˆè·³éæ¬Šé™æª¢æŸ¥ï¼‰
 * æ­£å¼ç’°å¢ƒè«‹è¨­ç‚º false æˆ–ç§»é™¤æ­¤å¸¸æ•¸
 */
define( 'BUYGO_WEBHOOK_TEST_MODE', true );
```

### æ¸¬è©¦æ¨¡å¼ vs æ­£å¼æ¨¡å¼

| æ¨¡å¼ | è¨­å®š | æ¬Šé™æª¢æŸ¥ | é©ç”¨æƒ…å¢ƒ |
|------|------|----------|----------|
| **æ¸¬è©¦æ¨¡å¼** | `BUYGO_WEBHOOK_TEST_MODE = true` | âŒ è·³éæª¢æŸ¥ | é–‹ç™¼ã€æ¸¬è©¦éšæ®µ |
| **æ­£å¼æ¨¡å¼** | `BUYGO_WEBHOOK_TEST_MODE = false` æˆ–æœªå®šç¾© | âœ… åš´æ ¼æª¢æŸ¥ | æ­£å¼ç’°å¢ƒ |

### æ¬Šé™æª¢æŸ¥é‚è¼¯ï¼ˆæ­£å¼æ¨¡å¼ï¼‰

æ­£å¼æ¨¡å¼ä¸‹ï¼Œåªæœ‰ä»¥ä¸‹è§’è‰²å¯ä»¥ä½¿ç”¨ Webhook åŠŸèƒ½ï¼š
- `administrator`ï¼ˆç®¡ç†å“¡ï¼‰
- `buygo_admin`ï¼ˆBuyGo ç®¡ç†å“¡ï¼‰

å…¶ä»–è§’è‰²çš„ä½¿ç”¨è€…ä¸Šå‚³åœ–ç‰‡æˆ–ç™¼é€è¨Šæ¯æ™‚ï¼Œç³»çµ±æœƒéœé»˜è™•ç†ï¼ˆä¸å›æ‡‰ï¼‰ã€‚

### æ—¥èªŒè¨˜éŒ„

ç„¡è«–å“ªç¨®æ¨¡å¼ï¼Œç³»çµ±éƒ½æœƒè¨˜éŒ„æ¬Šé™æª¢æŸ¥çµæœï¼š

**æ¸¬è©¦æ¨¡å¼**ï¼š
```
event_type: test_mode_active
message: Permission check skipped (test mode)
user_id: 2
```

**æ­£å¼æ¨¡å¼ï¼ˆæ¬Šé™ä¸è¶³ï¼‰**ï¼š
```
event_type: permission_denied
user_id: 3
roles: ['subscriber']
```

### åˆ‡æ›åˆ°æ­£å¼æ¨¡å¼

æ¸¬è©¦å®Œæˆå¾Œï¼Œè«‹è¨˜å¾—ï¼š
1. å°‡ `wp-config.php` ä¸­çš„å¸¸æ•¸æ”¹ç‚º `false`ï¼š
   ```php
   define( 'BUYGO_WEBHOOK_TEST_MODE', false );
   ```
2. æˆ–ç›´æ¥åˆªé™¤é€™è¡Œå¸¸æ•¸å®šç¾©

---

## ğŸ“ ä¿®æ­£å…§å®¹èªªæ˜

### å•é¡Œ

åŸæœ¬çš„æ¬Šé™æª¢æŸ¥ä½¿ç”¨ `current_user_can()`ï¼Œä½†åœ¨ Webhook ç’°å¢ƒä¸­ï¼š
- Webhook è«‹æ±‚æ˜¯ç”± LINE ä¼ºæœå™¨ç™¼é€çš„ HTTP è«‹æ±‚
- æ²’æœ‰ WordPress ç™»å…¥ Cookie
- `current_user_can()` æ°¸é è¿”å› `false`
- çµæœï¼šæ‰€æœ‰ä½¿ç”¨è€…ï¼ˆåŒ…æ‹¬ç®¡ç†å“¡ï¼‰éƒ½è¢«è¦–ç‚ºã€Œæ²’æœ‰æ¬Šé™ã€

### è§£æ±ºæ–¹æ¡ˆ

æ”¹ç‚ºæª¢æŸ¥ã€Œå¾ LINE UID æŸ¥åˆ°çš„ WordPress ä½¿ç”¨è€…ã€çš„è§’è‰²ï¼š
```php
$user_meta = get_userdata( $user->ID );
$can_upload = in_array( 'administrator', $user_meta->roles, true ) || 
              in_array( 'buygo_admin', $user_meta->roles, true );
```

é€™æ¨£å°±èƒ½æ­£ç¢ºåˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™ä½¿ç”¨ Webhook åŠŸèƒ½ã€‚

---

**å»ºç«‹æ™‚é–“**ï¼š2026-01-19
**ä¿®æ­£æª”æ¡ˆ**ï¼š`includes/services/class-line-webhook-handler.php`
