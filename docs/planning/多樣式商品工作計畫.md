# 多樣式商品工作計畫

> 建立日期：2026-01-22
> 狀態：規劃中

---

## 概述

本文件規劃 BuyGo+1 的多樣式商品功能，涵蓋 LINE 訊息上架流程與 BuyGo+1 前台管理介面兩大部分。

---

## LINE 訊息格式定義

### 單一商品格式

```
冬季外套
日幣：1200
原價：1800
數量：15
分類：服飾
到貨：06/15
預購：01/15
```

### 多樣式商品格式

```
日本限定三麗鷗玩偶
日幣：1000/1200/1500
原價：1500/1800/2000
分類：漢頓/布丁狗/大耳狗
數量：5/10/3
到貨：01/25
限量商品，每個款式數量有限！請盡快下單。
```

### 判斷規則

| 欄位 | 單一商品 | 多樣式商品 |
|------|---------|-----------|
| 日幣 | `1200` | `1000/1200/1500`（含 `/`） |
| 數量 | `15` | `5/10/3`（含 `/`） |
| 分類 | 商品類別 | **樣式名稱**（重要差異） |

**判斷邏輯**：若「日幣」或「數量」欄位包含 `/` 分隔符，則判定為多樣式商品。

---

## 解析後資料結構

### 單一商品

```php
[
    'name' => '冬季外套',
    'price' => 1200,           // 日幣
    'original_price' => 1800,
    'quantity' => 15,
    'category' => '服飾',
    'arrival_date' => '06/15',
    'preorder_date' => '01/15',
    'variations' => null,      // 無樣式
]
```

### 多樣式商品

```php
[
    'name' => '日本限定三麗鷗玩偶',
    'arrival_date' => '01/25',
    'description' => '限量商品，每個款式數量有限！請盡快下單。',
    'variations' => [
        [
            'variation_title' => '漢頓',
            'price' => 1000,
            'original_price' => 1500,
            'quantity' => 5,
        ],
        [
            'variation_title' => '布丁狗',
            'price' => 1200,
            'original_price' => 1800,
            'quantity' => 10,
        ],
        [
            'variation_title' => '大耳狗',
            'price' => 1500,
            'original_price' => 2000,
            'quantity' => 3,
        ],
    ],
]
```

---

## 實作清單

### A. 上架流程（LINE → FluentCart）

| 順序 | 檔案 | 修改內容 | 狀態 |
|------|------|---------|------|
| A-1 | `class-product-data-parser.php` | 新增 `isMultiVariation()` 判斷方法 | [ ] |
| A-2 | `class-product-data-parser.php` | 新增 `parseMultiVariation()` 解析方法 | [ ] |
| A-3 | `class-fluentcart-service.php` | 新增 `createMultipleVariations()` 方法 | [ ] |
| A-4 | `class-fluentcart-service.php` | 修改 `createProduct()` 支援多樣式 | [ ] |
| A-5 | FluentCommunity 貼文 | 確認多樣式模版正常運作 | [ ] |
| A-6 | LINE 通知 | 支援多樣式商品通知格式 | [ ] |

### B. 管理介面（BuyGo+1 前台）

| 順序 | 檔案 | 修改內容 | 狀態 |
|------|------|---------|------|
| B-1 | `products.php` | 新增「樣式」欄位：單一商品顯示「單一」，多樣式顯示下拉選單 | [ ] |
| B-2 | `products.php` | 下拉選單切換時，整行數據更新為該樣式的數據 | [ ] |
| B-3 | `products.php` | 多樣式商品操作欄新增「📊 統計」按鈕 | [ ] |
| B-4 | `products.php` | 統計彈窗：顯示所有樣式明細 + 合計 | [ ] |
| B-5 | `class-product-service.php` | 取得 variations 資料 | [ ] |
| B-6 | `class-products-api.php` | API 支援 variation 資料回傳 | [ ] |
| B-7 | `products.php` | 樣式層級：已採購數量、採購狀態編輯 | [ ] |
| B-8 | `products.php` | 分配子分頁：多樣式商品用 Tab 切換樣式 | [ ] |
| B-9 | `class-allocation-service.php` | 分配時記錄 `variation_id` | [ ] |
| B-10 | `orders.php` | 訂單明細顯示具體樣式名稱 | [ ] |
| B-11 | `shipment-products.php` | 備貨清單按樣式分組顯示 | [ ] |

### C. 延伸功能（待研究）

| 順序 | 功能 | 說明 | 狀態 |
|------|------|------|------|
| C-1 | 圖片輪播 | 商品卡片支援多張圖片左右切換 | 待研究 |
| C-2 | 樣式對應圖片 | 每個 variation 可設定獨立圖片 | 待研究 |
| C-3 | 上傳多圖自動對應 | 上傳 3 張圖 → 自動對應 3 個樣式 | 待研究 |

---

## 資料結構設計

### 新增 Meta 欄位（樣式層級）

| Meta Key | 層級 | 用途 |
|----------|------|------|
| `_buygo_variation_purchased` | variation | 該樣式已採購數量 |
| `_buygo_variation_procurement_status` | variation | 該樣式採購狀態 |

### 採購狀態選項

- `未採購`
- `採購中`
- `已到貨`

### FluentCart 既有表格

**`wp_fc_product_variations`**

| 欄位 | 說明 |
|------|------|
| id | variation ID |
| product_id | 主商品 ID |
| variation_title | 樣式名稱（漢頓/布丁狗/大耳狗） |
| item_price | 該樣式價格（以分為單位） |
| available | 可用庫存 |
| total_stock | 總庫存 |

---

## UI 設計（電腦版 - 列表模式）

### 表格欄位結構

| 商品 | 樣式 | 價格 | 狀態 | 下單 | 採購 | 已出貨 | 待出貨 | 預訂 | 操作 |

### 樣式欄位顯示邏輯

| 商品類型 | 樣式欄位 | 操作欄位 |
|---------|---------|---------|
| 單一商品 | `單一`（純文字） | 🔒 ✏️ 🗑️ |
| 多樣式商品 | `[布布 ▼]`（下拉選單） | 🔒 ✏️ 🗑️ **📊** |

### 多樣式商品下拉選單

```
┌─────────────┐
│   布布      │  ← 預設顯示第一個樣式
│   小米      │
│   大耳狗    │
└─────────────┘
```

- 預設顯示第一個上架的樣式
- 切換樣式後，整行數據（價格、下單、採購、已出貨等）都換成該樣式的數據

### 統計按鈕（📊）

只有多樣式商品才有此按鈕，點擊後顯示彈窗：

```
┌─────────────────────────────────────────────┐
│  三麗鷗玩偶 - 樣式統計                    ✕ │
├─────────────────────────────────────────────┤
│  樣式      價格    下單   採購   已出貨     │
│  ─────────────────────────────────────────  │
│  布布      ¥500     8      8      1         │
│  小米      ¥600     8      8      2         │
│  大耳狗    ¥800     8      8      2         │
│  ─────────────────────────────────────────  │
│  合計       -      24     24      5         │
└─────────────────────────────────────────────┘
```

### 商品列表範例

**單一商品：**
```
│ 冬季外套   單一     ¥1200   已上架   8   [8]   1   3   0   🔒 ✏️ 🗑️     │
```

**多樣式商品：**
```
│ 三麗鷗玩偶 [布布▼]  ¥500    已上架   8   [8]   1   3   0   🔒 ✏️ 🗑️ 📊  │
```

---

## UI 設計（電腦版 - 網格模式）

### 卡片結構

```
┌─────────────────────────┐
│ ☐    [< 圖1/3 >] [上架] │  ← 多圖輪播（如有多張圖）
├─────────────────────────┤
│   8       4        3    │
│  下單    分配     待出   │
├─────────────────────────┤
│ 布布            [多樣]  │  ← 標籤：單一 / 多樣
│ ¥500          [布布 ▼]  │  ← 多樣式才有下拉選單
│                         │
│ 採購數量       [ 8 ]    │
├─────────────────────────┤
│ 👥名單  🔒分配  ✏️   🗑️  │
└─────────────────────────┘
```

### 顯示邏輯

| 商品類型 | 標籤 | 下拉選單 | 圖片輪播 |
|---------|------|---------|---------|
| 單一商品 | `單一` | 無 | 無（單張圖） |
| 多樣式商品 | `多樣` | 有（樣式切換） | 有（如有多張圖） |

---

## UI 設計（手機版 - 列表模式）

### 卡片結構

```
┌─────────────────────────┐
│ ☐  [布布 ▼]             │  ← 多樣式才有下拉選單
├─────────────────────────┤
│ [< 圖1/3 >]             │  ← 多圖輪播
│ 布布    [單一]    上架  │  ← 或 [多樣]
│ ¥500          ID: 269   │
├─────────────────────────┤
│    下單         預訂    │
│     8           0       │
├─────────────────────────┤
│  已分配   已出貨   待出  │
│    4        1       3   │
├─────────────────────────┤
│   分配    編輯    刪除   │
└─────────────────────────┘
```

---

## UI 設計（分配子分頁 - 多樣式商品）

### 設計原則

- **不使用彈窗**，沿用現有子分頁設計
- 多樣式商品用 **Tab 切換** 不同樣式
- 每個 Tab 只顯示**購買該樣式的客戶訂單**
- 一次只操作一個樣式的分配

### 手機版

```
┌─────────────────────────────────────┐
│ ← 返回  庫存分配      [取消] [確認] │
├─────────────────────────────────────┤
│  [佈佈]    小米    大大             │  ← Tab 切換樣式
├─────────────────────────────────────┤
│  [圖片] 佈佈                        │
│         ¥500  ID: 269               │
│                                     │
│   已下單   已採購   可分配   已分配  │
│     8        8        4        4    │
├─────────────────────────────────────┤
│  待分配訂單 (4/4 筆)   [🔒 分配(0)] │
│  🔍 搜尋訂單編號或客戶名稱...       │
├─────────────────────────────────────┤
│  #185 余                      [ 0 ] │
│  下單 1  已配 0  待配 1             │
├─────────────────────────────────────┤
│  #182 余佳玲                  [ 0 ] │
│  下單 2  已配 1  待配 1             │
├─────────────────────────────────────┤
│  #181 余佳玲                  [ 0 ] │
│  下單 1  已配 0  待配 1             │
└─────────────────────────────────────┘
```

### 電腦版

同樣邏輯，版面更寬：

```
┌─────────────────────────────────────────────────────────────────────┐
│ ← 返回  庫存分配                                    [取消]  [確認]  │
├─────────────────────────────────────────────────────────────────────┤
│  [佈佈]    小米    大大                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [圖片] 佈佈  ¥500  ID: 269                                         │
│                                                                     │
│  已下單: 8    已採購: 8    可分配: 4    已分配: 4                    │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  待分配訂單 (4/4 筆)                    🔍 搜尋...    [🔒 分配(0)]  │
├─────────────────────────────────────────────────────────────────────┤
│  訂單編號    客戶      下單    已配    待配    分配數量             │
│  ───────────────────────────────────────────────────────────────    │
│  #185       余         1       0       1      [    ]               │
│  #182       余佳玲     2       1       1      [    ]               │
│  #181       余佳玲     1       0       1      [    ]               │
└─────────────────────────────────────────────────────────────────────┘
```

### Tab 切換行為

1. 點擊「小米」Tab → 頁面切換為小米的資料
2. 統計數據更新為小米的「已下單/已採購/可分配/已分配」
3. 訂單列表只顯示購買「小米」的客戶

### 單一商品

單一商品**沒有 Tab**，直接顯示分配列表（與現有設計相同）

---

## 解析邏輯參考

### ProductDataParser.php

```php
/**
 * 判斷是否為多樣式商品
 */
private function isMultiVariation(array $rawData): bool
{
    $price = $rawData['日幣'] ?? $rawData['price'] ?? '';
    $quantity = $rawData['數量'] ?? $rawData['quantity'] ?? '';

    return str_contains($price, '/') || str_contains($quantity, '/');
}

/**
 * 解析多樣式商品
 */
private function parseMultiVariation(array $rawData): array
{
    $prices = explode('/', $rawData['日幣']);
    $originalPrices = explode('/', $rawData['原價'] ?? '');
    $titles = explode('/', $rawData['分類']);  // 多樣式時「分類」是樣式名稱
    $quantities = explode('/', $rawData['數量']);

    $variations = [];
    foreach ($titles as $index => $title) {
        $variations[] = [
            'variation_title' => trim($title),
            'price' => (int) trim($prices[$index] ?? $prices[0]),
            'original_price' => (int) trim($originalPrices[$index] ?? 0),
            'quantity' => (int) trim($quantities[$index] ?? 0),
        ];
    }

    return $variations;
}
```

### FluentCartService.php

```php
/**
 * 建立多個 variations
 */
private function createMultipleVariations(int $productId, array $variations): void
{
    global $wpdb;
    $table = $wpdb->prefix . 'fc_product_variations';

    foreach ($variations as $index => $variation) {
        $wpdb->insert($table, [
            'post_id' => $productId,
            'variation_title' => sanitize_text_field($variation['variation_title']),
            'variation_identifier' => 'BUYGO-' . $productId . '-' . ($index + 1),
            'manage_stock' => 1,
            'stock_status' => $variation['quantity'] > 0 ? 'in-stock' : 'out-of-stock',
            'total_stock' => $variation['quantity'],
            'available' => $variation['quantity'],
            'item_status' => 'active',
            'item_price' => $variation['price'] * 100,  // FluentCart 用「分」
            'created_at' => current_time('mysql'),
            'updated_at' => current_time('mysql'),
        ]);
    }
}
```

---

## 相關文件

- `/docs/PERMISSION-SYSTEM.md` - 權限系統設計
- `/Desktop/VT工作流/_Archive/舊項目/claude-code-buygo-pluse-one/多樣式產品上架功能分析.md` - 原始分析文件

---

## 變更記錄

| 日期 | 變更內容 |
|------|---------|
| 2026-01-22 | 建立文件，完成初步規劃 |
| 2026-01-22 | 確定電腦版列表 UI：樣式下拉選單 + 統計按鈕（方案 B） |
| 2026-01-22 | 確定分配頁面設計：多樣式用 Tab 切換，不用彈窗 |
| 2026-01-22 | 補充網格模式、手機版 UI 設計 |
