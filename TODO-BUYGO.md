# BuyGo+1 待完成任務清單

> 更新日期：2026-01-22（下午 4:30 更新）

## 已完成任務

- [x] 修復一鍵分配 Bug - allocated_quantity 應存在 line_meta 中
- [x] 重新設計下單名單 UI - 顯示每筆獨立訂單而非整合
- [x] Phase B：Grid View 模式（商品列表大圖展示）
- [x] 為手機版加入 Grid View 切換功能（與電腦版一致）
- [x] 優化庫存分配頁面 - 移除下單時間、改橫向排列、修復輸入框問題
- [x] 修復已出貨訂單仍可分配的邏輯 Bug
- [x] 功能：訂單頁「批次轉備貨」- 勾選多筆訂單後一次性轉為備貨中狀態
- [x] 修復：父訂單有子訂單時隱藏轉備貨按鈕
- [x] 修復：批次轉備貨應處理子訂單而非父訂單
- [x] 修復：子訂單狀態變更時同步更新父訂單 shipping_status
- [x] 修復 Bug：出貨頁面應使用子分頁，不應出現彈跳視窗
- [x] 修復：批次轉備貨應檢查訂單是否已分配庫存（無分配不可轉備貨）

---

## 待完成任務

### 0. 商品頁面「下單名單」與「分配」子頁面優化（2026-01-22）
**優先級：高**

#### 問題 A：「下單名單」頁面改進
**位置**：`/products/?view=buyers&id=xxx`

**目前問題**：
1. 表頭第一欄是「日期」，當列表很長時無法辨識對應哪個訂單
2. 無分頁功能，50+ 筆資料時難以查找
3. 無搜尋功能
4. 手機版與電腦版風格差異大

**需要修改**：
1. 將「日期」欄位改為「訂單編號」
2. 訂單編號可點擊，跳轉至 `/orders/?view=detail&id=xxx`
3. 新增「客戶名稱」搜尋框
4. 新增分頁功能（使用現有 BuyGoPagination 組件）
   - 每頁筆數選項：5、20、50
5. 手機版 UI 統一採用「分配頁」風格（字體較小、精簡）
6. 統計區塊 UI 比照「訂單頁」與「產品頁」的設計風格

**電腦版預期 UI**：
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  ← 返回    下單名單                                                     [關閉]      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│      8         │       4        │        4        │        0                        │
│    總數量      │     已分配      │      待分配      │      已出貨                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  🔍 [搜尋客戶名稱...]                                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  訂單明細                                                         共 7 筆訂單       │
├──────────┬────────┬──────┬────────┬──────────┬──────────────────────────────────────┤
│ 訂單編號 │  客戶  │ 數量 │ 已分配 │   狀態   │                操作                  │
├──────────┼────────┼──────┼────────┼──────────┼──────────────────────────────────────┤
│   #189   │ 余佳玲 │  1   │   0    │  待分配  │            [一鍵分配]                │
│   ...    │  ...   │ ...  │  ...   │   ...    │               ...                    │
├──────────┴────────┴──────┴────────┴──────────┴──────────────────────────────────────┤
│          顯示 1-5 筆，共 7 筆     [5筆▼]    [<] [1] [2] [>]                          │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

**手機版預期 UI（採用分配頁風格）**：
```
┌───────────────────────────────────────┐
│  下單名單 (7/7 筆)                    │
├───────────────────────────────────────┤
│  🔍 [搜尋客戶名稱...]                 │
├───────────────────────────────────────┤
│  #189  余佳玲                         │  ← 點擊跳轉訂單詳情
│  數量 1   已配 0   待配 1             │
│  [待分配]              [一鍵分配]     │
├───────────────────────────────────────┤
│  [5筆▼]       [<] 1/2 [>]             │
└───────────────────────────────────────┘
```

---

#### 問題 B：「轉備貨」按鈕消失 Bug
**位置**：訂單頁面 `/orders/`

**問題描述**：
- 從「下單名單」點擊「一鍵分配」後
- 已完成分配的訂單（如 #189、#185）
- 操作欄應顯示橘色「轉備貨」按鈕，但目前沒有顯示

**需要調查**：
- 檢查 `orders.php` 中「轉備貨」按鈕的顯示條件
- 確認 `hasAllocatedItems()` 判斷邏輯是否正確
- 確認一鍵分配後訂單的 `line_meta` 是否正確更新

**相關檔案**：
- `/includes/views/pages/orders.php` - 訂單列表 UI
- `/includes/services/class-allocation-service.php` - 分配服務

---

#### 問題 C：「分配」頁面改進
**位置**：`/products/?view=allocation&id=xxx`

**目前問題**：
1. 無分頁功能，30+ 筆待分配訂單時難以查找
2. 訂單編號無法點擊跳轉
3. 「確認分配」按鈕只在最下方，需滑動很長才能點擊

**需要修改**：
1. 訂單編號可點擊，跳轉至 `/orders/?view=detail&id=xxx`
2. 新增分頁功能（使用現有 BuyGoPagination 組件）
   - 每頁筆數選項：5、20、50
3. 在頁面上方（待分配訂單標題旁）新增「確認分配」按鈕
4. 下方保留原有的「確認分配」按鈕
5. 統計區塊 UI 比照「訂單頁」與「產品頁」的設計風格

**電腦版預期 UI**：
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  待分配訂單 (5/5 筆)                                         [✓ 確認分配 0 件]      │  ← 上方新增按鈕
├─────────────────────────────────────────────────────────────────────────────────────┤
│  🔍 [搜尋訂單編號或客戶名稱...]                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  #189  余佳玲   下單 1  已配 0  待配 1                              [____0____]     │  ← 點擊 #189 跳轉
│  ...                                                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  [5筆▼]       [<] 1/2 [>]                                                           │  ← 新增分頁
├─────────────────────────────────────────────────────────────────────────────────────┤
│  總計分配：0                                           [✓ 確認分配 0 件]            │  ← 下方保留按鈕
└─────────────────────────────────────────────────────────────────────────────────────┘
```

**手機版預期 UI**：
```
┌───────────────────────────────────────┐
│  待分配訂單 (5/5 筆)                  │
│                    [✓ 確認分配 0 件]  │  ← 上方新增按鈕
├───────────────────────────────────────┤
│  🔍 [搜尋訂單編號或客戶名稱...]       │
├───────────────────────────────────────┤
│  #189  余佳玲                         │  ← 點擊跳轉訂單詳情
│  下單 1  已配 0  待配 1    [___0___]  │
├───────────────────────────────────────┤
│  [5筆▼]       [<] 1/2 [>]             │  ← 新增分頁
├───────────────────────────────────────┤
│  總計分配：0                          │
│            [✓ 確認分配 0 件]          │  ← 下方保留按鈕
└───────────────────────────────────────┘
```

**相關檔案**：
- `/includes/views/pages/products.php` - 商品頁面（包含分配與下單名單子頁面）
- `/components/shared/pagination.php` - 分頁組件（已存在）

---

### 1. Phase C：多樣式產品 UI + 狀態追蹤邏輯
**優先級：高**

**功能描述：**
支援多樣式（多規格）產品的 UI 顯示與狀態追蹤。例如：同一商品有不同顏色、尺寸等變體。

**需要實作：**
1. 商品列表顯示多樣式產品的方式
2. 每個樣式的獨立庫存追蹤
3. 分配時可以選擇特定樣式
4. 訂單中顯示購買的具體樣式

**相關檔案：**
- `/includes/views/pages/products.php`
- `/includes/services/class-product-service.php`
- `/includes/services/class-allocation-service.php`

---

## 技術筆記

### 訂單狀態流程
```
未出貨 (unshipped) → 備貨中 (preparing) → 待出貨 (processing) → 已出貨 (shipped) → 交易完成 (completed)
                                                                      ↓
                                                                   斷貨 (out_of_stock)
```

### 父子訂單邏輯
1. 父訂單有子訂單時，「轉備貨」按鈕不顯示在父訂單上
2. 批次轉備貨會自動處理子訂單而非父訂單
3. 子訂單狀態變更會自動同步更新父訂單的 shipping_status
4. 批次轉備貨需檢查 `hasAllocatedItems()`，無分配庫存的訂單不可轉備貨

### 出貨頁面子分頁架構
- 使用 `currentView` ref 控制顯示（'list' | 'detail'）
- 使用 `BuyGoRouter` 處理 URL 參數（?view=detail&id=123）
- 支援瀏覽器返回按鈕（popstate 監聽）

### 關鍵服務類別
- `AllocationService` - 庫存分配邏輯
- `OrderService` - 訂單管理
- `ShipmentService` - 出貨單管理
- `ShippingStatusService` - 運送狀態管理
- `ProductService` - 商品管理
