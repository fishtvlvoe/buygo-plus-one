# 端到端驗證測試計劃（E2E UAT）
# BuyGo+1 小幫手：LINE 上架商品到出貨通知完整流程

**建立時間:** 2026-02-04
**測試範圍:** v1.2 + v1.3 + v1.4（商品上架 → 訂單建立 → 拆單 → 出貨 → LINE 通知 → 會員查看子訂單）
**測試網站:** https://test.buygo.me
**測試角色:** 小幫手（賣家）、購物者（顧客）

---

## 測試流程概覽

```
1. 商品上架（小幫手後台）
   ↓
2. 顧客下單（FluentCart 前台）
   ↓
3. 訂單自動拆單（系統自動）
   ↓
4. 小幫手出貨（後台標記已出貨）
   ↓
5. LINE 通知發送（自動觸發）
   ↓
6. 顧客查看子訂單（FluentCart 會員前台）
```

---

## 測試前準備

### 環境檢查
- [ ] WordPress 外掛已啟用：buygo-plus-one-dev（符號連結）
- [ ] WordPress 外掛已啟用：buygo-line-notify
- [ ] WordPress 外掛已啟用：FluentCart
- [ ] 測試網站可正常訪問：https://test.buygo.me
- [ ] 小幫手帳號已建立並有正確權限（buygo_seller 角色）
- [ ] 測試顧客帳號已建立
- [ ] LINE 綁定已完成（小幫手和顧客都有綁定 LINE）

### 測試帳號資訊
| 角色 | WordPress 帳號 | LINE 綁定狀態 | 權限 |
|------|----------------|---------------|------|
| 小幫手 A | （填寫帳號） | ✅ 已綁定 | buygo_seller |
| 小幫手 B | （填寫帳號） | ✅ 已綁定 | buygo_seller |
| 顧客 | （填寫帳號） | ✅ 已綁定 | customer |

---

## 測試案例

### Test 1: 商品上架（小幫手後台）

**目標:** 驗證小幫手可以成功上架商品，並觸發 LINE 通知

**前置條件:**
- 使用小幫手帳號登入 WordPress 後台
- 訪問小幫手後台：https://test.buygo.me/wp-admin/admin.php?page=buygo-plus-one

**測試步驟:**
1. 進入「商品管理」頁面
2. 點擊「新增商品」按鈕
3. 填寫商品資訊：
   - 商品名稱：「測試商品 E2E-001」
   - 價格：100
   - 庫存：10
   - 商品圖片：（選擇任意圖片）
4. 點擊「上架」按鈕

**預期結果:**
- [ ] 商品成功建立，顯示在商品列表中
- [ ] 商品狀態為「已上架」（status = 'published'）
- [ ] 小幫手收到 LINE 通知：「🎉 商品上架成功！【測試商品 E2E-001】」
- [ ] LINE 通知包含商品名稱、價格、庫存數量

**實際結果:**
```
（記錄測試結果）
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

### Test 2: 顧客下單（FluentCart 前台）

**目標:** 驗證顧客可以在 FluentCart 前台成功下單購買商品

**前置條件:**
- 使用顧客帳號登入
- Test 1 中的商品已成功上架

**測試步驟:**
1. 訪問商品頁面或商店首頁
2. 將「測試商品 E2E-001」加入購物車（數量：2）
3. 前往結帳頁面
4. 填寫收件資訊（姓名、地址、電話）
5. 選擇付款方式（信用卡或其他）
6. 完成付款

**預期結果:**
- [ ] 訂單成功建立
- [ ] 訂單狀態為「已付款」（payment_status = 'paid'）
- [ ] FluentCart 訂單詳情頁顯示訂單資訊
- [ ] 訂單編號格式正確（例如：#12345）

**實際結果:**
```
訂單編號：
訂單金額：
訂單狀態：
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

### Test 3: 訂單自動拆單（系統自動）

**目標:** 驗證系統能根據商品所屬賣家自動拆分訂單

**前置條件:**
- Test 2 中的訂單已成功建立
- 訂單包含多個不同賣家的商品（或單一賣家商品）

**測試步驟:**
1. 訪問 WordPress 後台
2. 檢查資料庫：
   - `wp_fct_orders` 表（主訂單）
   - `wp_fct_child_orders` 表（子訂單）
3. 或使用 Test Script Manager 執行查詢：
   ```php
   global $wpdb;
   $parent_order_id = 12345; // 填入測試訂單 ID

   echo "主訂單資訊：\n";
   $parent = $wpdb->get_row("SELECT * FROM wp_fct_orders WHERE id = $parent_order_id");
   print_r($parent);

   echo "\n子訂單資訊：\n";
   $children = $wpdb->get_results("SELECT * FROM wp_fct_child_orders WHERE parent_order_id = $parent_order_id");
   print_r($children);
   ```

**預期結果:**
- [ ] `wp_fct_child_orders` 表中存在子訂單
- [ ] 子訂單的 `parent_order_id` 正確指向主訂單
- [ ] 每個子訂單對應一個賣家（seller_id）
- [ ] 子訂單商品清單正確（來自 `wp_fct_order_items`）
- [ ] 子訂單金額小計正確

**實際結果:**
```
主訂單 ID：
子訂單數量：
子訂單 1 - 賣家 ID：
子訂單 1 - 金額：
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

### Test 4: 小幫手標記已出貨（後台操作）

**目標:** 驗證小幫手可以在後台標記訂單已出貨

**前置條件:**
- 使用小幫手帳號登入後台
- Test 3 中的子訂單已建立

**測試步驟:**
1. 訪問小幫手後台：https://test.buygo.me/wp-admin/admin.php?page=buygo-plus-one
2. 進入「訂單管理」頁面
3. 找到 Test 2 中建立的訂單
4. 點擊「標記已出貨」或「出貨管理」按鈕
5. 填寫物流資訊（選填）
6. 確認出貨

**預期結果:**
- [ ] 訂單狀態更新為「已出貨」（shipping_status = 'shipped'）
- [ ] `wp_buygo_shipments` 表中新增出貨記錄
- [ ] 出貨時間記錄正確（shipped_at）
- [ ] 小幫手後台顯示出貨成功訊息

**實際結果:**
```
出貨記錄 ID：
出貨時間：
訂單狀態：
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

### Test 5: LINE 出貨通知發送（自動觸發）

**目標:** 驗證顧客在訂單出貨後收到 LINE 通知

**前置條件:**
- Test 4 中的訂單已標記為已出貨
- 顧客已綁定 LINE 帳號

**測試步驟:**
1. 檢查顧客的 LINE 聊天室
2. 確認是否收到出貨通知訊息
3. 檢查 WordPress 後台 LINE 通知記錄（如有）

**預期結果:**
- [ ] 顧客收到 LINE 出貨通知
- [ ] 通知內容包含：訂單編號、商品名稱、出貨狀態
- [ ] 通知格式正確，無亂碼
- [ ] 通知時間與出貨操作時間一致（誤差 < 1 分鐘）

**通知訊息範例:**
```
📦 您的訂單已出貨！

訂單編號：#12345
商品：測試商品 E2E-001 x2
金額：NT$ 200
狀態：已出貨

感謝您的購買！
```

**實際結果:**
```
是否收到通知：⬜ 是 / ❌ 否
通知內容：
（貼上截圖或文字）
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

### Test 6: 顧客查看子訂單（FluentCart 會員前台）

**目標:** 驗證顧客可以在會員前台查看子訂單詳細資訊

**前置條件:**
- 使用顧客帳號登入
- Test 3 中的子訂單已建立

**測試步驟:**
1. 訪問 FluentCart 會員中心：https://test.buygo.me/my-account/
2. 進入「訂單記錄」或「Purchase History」
3. 點擊 Test 2 中的訂單進入詳情頁
4. 查看是否有「查看子訂單」按鈕
5. 點擊「查看子訂單」按鈕
6. 檢查子訂單列表顯示

**預期結果:**
- [ ] 訂單詳情頁顯示「查看子訂單」按鈕（使用 BuyGo+1 .btn 樣式）
- [ ] 點擊按鈕後出現 Loading 動畫
- [ ] 子訂單列表以卡片形式展開
- [ ] 每張子訂單卡片包含：
  - 子訂單編號
  - 商品列表（名稱、數量、價格）
  - 狀態標籤（付款、出貨、處理）
  - 金額小計
  - 賣家名稱
- [ ] 狀態標籤顏色正確（已付款=綠色、已出貨=藍色）
- [ ] 手機版和桌面版都能正常顯示（測試 RWD）

**實際結果:**
```
是否顯示按鈕：⬜ 是 / ❌ 否
子訂單數量：
UI 顯示正常：⬜ 是 / ❌ 否
RWD 測試：⬜ Pass / ❌ Fail
（貼上截圖）
```

**測試狀態:** ⬜ Pass / ❌ Fail

---

## 額外測試（選擇性）

### Test 7: 父訂單完成通知

**目標:** 驗證所有子訂單出貨後，顧客收到父訂單完成通知

**測試步驟:**
1. 如果訂單包含多個子訂單，逐一標記為已出貨
2. 檢查最後一個子訂單出貨後是否觸發父訂單完成 Hook
3. 確認顧客是否收到額外的「訂單完成」LINE 通知

**預期結果:**
- [ ] 所有子訂單出貨後，`buygo/parent_order_completed` Hook 被觸發
- [ ] 顧客收到父訂單完成通知（與單一子訂單通知區分）

---

### Test 8: 權限測試

**目標:** 驗證顧客無法查看其他人的子訂單

**測試步驟:**
1. 使用顧客 A 帳號建立訂單
2. 登出，使用顧客 B 帳號登入
3. 嘗試訪問顧客 A 的子訂單 API：
   ```
   GET /wp-json/buygo-plus-one/v1/child-orders/{order_id}
   ```
4. 檢查是否回傳 403 Forbidden

**預期結果:**
- [ ] API 回傳 403 錯誤
- [ ] 錯誤訊息：「您無權查看此訂單」
- [ ] 前端顯示友善的錯誤提示

---

### Test 9: 錯誤處理測試

**目標:** 驗證系統錯誤處理機制

**測試案例:**
- [ ] 查看不存在的訂單（應回傳 404）
- [ ] 查看沒有子訂單的訂單（應顯示「此訂單無子訂單」）
- [ ] API 請求失敗時顯示錯誤訊息
- [ ] LINE 通知發送失敗時記錄錯誤日誌

---

## 測試結果總結

| Test | 測試項目 | 狀態 | 備註 |
|------|---------|------|------|
| 1 | 商品上架 | ⬜ Pass / ❌ Fail | |
| 2 | 顧客下單 | ⬜ Pass / ❌ Fail | |
| 3 | 訂單拆單 | ⬜ Pass / ❌ Fail | |
| 4 | 標記已出貨 | ⬜ Pass / ❌ Fail | |
| 5 | LINE 出貨通知 | ⬜ Pass / ❌ Fail | |
| 6 | 查看子訂單 | ⬜ Pass / ❌ Fail | |
| 7 | 父訂單完成通知 | ⬜ Pass / ❌ Fail | （選擇性）|
| 8 | 權限測試 | ⬜ Pass / ❌ Fail | （選擇性）|
| 9 | 錯誤處理 | ⬜ Pass / ❌ Fail | （選擇性）|

**整體測試狀態:** ⬜ 全部通過 / ⚠️ 部分通過 / ❌ 失敗

---

## 問題記錄

### 發現的問題

| 編號 | 測試案例 | 問題描述 | 嚴重程度 | 狀態 |
|------|---------|---------|---------|------|
| 1 | | | ⬜ Blocker / ⬜ Major / ⬜ Minor | ⬜ Open / ⬜ Fixed |

---

## 測試完成確認

- [ ] 所有核心測試案例（Test 1-6）已執行
- [ ] 測試結果已記錄
- [ ] 發現的問題已記錄到問題追蹤表
- [ ] 測試截圖已保存（如需要）
- [ ] 測試報告已提交

**測試執行人員:**
**測試日期:**
**測試環境:** https://test.buygo.me
**外掛版本:** buygo-plus-one-dev (feature/v1.3-shipment-notification)

---

*測試計劃建立時間：2026-02-04*
*最後更新：2026-02-04*
