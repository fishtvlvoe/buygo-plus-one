---
phase: 37-前端ui元件與互動
plan: 01
type: execute
wave: 1
depends_on: ["36-02"]
files_modified:
  - assets/js/fluentcart-child-orders.js
  - includes/integrations/class-fluentcart-child-orders-integration.php
autonomous: true

must_haves:
  truths:
    - "按鈕點擊後發送 AJAX 請求到 API，顯示 Loading 動畫"
    - "子訂單列表以卡片形式顯示，包含：子訂單編號、商品列表、狀態標籤、金額小計、賣家名稱"
    - "狀態標籤使用顏色區分（已付款=綠色、待付款=黃色、已出貨=藍色、處理中=灰色）"
    - "手機（< 768px）和桌面（>= 768px）都能正確顯示"
    - "錯誤情況顯示友善提示（API 錯誤、無子訂單）"
  artifacts:
    - path: "assets/js/fluentcart-child-orders.js"
      provides: "完整的 API 呼叫和 UI 渲染邏輯"
      min_lines: 150
    - path: "includes/integrations/class-fluentcart-child-orders-integration.php"
      provides: "完整的 CSS 樣式（卡片、標籤、Loading、RWD）"
      contains: ".buygo-child-order-card"
  key_links:
    - from: "assets/js/fluentcart-child-orders.js"
      to: "/wp-json/buygo-plus-one/v1/child-orders/{id}"
      via: "fetch API 呼叫"
      pattern: "fetch.*child-orders"
    - from: "assets/js/fluentcart-child-orders.js"
      to: "window.buygoChildOrders"
      via: "wp_localize_script 傳遞的配置"
      pattern: "buygoChildOrders\\.(apiBase|nonce)"
---

<objective>
實作前端 UI 元件的 JavaScript 邏輯和 CSS 樣式，整合 Phase 36 的 API 資料，提供流暢的子訂單顯示體驗

Purpose: 完成 v1.4 milestone 的前端部分，讓購物者能在 FluentCart 會員前台查看子訂單詳細資訊
Output: 完整可用的子訂單顯示功能（含 Loading、Success、Empty、Error 四種狀態）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-fluentcart-hook-探索與注入點設定/35-01-SUMMARY.md
@.planning/phases/36-子訂單查詢與api服務/36-02-SUMMARY.md
@.planning/phases/37-前端ui元件與互動/37-RESEARCH.md
@assets/js/fluentcart-child-orders.js
@includes/integrations/class-fluentcart-child-orders-integration.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 實作完整的 JavaScript API 呼叫和 UI 渲染邏輯</name>
  <files>assets/js/fluentcart-child-orders.js</files>
  <action>
完全重寫 `fluentcart-child-orders.js`，實作以下功能：

1. **狀態映射常數 (STATUS_MAP)**
   - payment: pending→待付款/黃色, paid→已付款/綠色, failed→付款失敗/紅色, refunded→已退款/灰色
   - shipping: unshipped→待出貨/黃色, preparing→備貨中/藍色, shipped→已出貨/綠色, completed→已完成/綠色
   - fulfillment: pending→待處理/灰色, processing→處理中/藍色, completed→已完成/綠色, cancelled→已取消/紅色

2. **工具函式**
   - `formatCurrency(amount, currency)`: 使用 `Intl.NumberFormat('zh-TW', { style: 'currency', currency })` 格式化金額
   - `getStatusBadge(type, status)`: 回傳 `<span class="buygo-badge buygo-badge-{class}">{label}</span>` HTML

3. **渲染函式（四種狀態）**
   - `renderLoading()`: Loading 狀態 UI（Spinner + 載入中文字）
   - `renderEmpty()`: 空狀態 UI（SVG 圖示 + 此訂單沒有子訂單）
   - `renderError()`: 錯誤狀態 UI（SVG 圖示 + 載入失敗 + 重試按鈕）
   - `renderChildOrderCard(order)`: 單張子訂單卡片（賣家、狀態標籤、商品列表、金額小計）
   - `renderChildOrders(orders)`: 子訂單列表容器

4. **API 呼叫邏輯 `loadChildOrders(orderId, container)`**
   - 顯示 Loading 狀態
   - 使用 `fetch()` 呼叫 `window.buygoChildOrders.apiBase + '/child-orders/' + orderId`
   - Headers: `X-WP-Nonce: window.buygoChildOrders.nonce`
   - **重要**: 檢查 `response.ok`（Fetch 不會在 4xx/5xx 時 reject）
   - 成功時：檢查 `data.data.child_orders` 是否有資料，有則渲染卡片列表，無則顯示空狀態
   - 失敗時：顯示錯誤狀態，綁定重試按鈕事件

5. **事件處理**
   - DOMContentLoaded 時初始化
   - 按鈕點擊切換展開/折疊
   - **只在第一次展開時載入資料**（使用 `container.dataset.loaded` 標記）
   - 重試按鈕重新呼叫 `loadChildOrders()`

6. **程式碼結構**
   - 使用 IIFE 包裝避免全域污染
   - 'use strict' 啟用嚴格模式
   - 所有函式都在 IIFE 內部定義

**API 回應格式參考**（來自 36-02-SUMMARY）：
```json
{
  "success": true,
  "data": {
    "child_orders": [
      {
        "id": 123,
        "invoice_no": "CO-123",
        "payment_status": "paid",
        "shipping_status": "shipped",
        "fulfillment_status": "completed",
        "total_amount": 350,
        "seller_name": "賣家A",
        "items": [
          { "title": "商品名稱", "quantity": 2, "unit_price": 100, "line_total": 200 }
        ]
      }
    ],
    "count": 1,
    "currency": "TWD"
  }
}
```
  </action>
  <verify>
```bash
# 語法檢查
node --check assets/js/fluentcart-child-orders.js

# 檢查關鍵函式存在
grep -c "function loadChildOrders" assets/js/fluentcart-child-orders.js
grep -c "function renderChildOrderCard" assets/js/fluentcart-child-orders.js
grep -c "function formatCurrency" assets/js/fluentcart-child-orders.js
grep -c "function getStatusBadge" assets/js/fluentcart-child-orders.js
grep -c "response.ok" assets/js/fluentcart-child-orders.js
grep -c "Intl.NumberFormat" assets/js/fluentcart-child-orders.js
```
  </verify>
  <done>
JavaScript 檔案包含完整的 API 呼叫邏輯、四種 UI 狀態渲染函式、狀態標籤映射、金額格式化，並正確處理 HTTP 錯誤。
  </done>
</task>

<task type="auto">
  <name>Task 2: 擴充 CSS 樣式支援完整 UI 元件</name>
  <files>includes/integrations/class-fluentcart-child-orders-integration.php</files>
  <action>
修改 `get_inline_css()` 方法，加入完整的 CSS 樣式支援以下 UI 元件：

1. **子訂單列表容器 (.buygo-child-orders-list)**
   - Mobile First: 預設 `flex-direction: column; gap: 16px;`
   - 桌面版（>= 768px）: `display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;`

2. **子訂單卡片 (.buygo-child-order-card)**
   - 白色背景、邊框、圓角 12px、陰影
   - Header: 賣家資訊（左）+ 狀態標籤（右）, 使用 flexbox
   - Items: 商品列表，每項用 flexbox（名稱、數量、價格）
   - Footer: 小計標籤（左）+ 金額（右），金額使用 `--buygo-primary` 顏色

3. **狀態標籤 (.buygo-badge, .buygo-badge-*)**
   - 共用樣式: `display: inline-flex; padding: 2px 10px; font-size: 12px; border-radius: 9999px;`
   - `.buygo-badge-success`: 綠色背景 #d1fae5, 文字 #065f46
   - `.buygo-badge-warning`: 黃色背景 #fef3c7, 文字 #92400e
   - `.buygo-badge-danger`: 紅色背景 #fee2e2, 文字 #991b1b
   - `.buygo-badge-info`: 藍色背景 #dbeafe, 文字 #1e40af
   - `.buygo-badge-neutral`: 灰色背景 #f3f4f6, 文字 #374151

4. **Loading 狀態 (.buygo-loading, .buygo-loading-spinner)**
   - 置中顯示、padding 48px
   - Spinner: 32x32px 圓形、邊框動畫旋轉

5. **空狀態/錯誤狀態 (.buygo-empty-state)**
   - 置中顯示、padding 48px
   - SVG 圖示 48x48px
   - 按鈕樣式（重試按鈕使用 .buygo-btn-secondary）

6. **RWD 響應式設計**
   - 手機版（< 768px）: 按鈕全寬、卡片 padding 減少、header 垂直排列
   - 桌面版（>= 768px）: 雙欄 grid 佈局

7. **觸控目標**
   - 按鈕 min-height: 44px（Apple HIG 標準）

**保留現有樣式**，只新增上述元件樣式。使用 CSS 變數 `var(--buygo-*, fallback)` 格式確保兼容性。
  </action>
  <verify>
```bash
# 語法檢查
php -l includes/integrations/class-fluentcart-child-orders-integration.php

# 檢查新增的 CSS 類別
grep -c ".buygo-child-order-card" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c ".buygo-badge-success" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c ".buygo-badge-warning" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c ".buygo-loading-spinner" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c ".buygo-empty-state" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c "@media (min-width: 768px)" includes/integrations/class-fluentcart-child-orders-integration.php
grep -c "min-height: 44px" includes/integrations/class-fluentcart-child-orders-integration.php
```
  </verify>
  <done>
CSS 樣式包含完整的子訂單卡片、狀態標籤（5 種顏色）、Loading 動畫、空狀態/錯誤狀態，以及 Mobile First RWD 設計。
  </done>
</task>

<task type="auto">
  <name>Task 3: 修正按鈕的 data-order-id 傳遞機制</name>
  <files>includes/integrations/class-fluentcart-child-orders-integration.php</files>
  <action>
修改 `render_child_orders_section()` 方法，解決訂單 ID 傳遞問題：

**問題分析**（來自 37-RESEARCH.md Open Questions #1）：
- 按鈕需要 `data-order-id` 屬性傳遞訂單 ID 給 JavaScript
- 目前按鈕沒有 `data-order-id` 屬性
- `fluent_cart/customer_app` hook 可能不會傳遞訂單 ID

**解決方案**：從 URL 解析訂單 ID

FluentCart 客戶檔案頁面的訂單詳情 URL 格式通常為：
- `/my-account/purchase-history/order/{order_id}`
- 或 `/customer-profile/orders/{order_id}`

實作步驟：
1. 在 `render_child_orders_section()` 中解析 `$_SERVER['REQUEST_URI']`
2. 使用正則表達式提取訂單 ID（數字部分）
3. 如果找到訂單 ID，在按鈕加入 `data-order-id="{id}"` 屬性
4. 如果找不到（例如在訂單列表頁），不顯示按鈕和容器

**注意**：只在有訂單 ID 的頁面顯示 widget，避免在訂單列表頁顯示無用的按鈕

```php
// 解析 URL 取得訂單 ID
$current_url = $_SERVER['REQUEST_URI'] ?? '';
preg_match('/\/order\/(\d+)/', $current_url, $matches);
$order_id = $matches[1] ?? null;

// 如果沒有訂單 ID，不顯示
if (!$order_id) {
    return;
}

// 在按鈕加入 data-order-id
<button id="buygo-view-child-orders-btn" ... data-order-id="<?php echo esc_attr($order_id); ?>">
```
  </action>
  <verify>
```bash
# 語法檢查
php -l includes/integrations/class-fluentcart-child-orders-integration.php

# 檢查 data-order-id 屬性
grep -c "data-order-id" includes/integrations/class-fluentcart-child-orders-integration.php

# 檢查 URL 解析
grep -c "preg_match" includes/integrations/class-fluentcart-child-orders-integration.php

# 檢查訂單 ID 檢查邏輯
grep -c "\$order_id" includes/integrations/class-fluentcart-child-orders-integration.php
```
  </verify>
  <done>
按鈕包含 `data-order-id` 屬性，從 URL 解析訂單 ID，只在訂單詳情頁面顯示 widget。
  </done>
</task>

</tasks>

<verification>
## 整體驗證

1. **語法驗證**
```bash
# JavaScript 語法
node --check assets/js/fluentcart-child-orders.js

# PHP 語法
php -l includes/integrations/class-fluentcart-child-orders-integration.php
```

2. **功能驗證**
```bash
# 檢查 JavaScript 關鍵函式
grep -E "loadChildOrders|renderChildOrderCard|formatCurrency|getStatusBadge" assets/js/fluentcart-child-orders.js | wc -l
# 預期結果: >= 8（定義和呼叫）

# 檢查 CSS 關鍵類別
grep -E "buygo-child-order-card|buygo-badge-(success|warning|danger|info|neutral)|buygo-loading-spinner|buygo-empty-state" includes/integrations/class-fluentcart-child-orders-integration.php | wc -l
# 預期結果: >= 7

# 檢查 data-order-id
grep "data-order-id" includes/integrations/class-fluentcart-child-orders-integration.php
```

3. **UI 測試**（需手動或透過瀏覽器）
- 訪問 https://test.buygo.me/my-account/purchase-history
- 找到一筆訂單，進入訂單詳情頁
- 確認「查看子訂單」按鈕顯示
- 點擊按鈕，確認 Loading 動畫顯示
- 確認子訂單卡片正確渲染（或空狀態/錯誤狀態）
- 縮小瀏覽器視窗測試 RWD
</verification>

<success_criteria>
1. JavaScript 檔案包含完整的 API 呼叫、四種狀態渲染、狀態標籤映射
2. CSS 樣式包含卡片、標籤、Loading、空狀態、RWD 設計
3. 按鈕有 `data-order-id` 屬性，從 URL 解析訂單 ID
4. 只在訂單詳情頁面顯示 widget
5. 語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/37-前端ui元件與互動/37-01-SUMMARY.md`
</output>
