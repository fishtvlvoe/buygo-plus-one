---
phase: 33-notification-trigger-and-template-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-notification-templates.php
autonomous: true

must_haves:
  truths:
    - "NotificationTemplates::definitions() 包含 shipment_shipped 模板"
    - "模板包含變數 {product_list}, {shipping_method}, {estimated_delivery}"
    - "變數替換使用 esc_html() 防止 XSS"
    - "estimated_delivery 為空時顯示預設文字"
  artifacts:
    - path: "includes/services/class-notification-templates.php"
      provides: "通知模板管理，新增出貨通知模板"
      contains: "shipment_shipped"
  key_links:
    - from: "includes/services/class-notification-templates.php"
      to: "NotificationHandler"
      via: "NotificationTemplates::get('shipment_shipped', $args)"
      pattern: "shipment_shipped"
---

<objective>
擴充 NotificationTemplates 類別，新增出貨通知模板和變數替換邏輯。

Purpose: 提供預設的出貨通知模板，支援商品清單、物流方式、預計送達時間等變數的動態替換。模板內容需清晰易懂，符合台灣用戶習慣。

Output:
- shipment_shipped 模板定義
- 變數替換邏輯擴充（處理多商品、空值情況）
- XSS 防護（esc_html）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@includes/services/class-notification-templates.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 新增 shipment_shipped 模板到 definitions()</name>
  <files>includes/services/class-notification-templates.php</files>
  <action>
在 NotificationTemplates::definitions() 方法中新增 shipment_shipped 模板。

模板位置：在 order_shipped 模板之後新增（同屬出貨相關通知）。

模板內容（TMPL-03 需求）：
```php
'shipment_shipped' => [
    'line' => [
        'message' => "您的訂單已出貨囉！\n\n商品清單：\n{product_list}\n\n物流方式：{shipping_method}\n預計送達：{estimated_delivery}\n\n感謝您的購買！如有問題請聯繫客服。"
    ]
]
```

模板設計考量：
- 開頭使用親切的語氣（「您的訂單已出貨囉！」）
- 商品清單使用換行分隔，易於閱讀
- 預計送達為選填，若為空則顯示「配送中」
- 結尾提供客服聯繫提示
  </action>
  <verify>
1. grep 檢查模板存在：`grep -n "shipment_shipped" includes/services/class-notification-templates.php`
2. grep 檢查變數：`grep -A5 "shipment_shipped" includes/services/class-notification-templates.php | grep -E "{product_list}|{shipping_method}|{estimated_delivery}"`
3. PHP 語法檢查：`php -l includes/services/class-notification-templates.php`
  </verify>
  <done>
shipment_shipped 模板已新增到 definitions()，包含 {product_list}、{shipping_method}、{estimated_delivery} 變數
  </done>
</task>

<task type="auto">
  <name>Task 2: 新增出貨通知專用的變數格式化方法</name>
  <files>includes/services/class-notification-templates.php</files>
  <action>
新增靜態方法處理出貨通知的變數格式化，確保 XSS 防護和空值處理。

新增方法：
```php
/**
 * 格式化商品清單為通知訊息格式
 *
 * @param array $items 商品項目陣列，每個元素包含 product_name 和 quantity
 * @return string 格式化後的商品清單字串
 */
public static function format_product_list(array $items): string {
    if (empty($items)) {
        return '（無商品資訊）';
    }

    $lines = [];
    foreach ($items as $item) {
        $name = esc_html($item['product_name'] ?? '未知商品');
        $qty = intval($item['quantity'] ?? 1);
        $lines[] = "- {$name} x {$qty}";
    }

    return implode("\n", $lines);
}

/**
 * 格式化預計送達時間
 *
 * @param string|null $estimated_delivery_at MySQL datetime 格式或 null
 * @return string 格式化後的送達時間（或預設文字）
 */
public static function format_estimated_delivery(?string $estimated_delivery_at): string {
    if (empty($estimated_delivery_at)) {
        return '配送中';
    }

    // 將 MySQL datetime 轉換為台灣常用格式
    $timestamp = strtotime($estimated_delivery_at);
    if ($timestamp === false) {
        return '配送中';
    }

    return date('Y/m/d', $timestamp);
}

/**
 * 格式化物流方式
 *
 * @param string|null $shipping_method 物流方式代碼或名稱
 * @return string 格式化後的物流方式
 */
public static function format_shipping_method(?string $shipping_method): string {
    if (empty($shipping_method)) {
        return '標準配送';
    }

    // 常見物流方式對照表
    $methods = [
        'standard' => '標準配送',
        'express' => '快速配送',
        'pickup' => '自取',
        'convenience_store' => '超商取貨',
        '7-11' => '7-ELEVEN 取貨',
        'family' => '全家取貨',
        'hilife' => '萊爾富取貨',
        'ok' => 'OK 超商取貨',
    ];

    $method_lower = strtolower($shipping_method);
    return esc_html($methods[$method_lower] ?? $shipping_method);
}
```

這些方法確保：
- 所有輸出都經過 esc_html() 處理（防止 XSS）
- 空值和無效值有合理的預設文字
- 日期格式符合台灣習慣（YYYY/MM/DD）
- 物流方式支援中文轉換
  </action>
  <verify>
1. grep 檢查方法存在：
   ```bash
   grep -n "function format_product_list" includes/services/class-notification-templates.php
   grep -n "function format_estimated_delivery" includes/services/class-notification-templates.php
   grep -n "function format_shipping_method" includes/services/class-notification-templates.php
   ```
2. grep 檢查 esc_html 使用：`grep -n "esc_html" includes/services/class-notification-templates.php`
3. PHP 語法檢查：`php -l includes/services/class-notification-templates.php`
  </verify>
  <done>
format_product_list()、format_estimated_delivery()、format_shipping_method() 方法已新增，包含 XSS 防護和空值處理
  </done>
</task>

</tasks>

<verification>
執行以下驗證確認計畫完成：

1. **模板定義驗證**
   ```bash
   # 檢查 shipment_shipped 模板存在
   grep -A10 "'shipment_shipped'" includes/services/class-notification-templates.php
   ```

2. **變數格式化方法驗證**
   ```bash
   # 檢查三個格式化方法存在
   grep -E "function format_(product_list|estimated_delivery|shipping_method)" includes/services/class-notification-templates.php
   ```

3. **XSS 防護驗證**
   ```bash
   # 確認使用 esc_html
   grep -c "esc_html" includes/services/class-notification-templates.php
   ```

4. **PHP 語法驗證**
   ```bash
   php -l includes/services/class-notification-templates.php
   ```
</verification>

<success_criteria>
1. shipment_shipped 模板存在於 definitions() 中
2. 模板包含 {product_list}, {shipping_method}, {estimated_delivery} 變數
3. format_product_list(), format_estimated_delivery(), format_shipping_method() 方法存在
4. 所有輸出使用 esc_html() 防止 XSS
5. 空值和無效值有合理的預設文字處理
6. PHP 語法檢查通過
</success_criteria>

<output>
完成後建立 `.planning/phases/33-notification-trigger-and-template-engine/33-02-SUMMARY.md`
</output>
