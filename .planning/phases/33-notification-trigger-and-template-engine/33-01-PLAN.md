---
phase: 33-notification-trigger-and-template-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-notification-handler.php
  - includes/services/class-shipment-service.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "ShipmentService::mark_shipped() 觸發 buygo/shipment/marked_as_shipped Action Hook"
    - "NotificationHandler 類別正確註冊到 Plugin::register_hooks()"
    - "NotificationHandler 監聽出貨事件並收集出貨單完整資訊"
  artifacts:
    - path: "includes/services/class-notification-handler.php"
      provides: "事件監聽器，處理出貨通知觸發邏輯"
      exports: ["NotificationHandler"]
    - path: "includes/services/class-shipment-service.php"
      provides: "出貨單服務，新增 do_action Hook"
      contains: "do_action('buygo/shipment/marked_as_shipped'"
    - path: "includes/class-plugin.php"
      provides: "外掛主類別，註冊 NotificationHandler"
      contains: "NotificationHandler"
  key_links:
    - from: "includes/services/class-shipment-service.php"
      to: "NotificationHandler"
      via: "WordPress Action Hook do_action()"
      pattern: "do_action\\('buygo/shipment/marked_as_shipped'"
    - from: "includes/class-plugin.php"
      to: "includes/services/class-notification-handler.php"
      via: "register_hooks() 中初始化"
      pattern: "NotificationHandler"
---

<objective>
建立出貨通知觸發基礎架構，包含 NotificationHandler 類別和 ShipmentService 的 Action Hook 整合。

Purpose: 實現事件驅動架構，當賣家標記出貨單為「已出貨」時，自動觸發通知流程。這是 Phase 33 的核心基礎，後續的模板引擎和通知發送都依賴此架構。

Output:
- NotificationHandler 類別（事件監聽器）
- ShipmentService 新增 do_action() Hook
- Plugin 類別註冊 NotificationHandler
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@includes/services/class-shipment-service.php
@includes/services/class-notification-service.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 NotificationHandler 類別</name>
  <files>includes/services/class-notification-handler.php</files>
  <action>
建立 NotificationHandler 類別，負責監聽出貨事件並收集出貨單資訊。

類別結構：
1. 命名空間：`namespace BuyGoPlus\Services;`
2. 單例模式：`get_instance()` 靜態方法
3. 主要方法：
   - `register_hooks()`: 註冊 WordPress Action Hook
   - `handle_shipment_marked_shipped($shipment_id)`: 處理出貨事件
   - `collect_shipment_data($shipment_id)`: 收集出貨單完整資訊

收集的出貨單資訊包含：
- shipment_id, shipment_number
- customer_id, seller_id
- 商品清單（從 buygo_shipment_items JOIN 產品資料）
- 物流方式（從訂單或出貨單設定）
- 預計送達時間（estimated_delivery_at，Phase 32 新增的欄位）

使用 try-catch 包裹所有邏輯，確保通知失敗不影響出貨流程。
使用 DebugService 記錄事件觸發和處理過程。

參考現有的 NotificationService 和 ShipmentService 實作風格。
  </action>
  <verify>
1. 檔案存在：`ls includes/services/class-notification-handler.php`
2. 類別語法正確：`php -l includes/services/class-notification-handler.php`
3. 包含必要方法：grep 檢查 register_hooks, handle_shipment_marked_shipped, collect_shipment_data
  </verify>
  <done>
NotificationHandler 類別建立完成，包含 register_hooks()、handle_shipment_marked_shipped() 和 collect_shipment_data() 方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 修改 ShipmentService 觸發 Action Hook</name>
  <files>includes/services/class-shipment-service.php</files>
  <action>
修改 ShipmentService::mark_shipped() 方法，在成功標記出貨後觸發 WordPress Action Hook。

修改位置：在 `$shipped_count++` 之後，`check_parent_completion()` 之前新增：

```php
// 觸發出貨通知事件（Phase 33: 出貨通知）
do_action('buygo/shipment/marked_as_shipped', $shipment_id);
```

這樣可以讓 NotificationHandler 監聽此事件並處理通知邏輯，實現鬆耦合設計。

注意事項：
- Hook 名稱使用 buygo/ 前綴（專案命名空間）
- 只傳遞 shipment_id，NotificationHandler 自行查詢完整資料
- 不要在此方法中直接呼叫 NotificationService（保持解耦）
  </action>
  <verify>
1. grep 檢查 Hook 是否存在：`grep -n "do_action.*buygo/shipment/marked_as_shipped" includes/services/class-shipment-service.php`
2. PHP 語法檢查：`php -l includes/services/class-shipment-service.php`
  </verify>
  <done>
ShipmentService::mark_shipped() 方法新增 do_action('buygo/shipment/marked_as_shipped', $shipment_id) 觸發點
  </done>
</task>

<task type="auto">
  <name>Task 3: 在 Plugin 類別註冊 NotificationHandler</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 Plugin 類別，載入並註冊 NotificationHandler。

1. 在 load_dependencies() 方法中新增檔案載入：
```php
require_once BUYGO_PLUS_ONE_PATH . 'includes/services/class-notification-handler.php';
```

2. 在 register_hooks() 方法中初始化並註冊：
```php
// Phase 33: 出貨通知處理器
$notification_handler = \BuyGoPlus\Services\NotificationHandler::get_instance();
$notification_handler->register_hooks();
```

確保載入順序正確：NotificationHandler 在 ShipmentService 之後載入。
  </action>
  <verify>
1. grep 檢查載入：`grep -n "class-notification-handler.php" includes/class-plugin.php`
2. grep 檢查註冊：`grep -n "NotificationHandler" includes/class-plugin.php`
3. PHP 語法檢查：`php -l includes/class-plugin.php`
  </verify>
  <done>
Plugin 類別正確載入 class-notification-handler.php 並在 register_hooks() 中初始化 NotificationHandler
  </done>
</task>

</tasks>

<verification>
執行以下驗證確認計畫完成：

1. **檔案結構驗證**
   ```bash
   ls -la includes/services/class-notification-handler.php
   ```

2. **PHP 語法驗證**
   ```bash
   php -l includes/services/class-notification-handler.php
   php -l includes/services/class-shipment-service.php
   php -l includes/class-plugin.php
   ```

3. **Hook 連結驗證**
   ```bash
   # ShipmentService 觸發 Hook
   grep -n "do_action.*buygo/shipment/marked_as_shipped" includes/services/class-shipment-service.php

   # NotificationHandler 監聽 Hook
   grep -n "add_action.*buygo/shipment/marked_as_shipped" includes/services/class-notification-handler.php

   # Plugin 載入 NotificationHandler
   grep -n "NotificationHandler" includes/class-plugin.php
   ```

4. **必要方法存在**
   ```bash
   grep -n "function register_hooks" includes/services/class-notification-handler.php
   grep -n "function handle_shipment_marked_shipped" includes/services/class-notification-handler.php
   grep -n "function collect_shipment_data" includes/services/class-notification-handler.php
   ```
</verification>

<success_criteria>
1. NotificationHandler 類別存在且語法正確
2. ShipmentService::mark_shipped() 包含 do_action('buygo/shipment/marked_as_shipped', $shipment_id)
3. Plugin 類別載入並註冊 NotificationHandler
4. 所有 PHP 檔案通過語法檢查
5. Hook 連結正確建立（觸發端 → 監聽端）
</success_criteria>

<output>
完成後建立 `.planning/phases/33-notification-trigger-and-template-engine/33-01-SUMMARY.md`
</output>
