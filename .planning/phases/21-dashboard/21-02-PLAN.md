---
phase: 21-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - buygo-plus-one-dev/includes/api/class-dashboard-api.php
  - buygo-plus-one-dev/includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "前端可以調用 GET /buygo-plus-one/v1/dashboard/stats 取得統計"
    - "前端可以調用 GET /buygo-plus-one/v1/dashboard/revenue?period=30 取得營收趨勢"
    - "前端可以調用 GET /buygo-plus-one/v1/dashboard/products 取得商品概覽"
    - "前端可以調用 GET /buygo-plus-one/v1/dashboard/activities 取得最近活動"
    - "API 有權限檢查（nonce 或 API key）"
    - "API 有快取機制（5-15 分鐘）"
  artifacts:
    - path: "buygo-plus-one-dev/includes/api/class-dashboard-api.php"
      provides: "Dashboard REST API endpoints"
      exports: ["Dashboard_API"]
      min_lines: 150
      contains: ["register_routes", "get_stats", "get_revenue", "get_products", "get_activities"]
  key_links:
    - from: "Dashboard_API"
      to: "DashboardService"
      via: "建構函數注入並調用方法"
      pattern: "new DashboardService"
    - from: "Dashboard_API"
      to: "API::check_permission"
      via: "權限檢查"
      pattern: "permission_callback.*check_permission"
    - from: "Dashboard_API"
      to: "WordPress Transients API"
      via: "快取機制"
      pattern: "get_transient.*set_transient"
---

<objective>
建立 Dashboard_API - Dashboard REST API 端點層

Purpose: 提供 4 個 REST API endpoints 供前端調用，整合 DashboardService 查詢邏輯並實作快取
Output: Dashboard_API 類別，註冊 4 個端點並在 Plugin 中初始化
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/phases/21-dashboard/TECH-SOLUTION.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/codebase/ARCHITECTURE.md

# 參考現有 API 實作模式
@/Users/fishtv/Development/buygo-plus-one-dev/includes/api/class-customers-api.php
@/Users/fishtv/Development/buygo-plus-one-dev/includes/api/class-products-api.php
@/Users/fishtv/Development/buygo-plus-one-dev/includes/api/class-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 Dashboard_API 類別架構</name>
  <files>buygo-plus-one-dev/includes/api/class-dashboard-api.php</files>
  <action>
建立 `Dashboard_API` 類別，註冊 REST API endpoints：

1. 建立 `buygo-plus-one-dev/includes/api/class-dashboard-api.php`
2. 使用 namespace `BuyGoPlus\Api`
3. 定義屬性：
   - `$namespace = 'buygo-plus-one/v1'`（REST API 命名空間）
   - `$dashboardService`（DashboardService 實例）
4. 建構函數注入 `DashboardService`：
   ```php
   public function __construct() {
       $this->dashboardService = new \BuyGoPlus\Services\DashboardService();
   }
   ```
5. 實作 `register_routes()` 方法，註冊 4 個端點（詳見 Task 2）

參考現有 API 類別的架構（`Customers_API`, `Products_API`）。

**重要技術約束:**
- 使用 `API::check_permission` 進行權限檢查（nonce 或 API key）
- 使用 `WP_REST_Response` 回傳 JSON
- 錯誤回傳 500 狀態碼和錯誤訊息
  </action>
  <verify>
檢查檔案語法正確：
```bash
php -l /Users/fishtv/Development/buygo-plus-one-dev/includes/api/class-dashboard-api.php
```
  </verify>
  <done>
Dashboard_API 類別存在，包含建構函數和 register_routes 方法，語法無錯誤
  </done>
</task>

<task type="auto">
  <name>Task 2: 註冊 4 個 REST API 端點</name>
  <files>buygo-plus-one-dev/includes/api/class-dashboard-api.php</files>
  <action>
在 `register_routes()` 方法中註冊 4 個端點：

**1. GET /dashboard/stats - 總覽統計**
```php
register_rest_route($this->namespace, '/dashboard/stats', [
    'methods' => 'GET',
    'callback' => [$this, 'get_stats'],
    'permission_callback' => [API::class, 'check_permission']
]);
```

**2. GET /dashboard/revenue - 營收趨勢**
```php
register_rest_route($this->namespace, '/dashboard/revenue', [
    'methods' => 'GET',
    'callback' => [$this, 'get_revenue'],
    'permission_callback' => [API::class, 'check_permission'],
    'args' => [
        'period' => [
            'default' => 30,
            'sanitize_callback' => 'absint'
        ],
        'currency' => [
            'default' => 'TWD',
            'sanitize_callback' => 'sanitize_text_field'
        ]
    ]
]);
```

**3. GET /dashboard/products - 商品概覽**
```php
register_rest_route($this->namespace, '/dashboard/products', [
    'methods' => 'GET',
    'callback' => [$this, 'get_products'],
    'permission_callback' => [API::class, 'check_permission']
]);
```

**4. GET /dashboard/activities - 最近活動**
```php
register_rest_route($this->namespace, '/dashboard/activities', [
    'methods' => 'GET',
    'callback' => [$this, 'get_activities'],
    'permission_callback' => [API::class, 'check_permission'],
    'args' => [
        'limit' => [
            'default' => 10,
            'sanitize_callback' => 'absint'
        ]
    ]
]);
```

參考 `TECH-SOLUTION.md` 第 3 節的 API 設計規格。
  </action>
  <verify>
檢查 register_routes 方法包含 4 個 register_rest_route 調用
  </verify>
  <done>
register_routes 方法包含 4 個端點註冊，參數驗證和權限檢查完整
  </done>
</task>

<task type="auto">
  <name>Task 3: 實作 get_stats 方法（含快取）</name>
  <files>buygo-plus-one-dev/includes/api/class-dashboard-api.php</files>
  <action>
實作 `get_stats(\WP_REST_Request $request): \WP_REST_Response` 方法：

**快取邏輯:**
1. 定義快取鍵: `buygo_dashboard_stats`
2. 嘗試從 transient 讀取快取資料
3. 若快取存在，回傳快取資料（含 `cached_at` 時間戳）
4. 若快取不存在：
   - 調用 `$this->dashboardService->calculateStats()`
   - 使用 `set_transient()` 快取 5 分鐘（`5 * MINUTE_IN_SECONDS`）
   - 同時快取時間戳（`{cache_key}_time`）
   - 回傳計算結果

**回傳格式:**
```php
new \WP_REST_Response([
    'success' => true,
    'data' => $stats,
    'cached_at' => '2026-01-29 10:30:00'
], 200);
```

**錯誤處理:**
- 使用 try-catch 捕獲異常
- 回傳 500 狀態碼和錯誤訊息

參考 `TECH-SOLUTION.md` 第 8.2 節的程式碼範例。
  </action>
  <verify>
使用 cURL 測試 API：
```bash
curl -X GET "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/stats" \
  -H "X-WP-Nonce: YOUR_NONCE"
```
檢查回傳 JSON 包含 success, data, cached_at
  </verify>
  <done>
get_stats 方法存在，實作快取機制，可正確回傳統計資料
  </done>
</task>

<task type="auto">
  <name>Task 4: 實作 get_revenue, get_products, get_activities 方法</name>
  <files>buygo-plus-one-dev/includes/api/class-dashboard-api.php</files>
  <action>
實作其他 3 個方法，均包含快取機制：

**1. `get_revenue(\WP_REST_Request $request): \WP_REST_Response`**

- 取得參數: `$period = $request->get_param('period')`, `$currency = $request->get_param('currency')`
- 快取鍵: `buygo_dashboard_revenue_{$period}_{$currency}`
- 快取時間: 15 分鐘
- 調用: `$this->dashboardService->getRevenueTrend($period, $currency)`

**2. `get_products(\WP_REST_Request $request): \WP_REST_Response`**

- 快取鍵: `buygo_dashboard_products`
- 快取時間: 15 分鐘
- 調用: `$this->dashboardService->getProductOverview()`

**3. `get_activities(\WP_REST_Request $request): \WP_REST_Response`**

- 取得參數: `$limit = $request->get_param('limit')`
- 快取鍵: `buygo_dashboard_activities_{$limit}`
- 快取時間: 1 分鐘（活動需要即時性）
- 調用: `$this->dashboardService->getRecentActivities($limit)`

**統一回傳格式:**
```php
new \WP_REST_Response([
    'success' => true,
    'data' => $result
], 200);
```

**統一錯誤處理:**
```php
try {
    // 查詢邏輯
} catch (\Exception $e) {
    return new \WP_REST_Response([
        'success' => false,
        'message' => $e->getMessage()
    ], 500);
}
```

參考 `TECH-SOLUTION.md` 第 8.2 節的程式碼範例。
  </action>
  <verify>
測試 3 個 API 端點：
```bash
# 營收趨勢
curl "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/revenue?period=7&currency=TWD" \
  -H "X-WP-Nonce: YOUR_NONCE"

# 商品概覽
curl "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/products" \
  -H "X-WP-Nonce: YOUR_NONCE"

# 最近活動
curl "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/activities?limit=5" \
  -H "X-WP-Nonce: YOUR_NONCE"
```
  </verify>
  <done>
3 個方法存在，均實作快取機制，可正確回傳資料
  </done>
</task>

<task type="auto">
  <name>Task 5: 在 Plugin 中註冊 Dashboard_API</name>
  <files>buygo-plus-one-dev/includes/class-plugin.php</files>
  <action>
在 `Plugin::register_hooks()` 方法中註冊 Dashboard_API：

1. 找到 `register_hooks()` 方法
2. 在 `rest_api_init` hook 中加入 Dashboard_API 註冊：
   ```php
   add_action('rest_api_init', function() {
       // ... 現有 API 註冊 ...

       // Dashboard API
       $dashboard_api = new Api\Dashboard_API();
       $dashboard_api->register_routes();
   });
   ```

確保 Dashboard_API 在 WordPress REST API 初始化時註冊。

參考現有 API 的註冊方式（`Customers_API`, `Products_API`）。
  </action>
  <verify>
檢查 WordPress REST API 索引包含 Dashboard 端點：
```bash
curl "http://buygo.me/wp-json/buygo-plus-one/v1" | jq '.routes' | grep dashboard
```
應顯示 4 個端點：/dashboard/stats, /dashboard/revenue, /dashboard/products, /dashboard/activities
  </verify>
  <done>
Dashboard_API 已在 Plugin 中註冊，REST API 索引包含 4 個端點
  </done>
</task>

</tasks>

<verification>
**整體驗證:**

1. REST API 端點可正常訪問（返回 200）
2. 權限檢查運作正常（無 nonce 返回 401）
3. 快取機制運作正常（第二次請求更快）
4. 參數驗證正常（錯誤參數返回 400）
5. 錯誤處理完整（資料庫錯誤返回 500）

**測試指令:**
```bash
# 測試所有端點
curl -X GET "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/stats" \
  -H "X-WP-Nonce: $(wp eval 'echo wp_create_nonce("wp_rest");')"

curl -X GET "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/revenue?period=30" \
  -H "X-WP-Nonce: $(wp eval 'echo wp_create_nonce("wp_rest");')"

curl -X GET "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/products" \
  -H "X-WP-Nonce: $(wp eval 'echo wp_create_nonce("wp_rest");')"

curl -X GET "http://buygo.me/wp-json/buygo-plus-one/v1/dashboard/activities?limit=10" \
  -H "X-WP-Nonce: $(wp eval 'echo wp_create_nonce("wp_rest");')"
```
</verification>

<success_criteria>
- [ ] Dashboard_API 類別存在且語法正確
- [ ] 4 個端點已註冊到 WordPress REST API
- [ ] 所有端點有權限檢查
- [ ] 所有端點有快取機制（不同快取時間）
- [ ] 參數驗證和錯誤處理完整
- [ ] Plugin 中已註冊 Dashboard_API
- [ ] API 端點可正常訪問並回傳正確格式
</success_criteria>

<output>
完成後建立 `.planning/phases/21-dashboard/21-02-SUMMARY.md` 記錄執行結果
</output>
