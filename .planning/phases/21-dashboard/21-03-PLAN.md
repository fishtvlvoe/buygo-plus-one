---
phase: 21-dashboard
plan: 03
type: execute
wave: 2
depends_on: [21-01, 21-02]
files_modified:
  - buygo-plus-one-dev/admin/partials/dashboard.php
  - buygo-plus-one-dev/includes/class-routes.php
autonomous: true

must_haves:
  truths:
    - "使用者可以訪問 /buygo-portal/dashboard/ 看到 Dashboard 頁面"
    - "統計卡片顯示本月訂單數、總金額、客戶數、平均訂單金額"
    - "統計卡片顯示變化百分比（正數綠色、負數紅色）"
    - "營收趨勢圖表顯示過去 30 天的每日營收（折線圖）"
    - "商品概覽顯示總商品數、已上架、待上架"
    - "最近活動列表顯示最新 10 筆訂單/客戶事件"
    - "頁面在桌面版和手機版都正常顯示"
  artifacts:
    - path: "buygo-plus-one-dev/admin/partials/dashboard.php"
      provides: "Dashboard Vue 3 頁面元件"
      min_lines: 300
      contains: ["DashboardPageComponent", "Chart.js", "fetch", "stats-grid", "chart-container"]
  key_links:
    - from: "dashboard.php Vue 元件"
      to: "Dashboard_API"
      via: "fetch 調用 4 個端點"
      pattern: "fetch.*dashboard/stats"
    - from: "dashboard.php"
      to: "Chart.js CDN"
      via: "script tag 載入"
      pattern: "cdn.jsdelivr.net/npm/chart.js"
    - from: "dashboard.php"
      to: "設計系統 CSS"
      via: "使用 .stat-card, .chart-card classes"
      pattern: "class=\"stat-card\""
---

<objective>
建立 dashboard.php - Dashboard Vue 3 前端頁面

Purpose: 實作使用者可見的 Dashboard 介面，整合 Chart.js 顯示統計和圖表
Output: dashboard.php 頁面，包含統計卡片、營收趨勢圖、商品概覽、活動列表
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/phases/21-dashboard/TECH-SOLUTION.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/codebase/ARCHITECTURE.md

# 參考現有頁面實作模式
@/Users/fishtv/Development/buygo-plus-one-dev/admin/partials/customers.php
@/Users/fishtv/Development/buygo-plus-one-dev/admin/partials/products.php

# 參考設計系統
@/Users/fishtv/Development/buygo-plus-one-dev/design-system/components/card.css
@/Users/fishtv/Development/buygo-plus-one-dev/design-system/components/header.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 dashboard.php 頁面架構</name>
  <files>buygo-plus-one-dev/admin/partials/dashboard.php</files>
  <action>
建立 `dashboard.php` 檔案，定義 Vue 3 頁面元件：

1. 建立 `buygo-plus-one-dev/admin/partials/dashboard.php`
2. 使用與其他頁面一致的架構（參考 `customers.php`）
3. 載入頁面專用 CSS：
   ```php
   <link rel="stylesheet" href="<?php echo esc_url(plugins_url('../css/dashboard.css', __FILE__)); ?>" />
   ```
4. 載入 Chart.js CDN（4.x 版本）：
   ```php
   <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
   ```
5. 定義 Vue 元件 `DashboardPageComponent`，包含：
   - `data()`: 定義狀態（loading, stats, revenueData, productsData, activities, error）
   - `mounted()`: 頁面載入時調用 `loadAllData()`
   - `methods`: loadAllData, loadStats, loadRevenue, loadProducts, loadActivities

**HTML 模板結構:**
```html
<div class="dashboard-container">
    <!-- 頁首 -->
    <header class="page-header">
        <h1>營運概覽</h1>
    </header>

    <!-- 載入中狀態 -->
    <div v-if="loading" class="loading-skeleton">...</div>

    <!-- 錯誤狀態 -->
    <div v-else-if="error" class="error-message">...</div>

    <!-- 主要內容 -->
    <div v-else>
        <!-- 統計卡片區 -->
        <section class="stats-grid">...</section>

        <!-- 圖表區 -->
        <section class="charts-grid">...</section>

        <!-- 活動列表 -->
        <section class="activities-list">...</section>
    </div>
</div>
```

參考 `TECH-SOLUTION.md` 第 4.3 節的 Vue 組件設計。

**重要技術約束:**
- 使用 `window.buygoWpNonce` 作為 API 請求的 nonce
- 所有 fetch 請求需帶 `X-WP-Nonce` header
- 使用 Promise.all 平行載入資料（效能優化）
  </action>
  <verify>
檢查檔案存在且可正常載入：
```bash
php -l /Users/fishtv/Development/buygo-plus-one-dev/admin/partials/dashboard.php
```
訪問 http://buygo.me/buygo-portal/dashboard/ 檢查頁面載入
  </verify>
  <done>
dashboard.php 存在，Vue 元件定義完整，頁面可正常載入
  </done>
</task>

<task type="auto">
  <name>Task 2: 實作統計卡片區（stats-grid）</name>
  <files>buygo-plus-one-dev/admin/partials/dashboard.php</files>
  <action>
在 Vue 模板中實作統計卡片區：

**HTML 模板:**
```html
<section class="stats-grid">
    <!-- 總營收 -->
    <div class="stat-card">
        <div class="stat-card-label">本月總營收</div>
        <div class="stat-card-value">{{ formatCurrency(stats.total_revenue.value) }}</div>
        <div class="stat-card-change" :class="getChangeClass(stats.total_revenue.change_percent)">
            <span>{{ stats.total_revenue.change_percent >= 0 ? '↑' : '↓' }}</span>
            <span>{{ Math.abs(stats.total_revenue.change_percent) }}% 較上月</span>
        </div>
    </div>

    <!-- 訂單數 -->
    <div class="stat-card">...</div>

    <!-- 客戶數 -->
    <div class="stat-card">...</div>

    <!-- 平均訂單金額 -->
    <div class="stat-card">...</div>
</section>
```

**Vue 方法:**
```javascript
methods: {
    async loadStats() {
        const response = await fetch('/wp-json/buygo-plus-one/v1/dashboard/stats', {
            headers: { 'X-WP-Nonce': window.buygoWpNonce }
        });
        const data = await response.json();
        this.stats = data.data;
    },

    formatCurrency(cents) {
        const amount = cents / 100; // 分 → 元
        return `NT$ ${amount.toLocaleString()}`;
    },

    getChangeClass(percent) {
        return percent >= 0 ? 'positive' : 'negative';
    }
}
```

**載入中骨架屏:**
使用 Tailwind CSS 的 animate-pulse 實作 skeleton screen。

參考 `TECH-SOLUTION.md` 第 4.4 節的載入狀態處理。
  </action>
  <verify>
訪問 Dashboard 頁面，檢查：
- 4 個統計卡片正確顯示
- 金額格式化正確（分 → 元，千分位逗號）
- 變化百分比顏色正確（正數綠色、負數紅色）
  </verify>
  <done>
統計卡片區實作完成，資料顯示正確，樣式符合設計系統
  </done>
</task>

<task type="auto">
  <name>Task 3: 實作營收趨勢圖表（Chart.js）</name>
  <files>buygo-plus-one-dev/admin/partials/dashboard.php</files>
  <action>
實作營收趨勢折線圖：

**HTML 模板:**
```html
<section class="charts-grid">
    <div class="chart-card">
        <h3 class="chart-title">營收趨勢（過去 30 天）</h3>
        <div class="chart-container">
            <canvas ref="revenueChart"></canvas>
        </div>
    </div>
</section>
```

**Vue 方法:**
```javascript
data() {
    return {
        revenueData: null,
        revenueChart: null  // Chart.js 實例
    }
},

methods: {
    async loadRevenue() {
        const response = await fetch('/wp-json/buygo-plus-one/v1/dashboard/revenue?period=30&currency=TWD', {
            headers: { 'X-WP-Nonce': window.buygoWpNonce }
        });
        const data = await response.json();
        this.revenueData = data.data;
        this.$nextTick(() => {
            this.renderRevenueChart();
        });
    },

    renderRevenueChart() {
        const ctx = this.$refs.revenueChart.getContext('2d');

        // 銷毀舊圖表（避免重複渲染）
        if (this.revenueChart) {
            this.revenueChart.destroy();
        }

        this.revenueChart = new Chart(ctx, {
            type: 'line',
            data: this.revenueData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `營收: ${this.formatCurrency(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => this.formatCurrency(value)
                        }
                    }
                }
            }
        });
    }
}
```

參考 `TECH-SOLUTION.md` 附錄 A.1 的 Chart.js 範例。

**重要技術約束:**
- 使用 `$nextTick()` 確保 DOM 渲染完成後再繪製圖表
- 圖表容器高度固定（桌面 300px，手機 250px）
- 金額顯示為「分 → 元」格式
  </action>
  <verify>
訪問 Dashboard 頁面，檢查：
- 折線圖正確顯示 30 天資料
- Hover 顯示詳細金額
- Y 軸金額格式化正確
- 手機版圖表正常顯示
  </verify>
  <done>
營收趨勢圖表實作完成，Chart.js 渲染正常，響應式佈局正確
  </done>
</task>

<task type="auto">
  <name>Task 4: 實作商品概覽和最近活動</name>
  <files>buygo-plus-one-dev/admin/partials/dashboard.php</files>
  <action>
實作商品概覽和活動列表：

**1. 商品概覽（簡單統計）**

HTML 模板:
```html
<section class="products-overview">
    <h3>商品概覽</h3>
    <div class="stats-row">
        <div class="stat-item">
            <span class="label">總商品數</span>
            <span class="value">{{ productsData.total_products }}</span>
        </div>
        <div class="stat-item">
            <span class="label">已上架</span>
            <span class="value">{{ productsData.published }}</span>
        </div>
        <div class="stat-item">
            <span class="label">待上架</span>
            <span class="value">{{ productsData.draft }}</span>
        </div>
    </div>
</section>
```

Vue 方法:
```javascript
async loadProducts() {
    const response = await fetch('/wp-json/buygo-plus-one/v1/dashboard/products', {
        headers: { 'X-WP-Nonce': window.buygoWpNonce }
    });
    const data = await response.json();
    this.productsData = data.data;
}
```

**2. 最近活動（時間軸）**

HTML 模板:
```html
<section class="activities-list">
    <h3>最近活動</h3>
    <div class="activity-item" v-for="activity in activities" :key="activity.id">
        <div class="activity-icon" :class="activity.type">
            <i :class="getIconClass(activity.type)"></i>
        </div>
        <div class="activity-content">
            <div class="activity-title">{{ activity.title }}</div>
            <div class="activity-description">{{ activity.description }}</div>
        </div>
        <div class="activity-time">{{ formatTimeAgo(activity.timestamp) }}</div>
    </div>
</section>
```

Vue 方法:
```javascript
async loadActivities() {
    const response = await fetch('/wp-json/buygo-plus-one/v1/dashboard/activities?limit=10', {
        headers: { 'X-WP-Nonce': window.buygoWpNonce }
    });
    const data = await response.json();
    this.activities = data.data;
},

getIconClass(type) {
    return type === 'order' ? 'shopping-cart' : 'user-plus';
},

formatTimeAgo(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 60) return `${diffMins} 分鐘前`;
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} 小時前`;
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} 天前`;
}
```
  </action>
  <verify>
訪問 Dashboard 頁面，檢查：
- 商品概覽顯示 3 個統計數字
- 活動列表顯示 10 筆最近事件
- 時間顯示為相對時間（「5 分鐘前」）
  </verify>
  <done>
商品概覽和活動列表實作完成，資料顯示正確
  </done>
</task>

<task type="auto">
  <name>Task 5: 更新路由並測試頁面</name>
  <files>buygo-plus-one-dev/includes/class-routes.php</files>
  <action>
確認 Dashboard 路由已存在並正確設定：

1. 檢查 `includes/class-routes.php` 中的路由規則
2. 確認 `/buygo-portal/dashboard/` 路由已註冊
3. 確認路由指向 `admin/partials/dashboard.php`

如果路由不存在，加入以下規則：
```php
add_rewrite_rule(
    '^buygo-portal/dashboard/?$',
    'index.php?buygo_page=dashboard',
    'top'
);
```

並在 `handle_buygo_pages()` 中加入 case：
```php
case 'dashboard':
    include BUYGO_PLUS_ONE_PLUGIN_DIR . 'admin/partials/dashboard.php';
    exit;
```

重新整理 WordPress rewrite rules:
```bash
wp rewrite flush --hard
```
  </action>
  <verify>
測試路由和頁面載入：
```bash
# 檢查路由存在
wp rewrite list | grep dashboard

# 訪問頁面
curl -I http://buygo.me/buygo-portal/dashboard/
# 應返回 200 OK
```

瀏覽器訪問 http://buygo.me/buygo-portal/dashboard/ 檢查完整功能
  </verify>
  <done>
路由設定正確，Dashboard 頁面可正常訪問，所有區塊顯示正常
  </done>
</task>

</tasks>

<verification>
**整體驗證:**

1. Dashboard 頁面可正常訪問（200 OK）
2. 統計卡片顯示正確資料
3. 營收趨勢圖表正常渲染
4. 商品概覽和活動列表正確顯示
5. 響應式佈局正常（桌面/手機）
6. 載入狀態和錯誤狀態正常顯示
7. 所有 API 請求包含 X-WP-Nonce header

**測試檢查清單:**
- [ ] 訪問 /buygo-portal/dashboard/ 可正常載入
- [ ] 統計卡片顯示 4 個指標（營收、訂單、客戶、平均）
- [ ] 變化百分比顏色正確（綠色/紅色）
- [ ] 折線圖顯示 30 天營收趨勢
- [ ] 商品概覽顯示總數/已上架/待上架
- [ ] 活動列表顯示 10 筆事件
- [ ] 手機版佈局正常（統計卡片垂直排列）
- [ ] Console 無錯誤
</verification>

<success_criteria>
- [ ] dashboard.php 存在且語法正確
- [ ] Vue 元件完整實作（data, mounted, methods）
- [ ] Chart.js CDN 已載入
- [ ] 4 個 API 端點均可正常調用
- [ ] 統計卡片、圖表、商品概覽、活動列表均正常顯示
- [ ] 金額格式化正確（分 → 元，千分位）
- [ ] 時間格式化正確（相對時間）
- [ ] 響應式佈局正常
- [ ] 路由設定正確
</success_criteria>

<output>
完成後建立 `.planning/phases/21-dashboard/21-03-SUMMARY.md` 記錄執行結果
</output>
