---
phase: 21-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - buygo-plus-one-dev/includes/services/class-dashboard-service.php
autonomous: true

must_haves:
  truths:
    - "DashboardService 可以計算本月訂單統計（訂單數、總金額、平均訂單金額）"
    - "DashboardService 可以取得營收趨勢資料（7/30/90 天）"
    - "DashboardService 可以取得商品概覽（總數、已上架、待上架）"
    - "DashboardService 可以取得最近活動（最新 10 筆訂單/客戶事件）"
    - "金額計算正確（FluentCart 以分為單位，正確除以 100）"
  artifacts:
    - path: "buygo-plus-one-dev/includes/services/class-dashboard-service.php"
      provides: "儀表板統計邏輯"
      exports: ["DashboardService"]
      min_lines: 200
      contains: ["calculateStats", "getRevenueTrend", "getProductOverview", "getRecentActivities"]
  key_links:
    - from: "DashboardService"
      to: "FluentCart 資料表"
      via: "wpdb 查詢 fct_orders, fct_customers, fct_order_items"
      pattern: "wpdb->get_results.*fct_orders"
    - from: "DashboardService"
      to: "DebugService"
      via: "建構函數注入"
      pattern: "new DebugService"
---

<objective>
建立 DashboardService - Dashboard 資料查詢邏輯層

Purpose: 封裝 Dashboard 所有統計查詢邏輯，為 API 層提供乾淨的資料介面
Output: DashboardService 類別，包含 4 個核心方法：calculateStats, getRevenueTrend, getProductOverview, getRecentActivities
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/phases/21-dashboard/FLUENTCART-DATABASE-ANALYSIS.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/phases/21-dashboard/TECH-SOLUTION.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/codebase/ARCHITECTURE.md

# 參考現有 Service 實作模式
@/Users/fishtv/Development/buygo-plus-one-dev/includes/services/class-order-service.php
@/Users/fishtv/Development/buygo-plus-one-dev/includes/services/class-product-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 DashboardService 類別架構</name>
  <files>buygo-plus-one-dev/includes/services/class-dashboard-service.php</files>
  <action>
建立 `DashboardService` 類別，封裝儀表板統計邏輯：

1. 建立 `buygo-plus-one-dev/includes/services/class-dashboard-service.php`
2. 使用 namespace `BuyGoPlus\Services`
3. 建構函數注入 `DebugService`（用於錯誤日誌）
4. 定義私有屬性：
   - `$wpdb` - WordPress 資料庫物件
   - `$debugService` - 除錯服務
   - `$table_orders` - FluentCart 訂單表名稱（`{prefix}_fct_orders`）
   - `$table_customers` - FluentCart 客戶表名稱（`{prefix}_fct_customers`）
   - `$table_order_items` - FluentCart 訂單項目表名稱（`{prefix}_fct_order_items`）

參考現有 Service 的建構函數模式（`OrderService`, `ProductService`）。

**重要技術約束:**
- FluentCart 金額以「分」為單位儲存，所有金額計算需除以 100
- 使用 `$wpdb->prepare()` 防止 SQL 注入
- 使用 `COALESCE(SUM(...), 0)` 避免 NULL 值問題
- 錯誤使用 `DebugService::log()` 記錄
  </action>
  <verify>
檢查檔案語法正確：
```bash
php -l /Users/fishtv/Development/buygo-plus-one-dev/includes/services/class-dashboard-service.php
```
  </verify>
  <done>
DashboardService 類別存在，包含建構函數和私有屬性，語法無錯誤
  </done>
</task>

<task type="auto">
  <name>Task 2: 實作 calculateStats 方法（總覽統計）</name>
  <files>buygo-plus-one-dev/includes/services/class-dashboard-service.php</files>
  <action>
實作 `calculateStats(): array` 方法，計算儀表板總覽統計：

**查詢邏輯:**
1. 本月統計（`created_at >= 本月 1 日 00:00:00`）：
   - 訂單數量: `COUNT(*)`
   - 總金額: `SUM(total_amount)`（除以 100 轉為元）
   - 客戶數量: `COUNT(DISTINCT customer_id)`
2. 上月統計（用於計算變化百分比）：
   - 同樣查詢，但日期範圍為上個月
3. 計算變化百分比:
   - 使用私有方法 `calculateChangePercent($current, $previous)`
   - 公式: `(($current - $previous) / $previous) * 100`
   - 若 previous = 0，返回 100（成長）或 0（無變化）

**回傳格式:**
```php
[
    'total_revenue' => [
        'value' => 158000,  // 分為單位
        'currency' => 'TWD',
        'change_percent' => 12.5,
        'period' => '本月'
    ],
    'total_orders' => [
        'value' => 234,
        'change_percent' => 8.3,
        'period' => '本月'
    ],
    'total_customers' => [
        'value' => 156,
        'change_percent' => 5.1,
        'period' => '本月'
    ],
    'avg_order_value' => [
        'value' => 675,  // 分為單位
        'currency' => 'TWD',
        'change_percent' => 3.2,
        'period' => '本月'
    ]
]
```

**SQL 條件:**
- `payment_status = 'paid'`（只計算已付款訂單）
- `mode = 'live'`（排除測試訂單）

參考 `TECH-SOLUTION.md` 第 8.1 節的程式碼範例。
  </action>
  <verify>
建立測試腳本驗證方法回傳格式：
```php
$service = new DashboardService();
$stats = $service->calculateStats();
var_dump($stats);
// 檢查是否包含 total_revenue, total_orders, total_customers, avg_order_value
```
  </verify>
  <done>
calculateStats 方法存在，可正確計算本月統計和變化百分比，回傳格式符合 API 規格
  </done>
</task>

<task type="auto">
  <name>Task 3: 實作 getRevenueTrend 方法（營收趨勢）</name>
  <files>buygo-plus-one-dev/includes/services/class-dashboard-service.php</files>
  <action>
實作 `getRevenueTrend(int $days = 30, string $currency = 'TWD'): array` 方法：

**查詢邏輯:**
1. 查詢過去 N 天的每日營收：
   ```sql
   SELECT
       DATE(created_at) as date,
       COALESCE(SUM(total_amount), 0) as daily_revenue
   FROM {table_orders}
   WHERE created_at >= DATE_SUB(NOW(), INTERVAL ? DAY)
       AND payment_status = 'paid'
       AND currency = ?
       AND mode = 'live'
   GROUP BY DATE(created_at)
   ORDER BY date ASC
   ```
2. 填補缺失日期（沒有訂單的日期顯示 0）：
   - 使用迴圈產生過去 N 天的日期陣列
   - 對應每個日期查找查詢結果，未找到填入 0

**回傳格式（Chart.js 格式）:**
```php
[
    'labels' => ['01/01', '01/02', '01/03', ...],  // 日期標籤
    'datasets' => [
        [
            'label' => '營收',
            'data' => [12000, 15000, 13500, ...],  // 分為單位
            'borderColor' => '#3b82f6',
            'backgroundColor' => 'rgba(59, 130, 246, 0.1)',
            'tension' => 0.4
        ]
    ],
    'currency' => 'TWD'
]
```

**參數:**
- `$days`: 天數（預設 30，支援 7, 30, 90）
- `$currency`: 幣別（預設 TWD，支援 USD, CNY）

參考 `TECH-SOLUTION.md` 第 8.1 節的 `getRevenueTrend` 方法。
  </action>
  <verify>
測試查詢過去 7 天的營收趨勢：
```php
$service = new DashboardService();
$trend = $service->getRevenueTrend(7, 'TWD');
var_dump($trend);
// 檢查 labels 和 datasets 陣列長度是否為 7
```
  </verify>
  <done>
getRevenueTrend 方法存在，可正確查詢並填補缺失日期，回傳 Chart.js 相容格式
  </done>
</task>

<task type="auto">
  <name>Task 4: 實作 getProductOverview 和 getRecentActivities 方法</name>
  <files>buygo-plus-one-dev/includes/services/class-dashboard-service.php</files>
  <action>
實作兩個方法：

**1. `getProductOverview(): array`**

查詢商品概覽統計：
```sql
SELECT
    COUNT(*) as total_products,
    SUM(CASE WHEN post_status = 'publish' THEN 1 ELSE 0 END) as published,
    SUM(CASE WHEN post_status = 'draft' THEN 1 ELSE 0 END) as draft
FROM {wp_posts}
WHERE post_type = 'fluent-products'
```

回傳格式:
```php
[
    'total_products' => 234,
    'published' => 123,
    'draft' => 111
]
```

**2. `getRecentActivities(int $limit = 10): array`**

查詢最近活動（訂單 + 客戶註冊）：
```sql
(SELECT
    'order' as type,
    CONCAT('新訂單 #', id) as title,
    CONCAT('客戶下單 ', total_amount / 100, ' 元') as description,
    created_at as timestamp,
    id
FROM {table_orders}
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY created_at DESC
LIMIT 5)

UNION ALL

(SELECT
    'customer' as type,
    '新客戶註冊' as title,
    CONCAT(first_name, ' ', last_name) as description,
    created_at as timestamp,
    id
FROM {table_customers}
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY created_at DESC
LIMIT 5)

ORDER BY timestamp DESC
LIMIT ?
```

回傳格式:
```php
[
    [
        'type' => 'order',
        'title' => '新訂單 #12345',
        'description' => '客戶下單 1,250 元',
        'timestamp' => '2026-01-29 10:25:00',
        'icon' => 'shopping-cart',
        'url' => '/buygo-portal/orders/?id=12345'
    ],
    ...
]
```

參考 `TECH-SOLUTION.md` 第 3.5 節的查詢範例。
  </action>
  <verify>
測試兩個方法的回傳值：
```php
$service = new DashboardService();
var_dump($service->getProductOverview());
var_dump($service->getRecentActivities(10));
```
  </verify>
  <done>
getProductOverview 和 getRecentActivities 方法存在，可正確查詢並回傳格式化資料
  </done>
</task>

</tasks>

<verification>
**整體驗證:**

1. DashboardService 類別可正常實例化
2. 所有方法回傳格式符合 API 規格
3. 查詢效能測試（執行時間 < 500ms）
4. 錯誤處理完整（資料庫錯誤有日誌記錄）

**測試指令:**
```bash
# 語法檢查
php -l /Users/fishtv/Development/buygo-plus-one-dev/includes/services/class-dashboard-service.php

# 功能測試（建立簡單測試腳本）
php /Users/fishtv/Development/buygo-plus-one-dev/test-dashboard-service.php
```
</verification>

<success_criteria>
- [ ] DashboardService 類別存在且語法正確
- [ ] calculateStats 方法可計算本月統計和變化百分比
- [ ] getRevenueTrend 方法可查詢營收趨勢並填補缺失日期
- [ ] getProductOverview 方法可查詢商品概覽
- [ ] getRecentActivities 方法可查詢最近活動
- [ ] 所有金額計算正確（分 → 元轉換）
- [ ] 查詢使用 prepare() 防止 SQL 注入
- [ ] 錯誤有日誌記錄
</success_criteria>

<output>
完成後建立 `.planning/phases/21-dashboard/21-01-SUMMARY.md` 記錄執行結果
</output>
