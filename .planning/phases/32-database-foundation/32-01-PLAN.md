---
phase: 32-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-plugin.php
  - includes/class-database.php
autonomous: true

must_haves:
  truths:
    - "buygo_shipments 資料表包含 estimated_delivery_at 欄位"
    - "欄位類型為 DATETIME, 允許 NULL"
    - "現有出貨單資料在升級後完整無損"
    - "從舊版本升級時自動新增欄位"
  artifacts:
    - path: "includes/class-plugin.php"
      provides: "DB_VERSION 版本號升級 (1.2.0 -> 1.3.0)"
      contains: "1.3.0"
    - path: "includes/class-database.php"
      provides: "estimated_delivery_at 欄位定義"
      contains: "estimated_delivery_at datetime"
  key_links:
    - from: "includes/class-plugin.php"
      to: "includes/class-database.php"
      via: "maybe_upgrade_database() 呼叫 Database::upgrade_tables()"
      pattern: "Database::upgrade_tables"
---

<objective>
在 buygo_shipments 資料表新增 estimated_delivery_at 欄位,支援賣家設定預計送達時間。

Purpose: 為出貨通知功能提供資料基礎,讓客戶能收到預計送達時間通知。
Output: 更新後的 Database 類和 Plugin 類,升級機制自動新增欄位。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@includes/class-plugin.php
@includes/class-database.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 更新 DB_VERSION 版本號</name>
  <files>includes/class-plugin.php</files>
  <action>
在 Plugin::maybe_upgrade_database() 方法中,將 $required_db_version 從 '1.2.0' 更新為 '1.3.0'。

修改位置: 第 210 行附近
```php
// 修改前
$required_db_version = '1.2.0'; // 修復出貨單資料表結構

// 修改後
$required_db_version = '1.3.0'; // 新增 estimated_delivery_at 欄位
```

注意: 不需要新增常數,直接修改現有的 $required_db_version 變數值即可。
  </action>
  <verify>grep -n "1.3.0" includes/class-plugin.php 應顯示版本號更新</verify>
  <done>$required_db_version 已更新為 '1.3.0',註解說明功能用途</done>
</task>

<task type="auto">
  <name>Task 2: 在 upgrade_shipments_table() 新增欄位升級邏輯</name>
  <files>includes/class-database.php</files>
  <action>
在 Database::upgrade_shipments_table() 方法中新增 estimated_delivery_at 欄位處理。

1. 在 CREATE TABLE 語句中新增欄位定義 (用於新安裝):
   - 位置: shipped_at 欄位後面,created_at 欄位前面
   - 語法: `estimated_delivery_at datetime,` (DATETIME NULL, 無預設值)

2. 在欄位檢查區塊新增升級邏輯 (用於現有安裝):
   在第 124 行 `// 添加 seller_id 欄位` 區塊之後,新增:
```php
// 添加 estimated_delivery_at 欄位 (v1.3.0)
if (!in_array('estimated_delivery_at', $columns)) {
    $wpdb->query("ALTER TABLE {$table_name} ADD COLUMN estimated_delivery_at datetime NULL AFTER shipped_at");
}
```

嚴格遵循 dbDelta 語法:
- PRIMARY KEY 後必須有兩個空格
- 使用 KEY 而非 INDEX
- datetime 全小寫
- 不設預設值 (符合 MySQL 8.0 最佳實踐)
  </action>
  <verify>
1. grep -n "estimated_delivery_at" includes/class-database.php 應顯示 2 處 (CREATE TABLE + ALTER TABLE)
2. 語法檢查: php -l includes/class-database.php 無錯誤
  </verify>
  <done>
- CREATE TABLE 語句包含 estimated_delivery_at datetime 欄位
- ALTER TABLE 升級邏輯包含欄位存在檢查
- 使用 DATETIME NULL 無預設值
  </done>
</task>

<task type="auto">
  <name>Task 3: 更新 create_shipments_table() 保持一致性</name>
  <files>includes/class-database.php</files>
  <action>
在 Database::create_shipments_table() 方法的 CREATE TABLE 語句中也新增 estimated_delivery_at 欄位,確保新安裝和升級安裝的資料表結構一致。

位置: 第 188 行 shipped_at 欄位後面
```php
shipped_at datetime,
estimated_delivery_at datetime,
created_at datetime DEFAULT CURRENT_TIMESTAMP,
```

這確保:
- 新安裝: create_tables() 建立完整結構
- 升級安裝: upgrade_tables() 補齊缺失欄位
  </action>
  <verify>grep -A2 "shipped_at datetime" includes/class-database.php | grep "estimated_delivery_at"</verify>
  <done>create_shipments_table() 和 upgrade_shipments_table() 的 CREATE TABLE 語句一致</done>
</task>

</tasks>

<verification>
執行以下驗證步驟:

1. **PHP 語法檢查**:
   ```bash
   php -l includes/class-plugin.php
   php -l includes/class-database.php
   ```

2. **版本號確認**:
   ```bash
   grep -n "required_db_version.*1.3.0" includes/class-plugin.php
   ```

3. **欄位定義確認**:
   ```bash
   grep -n "estimated_delivery_at" includes/class-database.php
   ```
   預期: 3 處 (create_shipments_table CREATE TABLE, upgrade_shipments_table CREATE TABLE, ALTER TABLE)

4. **單元測試** (如有):
   ```bash
   cd /Users/fishtv/Development/buygo-plus-one && composer test
   ```
</verification>

<success_criteria>
1. [ ] includes/class-plugin.php 中 $required_db_version 為 '1.3.0'
2. [ ] includes/class-database.php 中有 3 處 estimated_delivery_at 定義
3. [ ] PHP 語法檢查通過
4. [ ] 欄位使用 DATETIME NULL (無預設值)
5. [ ] upgrade 邏輯包含 in_array 存在檢查 (idempotent)
</success_criteria>

<output>
完成後建立 `.planning/phases/32-database-foundation/32-01-SUMMARY.md`
</output>
