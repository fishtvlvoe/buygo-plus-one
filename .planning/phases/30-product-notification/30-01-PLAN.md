# Plan 30-01: 商品上架通知

## Objective

當賣家透過 LINE 上架商品時，發送通知給賣家和所有小幫手。

## Tasks

### Task 1: 建立 ProductNotificationHandler 類別

建立 `includes/services/class-product-notification-handler.php`

監聽 `buygo/product/created` hook 並發送通知：

```php
class ProductNotificationHandler {
    public function __construct() {
        add_action('buygo/product/created', [$this, 'onProductCreated'], 10, 3);
    }

    public function onProductCreated($product_id, $product_data, $line_uid) {
        // 只處理透過 LINE 建立的商品（有 line_uid）
        if (empty($line_uid)) {
            return;
        }

        // 取得賣家 ID
        $seller_id = $product_data['user_id'] ?? null;
        if (!$seller_id) {
            return;
        }

        // 發送通知給賣家和小幫手
        NotificationService::sendToSellerAndHelpers($seller_id, 'product_created', [
            'product_name' => $product_data['name'] ?? '',
            'product_url' => home_url("/item/{$product_id}"),
        ]);
    }
}
```

### Task 2: 確認通知模板存在

確認 NotificationTemplates 有 `product_created` 模板，如果沒有則添加。

### Task 3: 在 Plugin 類別註冊 Handler

在 `class-plugin.php` 中載入並初始化 ProductNotificationHandler。

### Task 4: 確保 FluentCart 後台建立不觸發通知

`buygo/product/created` hook 只在有 `$line_uid` 時發送通知，FluentCart 後台建立的商品沒有 `$line_uid`。

## Verification

- [ ] 透過 LINE 上架商品後，賣家收到通知
- [ ] 透過 LINE 上架商品後，小幫手收到通知
- [ ] FluentCart 後台新增商品時，不發送通知
- [ ] 未綁定 LINE 的小幫手被跳過（不報錯）

## Files Modified

- `includes/services/class-product-notification-handler.php` (新建)
- `includes/class-plugin.php` (修改)
- `includes/services/class-notification-templates.php` (確認模板)
