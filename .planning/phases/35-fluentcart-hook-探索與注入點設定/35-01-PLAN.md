---
phase: 35-fluentcart-hook-探索與注入點設定
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php
  - buygo-plus-one/assets/js/fluentcart-child-orders.js
  - buygo-plus-one/includes/class-plugin.php
autonomous: false

must_haves:
  truths:
    - "在 FluentCart 會員訂單詳情頁面可以看到「查看子訂單」按鈕"
    - "點擊按鈕時，隱藏的子訂單容器會展開顯示"
    - "再次點擊按鈕時，容器會收合"
  artifacts:
    - path: "buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php"
      provides: "FluentCart Hook 整合類別，註冊 fluent_cart/customer_app hook"
      min_lines: 80
    - path: "buygo-plus-one/assets/js/fluentcart-child-orders.js"
      provides: "前端展開/折疊交互邏輯"
      min_lines: 30
  key_links:
    - from: "buygo-plus-one/includes/class-plugin.php"
      to: "FluentCartChildOrdersIntegration::register_hooks()"
      via: "require_once 和 init hook"
      pattern: "FluentCartChildOrdersIntegration::register_hooks"
    - from: "buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php"
      to: "fluent_cart/customer_app"
      via: "add_action hook registration"
      pattern: "add_action.*fluent_cart/customer_app"
---

<objective>
建立 FluentCart 會員訂單詳情頁的 Hook 整合基礎，實作「查看子訂單」按鈕和容器注入。

Purpose: 確定 FluentCart 整合技術可行性，建立 UI 注入基礎，為 Phase 36 和 37 的 API 和 UI 開發奠定基礎。

Output:
- 可運作的 Hook 整合類別
- 按鈕和容器的 HTML 注入
- 展開/折疊的 JavaScript 交互
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-fluentcart-hook-探索與注入點設定/35-RESEARCH.md

# 參考實作（buygo-line-notify 的 FluentCart 整合）
@/Users/fishtv/Development/buygo-line-notify/includes/integrations/class-fluentcart-customer-profile-integration.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 FluentCart 子訂單整合類別</name>
  <files>
    buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php
  </files>
  <action>
建立 FluentCartChildOrdersIntegration 類別，參考 buygo-line-notify 的整合模式：

1. 建立 `includes/integrations/` 目錄（如果不存在）

2. 建立 `class-fluentcart-child-orders-integration.php`，包含：
   - namespace: `BuygoPlus\Integrations`
   - 類別名稱: `FluentCartChildOrdersIntegration`
   - 靜態方法 `register_hooks()`: 註冊 `fluent_cart/customer_app` hook（priority: 100）和 `wp_enqueue_scripts` hook
   - 靜態方法 `render_child_orders_section()`: 渲染按鈕和容器 HTML
   - 靜態方法 `enqueue_assets()`: 條件式載入 JS 和 CSS（只在客戶檔案頁面）
   - 私有方法 `is_customer_profile_page()`: URL 檢測邏輯
   - 私有方法 `get_inline_css()`: 內聯 CSS 樣式

3. HTML 結構：
```html
<div id="buygo-child-orders-widget" class="buygo-child-orders-widget">
  <button id="buygo-view-child-orders-btn" class="buygo-btn buygo-btn-primary" data-expanded="false">
    查看子訂單
  </button>
  <div id="buygo-child-orders-container" class="buygo-child-orders-container" style="display: none;">
    <p class="buygo-child-orders-loading">載入中...</p>
  </div>
</div>
```

4. CSS 樣式（使用 .buygo- 前綴確保樣式隔離）：
   - `.buygo-child-orders-widget`: margin, padding, background, border-radius
   - `.buygo-btn`: 基本按鈕樣式
   - `.buygo-btn-primary`: 主要按鈕顏色（使用 BuyGo+1 設計系統顏色）
   - `.buygo-child-orders-container`: 容器樣式
   - 響應式設計（@media max-width: 768px）

5. 重要：使用 `wp_localize_script()` 傳遞配置，為 Phase 36 API 整合做準備：
```php
wp_localize_script('buygo-child-orders', 'buygoChildOrders', [
    'apiBase' => rest_url('buygo-plus-one/v1'),
    'nonce'   => wp_create_nonce('wp_rest'),
]);
```
  </action>
  <verify>
1. 檔案存在於 `buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php`
2. PHP 語法正確：`php -l buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php`
3. 類別包含所有必要方法
  </verify>
  <done>
FluentCartChildOrdersIntegration 類別建立完成，包含 hook 註冊、HTML 渲染、CSS 樣式和 wp_localize_script 配置。
  </done>
</task>

<task type="auto">
  <name>Task 2: 實作前端展開/折疊 JavaScript</name>
  <files>
    buygo-plus-one/assets/js/fluentcart-child-orders.js
  </files>
  <action>
建立 Vanilla JavaScript 檔案實作展開/折疊功能：

1. 使用 IIFE 包裝避免全域污染：`(function() { 'use strict'; ... })();`

2. 功能需求：
   - 監聽 `#buygo-view-child-orders-btn` 點擊事件
   - 切換 `#buygo-child-orders-container` 的 display 屬性（none/block）
   - 更新按鈕文字：展開時顯示「隱藏子訂單」，收合時顯示「查看子訂單」
   - 更新按鈕 data-expanded 屬性（true/false）

3. 程式碼結構：
```javascript
(function() {
    'use strict';

    // 等待 DOM 載入完成
    document.addEventListener('DOMContentLoaded', function() {
        const button = document.getElementById('buygo-view-child-orders-btn');
        const container = document.getElementById('buygo-child-orders-container');

        if (!button || !container) {
            return;
        }

        button.addEventListener('click', function() {
            const isExpanded = button.getAttribute('data-expanded') === 'true';

            if (isExpanded) {
                // 收合
                container.style.display = 'none';
                button.setAttribute('data-expanded', 'false');
                button.textContent = '查看子訂單';
            } else {
                // 展開
                container.style.display = 'block';
                button.setAttribute('data-expanded', 'true');
                button.textContent = '隱藏子訂單';

                // 預留 API 呼叫位置（Phase 36 實作）
                // if (!container.dataset.loaded) {
                //     loadChildOrders();
                // }
            }
        });
    });
})();
```

4. 為 Phase 36 預留 API 呼叫骨架（註解）：
   - `window.buygoChildOrders.apiBase` - API 基礎 URL
   - `window.buygoChildOrders.nonce` - 安全 token
  </action>
  <verify>
1. 檔案存在於 `buygo-plus-one/assets/js/fluentcart-child-orders.js`
2. JavaScript 語法正確（無 console 錯誤）
3. 程式碼使用 IIFE 包裝
  </verify>
  <done>
fluentcart-child-orders.js 建立完成，實作展開/折疊邏輯，並預留 API 呼叫骨架。
  </done>
</task>

<task type="auto">
  <name>Task 3: 整合到 Plugin 類別</name>
  <files>
    buygo-plus-one/includes/class-plugin.php
  </files>
  <action>
修改 Plugin 類別以載入 FluentCart 整合：

1. 在 `load_dependencies()` 方法中 require 整合類別：
```php
// FluentCart 整合
require_once BUYGO_PLUGIN_DIR . 'includes/integrations/class-fluentcart-child-orders-integration.php';
```

2. 在 `init()` 方法中初始化整合：
```php
// 初始化 FluentCart 整合（只在 FluentCart 啟用時）
if (class_exists('FluentCart\\App\\App')) {
    \BuygoPlus\Integrations\FluentCartChildOrdersIntegration::register_hooks();
}
```

3. 注意事項：
   - 使用 `class_exists()` 檢查 FluentCart 是否已安裝
   - 確保 require_once 在 register_hooks() 之前執行
   - 保持現有程式碼結構不變
  </action>
  <verify>
1. `php -l buygo-plus-one/includes/class-plugin.php` 語法正確
2. grep 確認 FluentCartChildOrdersIntegration 被載入和初始化
  </verify>
  <done>
Plugin 類別成功整合 FluentCart 子訂單功能，條件式載入確保 FluentCart 未安裝時不會報錯。
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
FluentCart Hook 整合基礎設施：
1. FluentCartChildOrdersIntegration 類別（hook 註冊、HTML 注入、CSS 樣式）
2. fluentcart-child-orders.js（展開/折疊交互）
3. Plugin 類別整合（條件式載入）
  </what-built>
  <how-to-verify>
1. 前往 https://test.buygo.me/my-account/ 登入會員帳戶
2. 進入「Purchase History」或訂單詳情頁面
3. 確認頁面下方出現「查看子訂單」按鈕
4. 點擊按鈕，確認容器展開並顯示「載入中...」文字
5. 再次點擊按鈕，確認容器收合
6. 檢查瀏覽器 Console 無 JavaScript 錯誤
7. 測試手機版（使用 DevTools 模擬 375px 寬度），確認按鈕顯示正常
  </how-to-verify>
  <resume-signal>輸入「approved」確認功能正常，或描述發現的問題</resume-signal>
</task>

</tasks>

<verification>
1. PHP 語法檢查：
   - `php -l buygo-plus-one/includes/integrations/class-fluentcart-child-orders-integration.php`
   - `php -l buygo-plus-one/includes/class-plugin.php`

2. 檔案結構確認：
   - `ls -la buygo-plus-one/includes/integrations/`
   - `ls -la buygo-plus-one/assets/js/fluentcart-child-orders.js`

3. Hook 整合確認：
   - `grep -r "fluent_cart/customer_app" buygo-plus-one/`
   - `grep -r "FluentCartChildOrdersIntegration" buygo-plus-one/`
</verification>

<success_criteria>
1. **INTEG-01 達成**: FluentCart Hook 點位置已識別並使用（`fluent_cart/customer_app`, priority: 100）
2. **INTEG-02 達成**: 「查看子訂單」按鈕成功注入到 FluentCart 會員訂單詳情頁面
3. **INTEG-03 達成**: 子訂單列表容器成功注入，初始隱藏，點擊按鈕可展開/收合
4. **技術驗證**: 按鈕和容器在桌面和手機版都能正確顯示
5. **程式碼品質**: 遵循 BuyGo+1 設計系統命名規範（.buygo- 前綴）、樣式隔離、條件式載入
</success_criteria>

<output>
完成後，建立 `.planning/phases/35-fluentcart-hook-探索與注入點設定/35-01-SUMMARY.md`
</output>
