# Plan 29-01: Bot 回應邏輯（基於身份過濾）

## Objective

根據用戶身份決定 bot 是否處理訊息：
- 賣家/小幫手：正常處理並回應
- 買家/未綁定用戶：靜默不回應

## Tasks

### Task 1: 修改 LineWebhookHandler 入口方法

在以下方法加入身份過濾：
- `handleTextMessage()` - 文字訊息處理
- `handleImageUpload()` - 圖片上傳處理
- `handlePostback()` - Postback 處理

**過濾邏輯：**

```php
// 在處理前檢查身份
$identity = IdentityService::getIdentityByLineUid($line_uid);
if (!IdentityService::canInteractWithBot($identity['user_id'] ?? 0)) {
    // 靜默不回應
    return;
}
```

### Task 2: 建立 BotResponseFilter 類別（可選）

如果邏輯複雜，可建立獨立類別處理：

```php
class BotResponseFilter {
    public static function shouldRespond(string $line_uid): bool;
    public static function logSilentIgnore(string $line_uid, string $reason): void;
}
```

### Task 3: 更新現有權限檢查

LineWebhookHandler 現有的 `can_upload_product()` 方法已經做了類似的檢查。整合 IdentityService 以統一邏輯。

## Verification

- [ ] 賣家發送文字訊息 → bot 正常回應
- [ ] 小幫手發送文字訊息 → bot 正常回應
- [ ] 賣家發送圖片 → bot 正常處理並回應
- [ ] 小幫手發送圖片 → bot 正常處理並回應
- [ ] 買家發送文字訊息 → bot 不回應（靜默）
- [ ] 未綁定用戶發送訊息 → bot 不回應（靜默）

## Files Modified

- `includes/services/class-line-webhook-handler.php` (修改)
- `tests/Unit/Services/BotResponseFilterTest.php` (新建，可選)
