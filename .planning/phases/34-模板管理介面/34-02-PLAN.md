---
phase: 34-模板管理介面
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/partials/shipment-details.php
  - admin/js/components/ShipmentDetailsPage.js
  - includes/api/class-shipments-api.php
  - includes/services/class-shipment-service.php
autonomous: true

must_haves:
  truths:
    - "出貨單詳情 Modal 顯示「預計送達時間」日期選擇器（選填）"
    - "日期選擇器使用 HTML5 date input 類型"
    - "儲存出貨單時，estimated_delivery_at 欄位正確更新到資料庫"
    - "預計送達時間為空時，不影響出貨單儲存"
  artifacts:
    - path: "admin/partials/shipment-details.php"
      provides: "出貨單頁面模板，包含詳情 Modal"
      contains: "estimated_delivery"
    - path: "admin/js/components/ShipmentDetailsPage.js"
      provides: "Vue 組件邏輯，處理日期選擇和 API 呼叫"
      contains: "estimated_delivery"
    - path: "includes/api/class-shipments-api.php"
      provides: "REST API 端點，接收和儲存 estimated_delivery_at"
      contains: "estimated_delivery_at"
    - path: "includes/services/class-shipment-service.php"
      provides: "服務層，處理 estimated_delivery_at 欄位更新"
      contains: "estimated_delivery_at"
  key_links:
    - from: "admin/js/components/ShipmentDetailsPage.js"
      to: "includes/api/class-shipments-api.php"
      via: "REST API PUT /shipments/{id}"
      pattern: "estimated_delivery"
    - from: "includes/api/class-shipments-api.php"
      to: "includes/services/class-shipment-service.php"
      via: "ShipmentService 方法呼叫"
      pattern: "estimated_delivery_at"
---

<objective>
在出貨單建立/編輯頁面新增「預計送達時間」輸入欄位，讓賣家可以設定每張出貨單的預計送達日期。

Purpose: 讓賣家可以為每張出貨單設定預計送達時間，此資訊會顯示在出貨通知中讓買家知道大約何時會收到商品。這是 DATA-03 需求的實作。

Output:
- 出貨單詳情 Modal 新增日期選擇器欄位
- API 支援 estimated_delivery_at 參數
- 資料庫正確儲存和讀取 estimated_delivery_at
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@admin/partials/shipment-details.php
@admin/js/components/ShipmentDetailsPage.js
@includes/api/class-shipments-api.php
@includes/services/class-shipment-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 在出貨單詳情 Modal 新增預計送達時間欄位</name>
  <files>admin/partials/shipment-details.php</files>
  <action>
在 `admin/partials/shipment-details.php` 的出貨單詳情 Modal（detailModal）中新增「預計送達時間」日期選擇器。

找到 detailModal 的 HTML 模板區塊，在適當位置（例如物流方式欄位之後）新增：

```html
<!-- 預計送達時間（選填） -->
<div class="mb-4">
    <label class="block text-sm font-medium text-slate-700 mb-1">預計送達時間（選填）</label>
    <input
        type="date"
        v-model="detailModal.shipment.estimated_delivery_date"
        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
        :min="getTodayDate()"
    />
    <p class="text-xs text-slate-500 mt-1">此資訊會顯示在出貨通知中</p>
</div>
```

使用 HTML5 date input 類型，提供原生日期選擇器。設定 min 為今天，避免選擇過去日期。

注意：如果 Modal 中沒有編輯功能，而是只有顯示功能，則需要在適當的「標記出貨」流程中新增此欄位。請先檢查現有的 Modal 結構和流程。
  </action>
  <verify>
1. grep 檢查欄位存在：`grep -n "estimated_delivery" admin/partials/shipment-details.php`
2. grep 檢查 input type：`grep -n "type=\"date\"" admin/partials/shipment-details.php`
  </verify>
  <done>
出貨單詳情 Modal 包含「預計送達時間」日期選擇器欄位
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 Vue 組件中處理 estimated_delivery_date 狀態和 API 呼叫</name>
  <files>admin/js/components/ShipmentDetailsPage.js</files>
  <action>
修改 `admin/js/components/ShipmentDetailsPage.js`：

1. 在 detailModal 初始化中新增 estimated_delivery_date 欄位：
```javascript
const detailModal = ref({
    show: false,
    shipment: null,
    items: [],
    total: 0
});
```
需要確保 shipment 物件包含 estimated_delivery_date（或 estimated_delivery_at）。

2. 新增 getTodayDate 方法（用於設定日期選擇器的 min 屬性）：
```javascript
const getTodayDate = () => {
    const today = new Date();
    return today.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
};
```

3. 在儲存出貨單（或標記出貨）的 API 呼叫中，新增 estimated_delivery_at 參數：
```javascript
const response = await fetch(`/wp-json/buygo-plus-one/v1/shipments/${shipmentId}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json',
        'X-WP-Nonce': wpNonce
    },
    body: JSON.stringify({
        // ... 其他欄位
        estimated_delivery_at: detailModal.value.shipment.estimated_delivery_date
            ? detailModal.value.shipment.estimated_delivery_date + ' 00:00:00'
            : null
    })
});
```

4. 在載入出貨單詳情時，將 estimated_delivery_at 轉換為 date input 可用的格式：
```javascript
// 將 MySQL datetime 轉換為 YYYY-MM-DD
const formatDateForInput = (datetime) => {
    if (!datetime) return '';
    return datetime.split(' ')[0]; // 取 YYYY-MM-DD 部分
};
```
  </action>
  <verify>
1. grep 檢查狀態定義：`grep -n "estimated_delivery" admin/js/components/ShipmentDetailsPage.js`
2. grep 檢查 API 呼叫：`grep -n "PUT\|estimated_delivery" admin/js/components/ShipmentDetailsPage.js`
3. grep 檢查日期方法：`grep -n "getTodayDate\|formatDateForInput" admin/js/components/ShipmentDetailsPage.js`
  </verify>
  <done>
Vue 組件正確處理 estimated_delivery_date 狀態，包含日期格式轉換和 API 呼叫
  </done>
</task>

<task type="auto">
  <name>Task 3: 在 Shipments API 支援 estimated_delivery_at 參數</name>
  <files>includes/api/class-shipments-api.php</files>
  <action>
修改 `includes/api/class-shipments-api.php` 的 `update_shipment` 方法：

1. 在接收參數時，處理 estimated_delivery_at：
```php
public function update_shipment(WP_REST_Request $request): WP_REST_Response {
    $id = $request->get_param('id');
    $params = $request->get_json_params();

    // 提取 estimated_delivery_at（可選參數）
    $estimated_delivery_at = isset($params['estimated_delivery_at'])
        ? sanitize_text_field($params['estimated_delivery_at'])
        : null;

    // 驗證日期格式（如果有值）
    if ($estimated_delivery_at && !strtotime($estimated_delivery_at)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '預計送達時間格式錯誤'
        ], 400);
    }

    // ... 其他邏輯

    // 呼叫 ShipmentService 更新
    $result = $this->shipmentService->update_shipment($id, [
        // ... 其他欄位
        'estimated_delivery_at' => $estimated_delivery_at
    ]);
}
```

2. 在 `get_shipment_detail` 方法的回應中，確保包含 estimated_delivery_at 欄位。

3. 如果使用 `batch_mark_shipped` 方法，也需要支援 estimated_delivery_at 參數。
  </action>
  <verify>
1. grep 檢查參數處理：`grep -n "estimated_delivery_at" includes/api/class-shipments-api.php`
2. grep 檢查日期驗證：`grep -n "strtotime" includes/api/class-shipments-api.php`
3. PHP 語法檢查：`php -l includes/api/class-shipments-api.php`
  </verify>
  <done>
Shipments API 正確接收和驗證 estimated_delivery_at 參數
  </done>
</task>

</tasks>

<verification>
執行以下驗證確認計畫完成：

1. **前端欄位驗證**
   ```bash
   # 檢查 HTML 模板中的日期欄位
   grep -n "estimated_delivery" admin/partials/shipment-details.php

   # 檢查 Vue 組件中的處理邏輯
   grep -n "estimated_delivery" admin/js/components/ShipmentDetailsPage.js
   ```

2. **API 驗證**
   ```bash
   # 檢查 API 參數處理
   grep -n "estimated_delivery_at" includes/api/class-shipments-api.php
   ```

3. **PHP 語法驗證**
   ```bash
   php -l includes/api/class-shipments-api.php
   php -l includes/services/class-shipment-service.php
   ```

4. **整合測試**（手動）
   - 開啟出貨單詳情 Modal
   - 確認顯示「預計送達時間」日期選擇器
   - 選擇日期並儲存
   - 重新載入確認日期已儲存
</verification>

<success_criteria>
1. 出貨單詳情 Modal 顯示「預計送達時間」日期選擇器
2. 日期選擇器使用 HTML5 date input，min 設為今天
3. 儲存出貨單時，estimated_delivery_at 正確更新到資料庫
4. 載入出貨單時，正確顯示已儲存的預計送達時間
5. 預計送達時間為空時，不影響其他功能
6. 所有 PHP 檔案通過語法檢查
</success_criteria>

<output>
完成後建立 `.planning/phases/34-模板管理介面/34-02-SUMMARY.md`
</output>
