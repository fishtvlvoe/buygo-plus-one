---
phase: 34-模板管理介面
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/partials/settings.php
  - includes/services/class-notification-templates.php
autonomous: true

must_haves:
  truths:
    - "Settings 頁面的「客戶」分類下顯示出貨通知模板（shipment_shipped）"
    - "模板編輯器顯示可用變數列表（product_list, shipping_method, estimated_delivery）"
    - "賣家可以編輯出貨通知模板內容並儲存到資料庫"
    - "提供「重設為預設值」按鈕，點擊後恢復為預設模板內容"
  artifacts:
    - path: "admin/partials/settings.php"
      provides: "前端模板編輯 UI，包含 shipment_shipped 模板定義"
      contains: "shipment_shipped"
    - path: "includes/services/class-notification-templates.php"
      provides: "後端模板定義，包含出貨通知模板預設值"
      contains: "shipment_shipped"
  key_links:
    - from: "admin/partials/settings.php"
      to: "includes/services/class-notification-templates.php"
      via: "REST API 儲存和讀取模板"
      pattern: "shipment_shipped"
---

<objective>
在 Settings 頁面的 LINE 模板管理 UI 中新增出貨通知模板（shipment_shipped），讓賣家可以自訂出貨通知的內容。

Purpose: 讓賣家可以透過後台 UI 自訂出貨通知的文字內容，包括商品清單格式、物流方式顯示和預計送達時間。這是 v1.3 出貨通知功能的最後一塊拼圖，讓系統具備完整的自訂能力。

Output:
- Settings 頁面「客戶」分類下新增「出貨通知」模板
- 模板編輯器支援變數點擊複製
- 模板儲存到 wp_options（透過現有 API）
- 「重設為預設值」功能
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@admin/partials/settings.php
@includes/services/class-notification-templates.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 在前端 templateDefinitions 新增 shipment_shipped 模板定義</name>
  <files>admin/partials/settings.php</files>
  <action>
在 `admin/partials/settings.php` 的 `templateDefinitions` 物件中，於 `buyer` 陣列內新增 shipment_shipped 模板定義。

位置：在 `order_shipped` 模板之後新增（同屬出貨相關通知）。

新增內容：
```javascript
{
    key: 'shipment_shipped',
    name: '出貨通知',
    description: '出貨單標記為「已出貨」時發送給買家',
    category: '客戶',
    type: 'text',
    variables: ['product_list', 'shipping_method', 'estimated_delivery']
}
```

同時在 `getVariableDescription` 方法中新增這三個變數的中文說明：
- `product_list`: '商品清單'
- `shipping_method`: '物流方式'
- `estimated_delivery`: '預計送達'

這樣前端就能正確顯示模板編輯器，包含可用變數列表。
  </action>
  <verify>
1. grep 檢查模板定義：`grep -n "shipment_shipped" admin/partials/settings.php`
2. grep 檢查變數說明：`grep -n "product_list\|shipping_method\|estimated_delivery" admin/partials/settings.php | head -10`
  </verify>
  <done>
前端 templateDefinitions 包含 shipment_shipped 模板定義，變數說明已新增到 getVariableDescription
  </done>
</task>

<task type="auto">
  <name>Task 2: 確認後端 definitions() 包含 shipment_shipped 預設模板</name>
  <files>includes/services/class-notification-templates.php</files>
  <action>
確認 `includes/services/class-notification-templates.php` 的 `definitions()` 方法中包含 shipment_shipped 模板。

**注意**：Phase 33-02 應該已經新增此模板。如果尚未新增，需要在 `definitions()` 方法中，於 `order_shipped` 模板之後新增：

```php
// 出貨通知（Phase 33/34: 發送給買家）
'shipment_shipped' => [
    'line' => [
        'message' => "您的訂單已出貨囉！\n\n商品清單：\n{product_list}\n\n物流方式：{shipping_method}\n預計送達：{estimated_delivery}\n\n感謝您的購買！如有問題請聯繫客服。"
    ]
],
```

如果模板已存在，僅需確認格式正確即可。
  </action>
  <verify>
1. grep 檢查模板存在：`grep -A8 "'shipment_shipped'" includes/services/class-notification-templates.php`
2. grep 檢查變數：`grep -n "product_list\|shipping_method\|estimated_delivery" includes/services/class-notification-templates.php | grep -v ".planning"`
3. PHP 語法檢查：`php -l includes/services/class-notification-templates.php`
  </verify>
  <done>
後端 definitions() 包含 shipment_shipped 模板，包含 {product_list}, {shipping_method}, {estimated_delivery} 變數
  </done>
</task>

</tasks>

<verification>
執行以下驗證確認計畫完成：

1. **前端模板定義驗證**
   ```bash
   # 檢查 shipment_shipped 在 templateDefinitions 中
   grep -A10 "shipment_shipped" admin/partials/settings.php | head -15
   ```

2. **變數說明驗證**
   ```bash
   # 檢查 getVariableDescription 包含新變數
   grep -B5 -A15 "getVariableDescription" admin/partials/settings.php | grep -E "product_list|shipping_method|estimated_delivery"
   ```

3. **後端模板驗證**
   ```bash
   # 檢查 definitions() 包含 shipment_shipped
   grep -A10 "'shipment_shipped'" includes/services/class-notification-templates.php
   ```

4. **PHP 語法驗證**
   ```bash
   php -l includes/services/class-notification-templates.php
   ```
</verification>

<success_criteria>
1. Settings 頁面「客戶」分類下顯示「出貨通知」模板
2. 模板編輯器顯示可用變數（product_list, shipping_method, estimated_delivery），點擊可複製
3. 模板內容可編輯並儲存（透過現有 REST API）
4. 所有 PHP 檔案通過語法檢查
</success_criteria>

<output>
完成後建立 `.planning/phases/34-模板管理介面/34-01-SUMMARY.md`
</output>
