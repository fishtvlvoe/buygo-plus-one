---
phase: 34-模板管理介面
plan: 01
type: execute
wave: 1
depends_on: ["33-02"]
files_modified:
  - admin/partials/settings.php
  - includes/services/class-notification-templates.php
  - includes/api/class-settings-api.php
  - includes/services/class-settings-service.php
autonomous: true

must_haves:
  truths:
    - "Settings 頁面的「客戶」分類下顯示出貨通知模板（shipment_shipped）"
    - "模板編輯器顯示可用變數列表（product_list, shipping_method, estimated_delivery）"
    - "賣家可以編輯出貨通知模板內容並儲存到資料庫"
    - "提供「重設為預設值」按鈕，點擊後恢復為預設模板內容"
    - "模板儲存透過 REST API POST /settings/templates 端點，使用 buygo_notification_templates wp_option"
  artifacts:
    - path: "admin/partials/settings.php"
      provides: "前端模板編輯 UI，包含 shipment_shipped 模板定義"
      contains: "shipment_shipped"
    - path: "includes/services/class-notification-templates.php"
      provides: "後端模板定義，包含出貨通知模板預設值和多層快取"
      contains: "shipment_shipped"
    - path: "includes/api/class-settings-api.php"
      provides: "REST API 端點，處理模板的讀取和儲存"
      contains: "settings/templates"
  key_links:
    - from: "admin/partials/settings.php"
      to: "includes/api/class-settings-api.php"
      via: "REST API POST /settings/templates"
      pattern: "settings/templates"
    - from: "includes/api/class-settings-api.php"
      to: "includes/services/class-notification-templates.php"
      via: "SettingsService -> NotificationTemplates::save_custom_templates()"
      pattern: "buygo_notification_templates"
---

<objective>
在 Settings 頁面的 LINE 模板管理 UI 中新增出貨通知模板（shipment_shipped），讓賣家可以自訂出貨通知的內容。

Purpose: 讓賣家可以透過後台 UI 自訂出貨通知的文字內容，包括商品清單格式、物流方式顯示和預計送達時間。這是 v1.3 出貨通知功能的最後一塊拼圖，讓系統具備完整的自訂能力。

Output:
- Settings 頁面「客戶」分類下新增「出貨通知」模板
- 模板編輯器支援變數點擊複製
- 模板儲存到 wp_options（透過 POST /settings/templates API，儲存到 buygo_notification_templates 選項）
- 「重設為預設值」功能
- 驗證多層快取實作（靜態快取 + WordPress 物件快取）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@admin/partials/settings.php
@includes/services/class-notification-templates.php
@.planning/phases/33-通知觸發與模板引擎/33-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 在前端 templateDefinitions 新增 shipment_shipped 模板定義</name>
  <files>admin/partials/settings.php</files>
  <action>
在 `admin/partials/settings.php` 的 `templateDefinitions` 物件中，於 `buyer` 陣列內新增 shipment_shipped 模板定義。

位置：在 `order_shipped` 模板之後新增（同屬出貨相關通知）。

新增內容：
```javascript
{
    key: 'shipment_shipped',
    name: '出貨通知',
    description: '出貨單標記為「已出貨」時發送給買家',
    category: '客戶',
    type: 'text',
    variables: ['product_list', 'shipping_method', 'estimated_delivery']
}
```

同時在 `getVariableDescription` 方法中新增這三個變數的中文說明：
- `product_list`: '商品清單'
- `shipping_method`: '物流方式'
- `estimated_delivery`: '預計送達'

這樣前端就能正確顯示模板編輯器，包含可用變數列表。

**驗證 TMPL-01 需求覆蓋**：同時確認 settings.php 的 templateDefinitions 已包含所有 TMPL-01 需求的通知類型：
- 商品上架（product_available）
- 新訂單（new_order）
- 訂單狀態變更（order_status_changed）
- 出貨通知（shipment_shipped）

如果缺少任何一個，需要一併新增。
  </action>
  <verify>
1. grep 檢查模板定義：`grep -n "shipment_shipped" admin/partials/settings.php`
2. grep 檢查變數說明：`grep -n "product_list\|shipping_method\|estimated_delivery" admin/partials/settings.php | head -10`
3. grep 檢查 TMPL-01 需求覆蓋：`grep -E "product_available|new_order|order_status|shipment_shipped" admin/partials/settings.php | wc -l`（應至少有 4 個相關項目）
  </verify>
  <done>
前端 templateDefinitions 包含 shipment_shipped 模板定義，變數說明已新增到 getVariableDescription，且包含 TMPL-01 需求的所有通知類型
  </done>
</task>

<task type="auto">
  <name>Task 2: 確認後端 definitions() 包含 shipment_shipped 預設模板</name>
  <files>includes/services/class-notification-templates.php</files>
  <action>
確認 `includes/services/class-notification-templates.php` 的 `definitions()` 方法中包含 shipment_shipped 模板。

**注意**：Phase 33-02 應該已經新增此模板。如果尚未新增，需要在 `definitions()` 方法中，於 `order_shipped` 模板之後新增：

```php
// 出貨通知（Phase 33/34: 發送給買家）
'shipment_shipped' => [
    'line' => [
        'message' => "您的訂單已出貨囉！\n\n商品清單：\n{product_list}\n\n物流方式：{shipping_method}\n預計送達：{estimated_delivery}\n\n感謝您的購買！如有問題請聯繫客服。"
    ]
],
```

如果模板已存在，僅需確認格式正確即可。
  </action>
  <verify>
1. grep 檢查模板存在：`grep -A8 "'shipment_shipped'" includes/services/class-notification-templates.php`
2. grep 檢查變數：`grep -n "product_list\|shipping_method\|estimated_delivery" includes/services/class-notification-templates.php | grep -v ".planning"`
3. PHP 語法檢查：`php -l includes/services/class-notification-templates.php`
  </verify>
  <done>
後端 definitions() 包含 shipment_shipped 模板，包含 {product_list}, {shipping_method}, {estimated_delivery} 變數
  </done>
</task>

<task type="auto">
  <name>Task 3: 驗證模板儲存 API 端點並確認快取實作</name>
  <files>
    - includes/api/class-settings-api.php
    - includes/services/class-settings-service.php
    - includes/services/class-notification-templates.php
  </files>
  <action>
驗證 Settings API 是否已實作模板儲存端點，確認符合 TMPL-04 需求。

**此為驗證任務**：現有 API 應該已經支援模板儲存，本任務確認實作細節。

檢查項目：

1. **REST API 端點路徑**
   確認端點為 `POST /wp-json/buygo-plus-one/v1/settings/templates`
   - 接收參數格式：`{ templates: { shipment_shipped: { line: { message: "..." } } } }`

2. **wp_options 儲存方式**
   確認使用 `buygo_notification_templates` 選項，儲存所有自訂模板為 JSON 物件
   - 注意：實際實作使用集合式儲存，非單獨 key
   - shipment_shipped 模板儲存在 `buygo_notification_templates['shipment_shipped']`

3. **多層快取實作**
   確認 NotificationTemplates 類別已實作：
   - 靜態快取：`self::$cached_custom_templates`
   - WordPress 物件快取：`wp_cache_set/get` 搭配 `buygo_notification_templates_cache` key

4. **重設為預設值功能**
   確認刪除自訂模板後會 fallback 到 definitions() 中的預設值

如果發現任何缺失，需要在本任務中補充實作。
  </action>
  <verify>
1. grep 檢查 API 端點註冊：`grep -n "settings/templates" includes/api/class-settings-api.php`
2. grep 檢查 wp_options key：`grep -n "buygo_notification_templates" includes/services/class-notification-templates.php | head -5`
3. grep 檢查靜態快取：`grep -n "cached_custom_templates" includes/services/class-notification-templates.php | head -3`
4. grep 檢查 WordPress 物件快取：`grep -n "wp_cache_set\|wp_cache_get" includes/services/class-notification-templates.php | head -3`
  </verify>
  <done>
已驗證模板儲存 API 端點存在且運作正常，使用 buygo_notification_templates 集合式儲存，實作多層快取（靜態快取 + WordPress 物件快取）
  </done>
</task>

</tasks>

<verification>
執行以下驗證確認計畫完成：

1. **前端模板定義驗證**
   ```bash
   # 檢查 shipment_shipped 在 templateDefinitions 中
   grep -A10 "shipment_shipped" admin/partials/settings.php | head -15
   ```

2. **變數說明驗證**
   ```bash
   # 檢查 getVariableDescription 包含新變數
   grep -B5 -A15 "getVariableDescription" admin/partials/settings.php | grep -E "product_list|shipping_method|estimated_delivery"
   ```

3. **後端模板驗證**
   ```bash
   # 檢查 definitions() 包含 shipment_shipped
   grep -A10 "'shipment_shipped'" includes/services/class-notification-templates.php
   ```

4. **PHP 語法驗證**
   ```bash
   php -l includes/services/class-notification-templates.php
   ```

5. **TMPL-01 需求覆蓋驗證**
   ```bash
   # 確認所有通知類型都已定義
   grep -c "product_available\|new_order\|order_status\|shipment_shipped" admin/partials/settings.php
   ```

6. **TMPL-04 模板儲存 API 驗證**
   ```bash
   # 確認 REST API 端點存在
   grep -n "settings/templates" includes/api/class-settings-api.php | head -5

   # 確認 wp_options key 和快取實作
   grep -n "buygo_notification_templates\|cached_custom_templates\|wp_cache" includes/services/class-notification-templates.php | head -10
   ```
</verification>

<success_criteria>
1. Settings 頁面「客戶」分類下顯示「出貨通知」模板
2. 模板編輯器顯示可用變數（product_list, shipping_method, estimated_delivery），點擊可複製
3. 模板內容可編輯並儲存（透過 POST /settings/templates REST API）
4. 所有 PHP 檔案通過語法檢查
5. templateDefinitions 包含 TMPL-01 需求的所有通知類型
6. 已驗證模板儲存 API 使用 buygo_notification_templates wp_option 且實作多層快取
</success_criteria>

<output>
完成後建立 `.planning/phases/34-模板管理介面/34-01-SUMMARY.md`
</output>
