---
phase: 39-fluentcart-自動賦予賣家權限
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/integrations/class-fluentcart-seller-grant.php
  - includes/class-database.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "當顧客購買賣家商品時，fluent_cart/order_created 和 fluent_cart/order_paid 都被監聽"
    - "使用去重機制（is_order_processed）確保每筆訂單只執行一次賦予流程"
    - "該顧客自動獲得 buygo_admin WordPress 角色"
    - "該顧客自動獲得 buygo_product_limit = 3 和 buygo_seller_type = 'test' user meta"
    - "整個流程記錄 debug log（訂單 ID、用戶 ID、商品 ID、賦予結果）"
    - "重複購買時跳過所有操作，不更新配額"
  artifacts:
    - path: "includes/integrations/class-fluentcart-seller-grant.php"
      provides: "FluentCart 訂單監聽和賣家權限賦予整合類別"
      contains: "fluent_cart/order_created"
    - path: "includes/class-database.php"
      provides: "賣家賦予記錄資料表建立"
      contains: "buygo_seller_grants"
  key_links:
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "fluent_cart/order_created"
      via: "WordPress action hook"
      pattern: "add_action.*fluent_cart/order_created"
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "fluent_cart/order_paid"
      via: "WordPress action hook"
      pattern: "add_action.*fluent_cart/order_paid"
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "wp_buygo_seller_grants"
      via: "database insert"
      pattern: "buygo_seller_grants"
---

<objective>
建立 FluentCart 訂單監聯整合類別，當顧客購買指定的賣家商品並付款完成時，自動賦予 buygo_admin 角色和預設配額。

Purpose: 實現核心的自動化賦予邏輯，降低手動操作成本和錯誤率
Output: 完整的 FluentCartSellerGrantIntegration 類別，包含 Hook 監聽、商品驗證、角色賦予、資料記錄功能

**為何同時監聽兩個 Hook（order_created 和 order_paid）:**
- `fluent_cart/order_paid` — 處理線上付款（信用卡、PayPal 等），付款完成後觸發
- `fluent_cart/order_created` — 處理 COD（貨到付款）等離線付款，因為這類訂單的 `payment_status` 永遠是 `pending`，`order_paid` 永遠不會觸發

由於使用 `is_order_processed()` 去重機制（基於 UNIQUE KEY），無論哪個 hook 先觸發，都只會執行一次賦予流程。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-CONTEXT.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-RESEARCH.md
@includes/integrations/class-fluentcart-offline-payment-user.php（參考架構）
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 seller_grants 資料表</name>
  <files>includes/class-database.php</files>
  <action>
1. 在 `create_tables()` 方法中新增呼叫：
   ```php
   // 建立賣家賦予記錄表（Phase 39）
   self::create_seller_grants_table($wpdb, $charset_collate);
   ```

2. 新增 `create_seller_grants_table()` 方法：
   ```php
   /**
    * 建立賣家賦予記錄表（Phase 39）
    * 記錄每次自動賦予賣家權限的歷史
    */
   private static function create_seller_grants_table($wpdb, $charset_collate): void
   {
       $table_name = $wpdb->prefix . 'buygo_seller_grants';

       if ($wpdb->get_var("SHOW TABLES LIKE '{$table_name}'") === $table_name) {
           return;
       }

       $sql = "CREATE TABLE {$table_name} (
           id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
           order_id bigint(20) UNSIGNED NOT NULL,
           user_id bigint(20) UNSIGNED NOT NULL,
           product_id bigint(20) UNSIGNED NOT NULL,
           status varchar(20) NOT NULL DEFAULT 'success',
           error_message text,
           granted_role varchar(50) DEFAULT 'buygo_admin',
           granted_quota int(11) DEFAULT 3,
           notification_sent tinyint(1) DEFAULT 0,
           notification_channel varchar(20),
           created_at datetime DEFAULT CURRENT_TIMESTAMP,
           PRIMARY KEY (id),
           UNIQUE KEY unique_order (order_id),
           KEY idx_user_id (user_id),
           KEY idx_status (status),
           KEY idx_created_at (created_at)
       ) {$charset_collate};";

       dbDelta($sql);
   }
   ```

   **欄位說明：**
   - `order_id`: FluentCart 訂單 ID（UNIQUE 防止重複處理）
   - `user_id`: WordPress 使用者 ID
   - `product_id`: FluentCart 商品 ID
   - `status`: 'success', 'skipped', 'failed', 'revoked'
   - `error_message`: 失敗原因
   - `granted_role`: 賦予的角色（預設 buygo_admin）
   - `granted_quota`: 賦予的配額（預設 3）
   - `notification_sent`: 是否已發送通知
   - `notification_channel`: 通知管道（'line' 或 'email'）
  </action>
  <verify>在 WordPress 後台啟用/停用外掛後，使用 phpMyAdmin 或 wp db query 確認 wp_buygo_seller_grants 表已建立</verify>
  <done>wp_buygo_seller_grants 資料表已建立，包含所有必要欄位和索引</done>
</task>

<task type="auto">
  <name>Task 2: 建立 FluentCartSellerGrantIntegration 類別</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
建立新檔案 `includes/integrations/class-fluentcart-seller-grant.php`：

```php
<?php
/**
 * FluentCart Seller Grant Integration
 *
 * 自動賦予賣家權限功能 - Phase 39
 *
 * 當顧客購買指定的賣家商品並付款完成時，自動：
 * 1. 賦予 buygo_admin 角色
 * 2. 設定 buygo_product_limit = 3
 * 3. 設定 buygo_seller_type = 'test'
 * 4. 發送通知（LINE 優先，fallback 到 Email）
 * 5. 記錄到 wp_buygo_seller_grants 表
 *
 * @package BuygoPlus
 */

namespace BuygoPlus\Integrations;

if (!defined('ABSPATH')) {
    exit;
}

class FluentCartSellerGrantIntegration
{
    /**
     * 預設商品配額
     */
    const DEFAULT_PRODUCT_LIMIT = 3;

    /**
     * 預設賣家類型
     */
    const DEFAULT_SELLER_TYPE = 'test';

    /**
     * 註冊 hooks
     *
     * 同時監聽 order_created 和 order_paid，使用去重機制確保只執行一次
     *
     * 為何監聽兩個 hook:
     * - order_paid: 處理線上付款（信用卡、PayPal 等）
     * - order_created: 處理 COD（貨到付款）等離線付款
     *   因為離線付款的 payment_status 永遠是 pending，order_paid 不會觸發
     */
    public static function register_hooks(): void
    {
        // 監聽訂單建立事件（處理 COD 等離線付款）
        add_action('fluent_cart/order_created', [__CLASS__, 'handle_order_event'], 20);
        // 監聯訂單付款完成事件（處理線上付款）
        add_action('fluent_cart/order_paid', [__CLASS__, 'handle_order_event'], 20);
    }

    /**
     * 處理訂單事件（order_created 或 order_paid）
     *
     * 由於同時監聽兩個 hook，使用 is_order_processed() 確保每筆訂單只處理一次
     *
     * @param array $data FluentCart 事件資料陣列
     *                    包含 'order', 'prev_order', 'customer', 'transaction'
     */
    public static function handle_order_event($data): void
    {
        // FluentCart 傳遞的是陣列，不是物件
        $order = $data['order'] ?? null;

        if (!$order) {
            error_log('[BuyGo+1][SellerGrant] Hook triggered but no order data');
            return;
        }

        error_log(sprintf(
            '[BuyGo+1][SellerGrant] Order #%d paid, checking if seller product order',
            $order->id ?? 'unknown'
        ));

        // 檢查是否為指定的賣家商品訂單
        if (!self::is_seller_product_order($order)) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Order #%d is not seller product order, skipping',
                $order->id
            ));
            return;
        }

        // 檢查是否已處理（去重）
        if (self::is_order_processed($order->id)) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Order #%d already processed, skipping',
                $order->id
            ));
            return;
        }

        // 執行賦予流程
        self::grant_seller_access($order);
    }

    /**
     * 檢查是否為賣家商品訂單
     *
     * 條件：
     * 1. 訂單只有一個商品項目
     * 2. 商品 ID 與設定的賣家商品 ID 相符
     * 3. 商品必須是虛擬商品（is_shippable = 0）
     *
     * @param object $order 訂單物件
     * @return bool
     */
    private static function is_seller_product_order($order): bool
    {
        // 取得設定的賣家商品 ID
        $seller_product_id = get_option('buygo_seller_product_id', '');
        if (empty($seller_product_id)) {
            error_log('[BuyGo+1][SellerGrant] No seller product ID configured');
            return false;
        }

        global $wpdb;

        // 取得訂單中的商品
        $items = $wpdb->get_results($wpdb->prepare(
            "SELECT product_id FROM {$wpdb->prefix}fct_order_items WHERE order_id = %d",
            $order->id
        ));

        // 必須是單一商品訂單
        if (count($items) !== 1) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Order #%d has %d items, must be exactly 1',
                $order->id,
                count($items)
            ));
            return false;
        }

        // 必須是指定的賣家商品
        if ((string)$items[0]->product_id !== (string)$seller_product_id) {
            return false;
        }

        // 驗證商品是否為虛擬商品
        $fct_product = $wpdb->get_row($wpdb->prepare(
            "SELECT is_shippable FROM {$wpdb->prefix}fct_products WHERE id = %d",
            $seller_product_id
        ));

        if ($fct_product && $fct_product->is_shippable == 1) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Product #%d is not virtual product',
                $seller_product_id
            ));
            return false;
        }

        error_log(sprintf(
            '[BuyGo+1][SellerGrant] Order #%d matches seller product #%d',
            $order->id,
            $seller_product_id
        ));

        return true;
    }

    /**
     * 檢查訂單是否已處理（去重機制）
     *
     * @param int $order_id 訂單 ID
     * @return bool
     */
    private static function is_order_processed(int $order_id): bool
    {
        global $wpdb;
        $exists = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM {$wpdb->prefix}buygo_seller_grants WHERE order_id = %d",
            $order_id
        ));
        return $exists > 0;
    }

    /**
     * 執行賣家權限賦予流程
     *
     * @param object $order 訂單物件
     */
    private static function grant_seller_access($order): void
    {
        global $wpdb;

        $seller_product_id = get_option('buygo_seller_product_id', '');

        // 取得 WordPress User ID（從 FluentCart Customer 關聯）
        $customer = $wpdb->get_row($wpdb->prepare(
            "SELECT user_id FROM {$wpdb->prefix}fct_customers WHERE id = %d",
            $order->customer_id
        ));

        if (!$customer || !$customer->user_id) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Order #%d: customer #%d not linked to WordPress user',
                $order->id,
                $order->customer_id
            ));
            self::log_grant_attempt($order->id, 0, $seller_product_id, 'failed', 'Customer not linked to WordPress user');
            return;
        }

        $user_id = $customer->user_id;
        $user = get_userdata($user_id);

        if (!$user) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Order #%d: WordPress user #%d not found',
                $order->id,
                $user_id
            ));
            self::log_grant_attempt($order->id, $user_id, $seller_product_id, 'failed', 'WordPress user not found');
            return;
        }

        // 檢查使用者是否已有 buygo_admin 角色
        if (in_array('buygo_admin', $user->roles) || in_array('administrator', $user->roles)) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] User #%d already has seller role, skipping',
                $user_id
            ));
            self::log_grant_attempt($order->id, $user_id, $seller_product_id, 'skipped', 'User already has seller role');
            return;
        }

        // 賦予 buygo_admin 角色
        $user->add_role('buygo_admin');

        // 設定 user meta（只在不存在時才寫入）
        if (get_user_meta($user_id, 'buygo_product_limit', true) === '') {
            update_user_meta($user_id, 'buygo_product_limit', self::DEFAULT_PRODUCT_LIMIT);
        }

        if (get_user_meta($user_id, 'buygo_seller_type', true) === '') {
            update_user_meta($user_id, 'buygo_seller_type', self::DEFAULT_SELLER_TYPE);
        }

        error_log(sprintf(
            '[BuyGo+1][SellerGrant] SUCCESS: User #%d granted buygo_admin role (Order #%d, Product #%d)',
            $user_id,
            $order->id,
            $seller_product_id
        ));

        // 記錄到資料表（通知稍後由 39-03 計畫處理）
        self::log_grant_attempt($order->id, $user_id, $seller_product_id, 'success', null);
    }

    /**
     * 記錄賦予嘗試到資料表
     *
     * @param int $order_id 訂單 ID
     * @param int $user_id 使用者 ID
     * @param int $product_id 商品 ID
     * @param string $status 狀態 (success, skipped, failed)
     * @param string|null $error_message 錯誤訊息
     */
    private static function log_grant_attempt(int $order_id, int $user_id, $product_id, string $status, ?string $error_message): void
    {
        global $wpdb;

        $wpdb->insert(
            $wpdb->prefix . 'buygo_seller_grants',
            [
                'order_id' => $order_id,
                'user_id' => $user_id,
                'product_id' => (int)$product_id,
                'status' => $status,
                'error_message' => $error_message,
                'granted_role' => 'buygo_admin',
                'granted_quota' => self::DEFAULT_PRODUCT_LIMIT,
                'notification_sent' => 0,
                'notification_channel' => null,
                'created_at' => current_time('mysql')
            ],
            ['%d', '%d', '%d', '%s', '%s', '%s', '%d', '%d', '%s', '%s']
        );

        if ($wpdb->last_error) {
            error_log(sprintf(
                '[BuyGo+1][SellerGrant] Failed to log grant attempt: %s',
                $wpdb->last_error
            ));
        }
    }
}
```
  </action>
  <verify>檢查檔案語法：`php -l includes/integrations/class-fluentcart-seller-grant.php`</verify>
  <done>FluentCartSellerGrantIntegration 類別建立完成，包含完整的 Hook 監聽、驗證、賦予邏輯</done>
</task>

<task type="auto">
  <name>Task 3: 在 Plugin 類別中註冊整合</name>
  <files>includes/class-plugin.php</files>
  <action>
1. 在 `load_dependencies()` 方法的 FluentCart 整合區塊中新增 require：
   ```php
   require_once BUYGO_PLUS_ONE_PLUGIN_DIR . 'includes/integrations/class-fluentcart-seller-grant.php';
   ```

2. 在 `register_hooks()` 方法的 FluentCart 整合區塊中新增：
   ```php
   // 初始化 FluentCart 賣家自動賦予（Phase 39）
   \BuygoPlus\Integrations\FluentCartSellerGrantIntegration::register_hooks();
   ```

   放在現有的 FluentCart 整合之後：
   ```php
   // 初始化 FluentCart 整合（只在 FluentCart 啟用時）
   if (class_exists('FluentCart\\App\\App')) {
       \BuygoPlus\Integrations\FluentCartChildOrdersIntegration::register_hooks();
       \BuygoPlus\Integrations\FluentCartOfflinePaymentUser::register_hooks();
       \BuygoPlus\Integrations\FluentCartSellerGrantIntegration::register_hooks();  // 新增
   }
   ```
  </action>
  <verify>
1. 確認 debug.log 中有 `[BuyGo+1][SellerGrant]` 記錄（測試購買後）
2. 驗證資料表存在：`wp db query "SHOW TABLES LIKE 'wp_buygo_seller_grants'"` 或 `wp db query "SELECT COUNT(*) FROM wp_buygo_seller_grants"`
  </verify>
  <done>整合類別已在 Plugin 中正確註冊，Hook 可正常監聽，且 seller_grants 資料表已建立</done>
</task>

</tasks>

<verification>
1. 確認 `wp_buygo_seller_grants` 資料表已建立（使用 WP CLI: `wp db query "SHOW CREATE TABLE wp_buygo_seller_grants"`)
2. 設定賣家商品 ID 後，使用測試帳號購買該商品
3. 付款完成後，檢查 debug.log 確認 Hook 被觸發
4. 檢查測試帳號是否已獲得 buygo_admin 角色
5. 檢查 user meta: buygo_product_limit = 3, buygo_seller_type = 'test'
6. 檢查 wp_buygo_seller_grants 表中有記錄
7. 再次購買同一商品，確認 status = 'skipped'（不重複賦予）
</verification>

<success_criteria>
- fluent_cart/order_paid hook 被正確監聽
- fluent_cart/order_created hook 被正確監聽（處理 COD 離線付款）
- 購買賣家商品後顧客自動獲得 buygo_admin 角色
- user meta 正確設定（buygo_product_limit = 3, buygo_seller_type = 'test'）
- 賦予記錄正確寫入 wp_buygo_seller_grants 表
- 重複購買時狀態為 skipped，不會重複賦予
- 所有步驟有完整的 debug log
</success_criteria>

<output>
After completion, create `.planning/phases/39-fluentcart-自動賦予賣家權限-/39-02-SUMMARY.md`
</output>
