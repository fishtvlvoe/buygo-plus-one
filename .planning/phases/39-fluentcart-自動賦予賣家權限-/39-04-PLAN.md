---
phase: 39-fluentcart-自動賦予賣家權限
plan: 04
type: execute
wave: 2
depends_on: ["39-02"]
files_modified:
  - includes/integrations/class-fluentcart-seller-grant.php
autonomous: false

must_haves:
  truths:
    - "監聽 FluentCart 退款 hook，當賣家商品訂單退款時自動移除 buygo_admin 角色"
    - "退款後移除相關 user meta（buygo_product_limit, buygo_seller_type）"
    - "退款撤銷記錄到 wp_buygo_seller_grants 表（status = 'revoked'）"
    - "完整的功能驗證：購買流程、重複購買、退款流程"
  artifacts:
    - path: "includes/integrations/class-fluentcart-seller-grant.php"
      provides: "退款處理邏輯"
      contains: "handle_order_refunded"
  key_links:
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "fluent_cart/order_refunded"
      via: "WordPress action hook"
      pattern: "add_action.*order_refunded"
---

<objective>
實作退款處理邏輯（自動撤銷賣家權限）並進行完整的功能驗證。

Purpose: 確保退款時權限被正確撤銷，符合退款政策；驗證整個 Phase 39 的功能完整性
Output: 退款處理邏輯 + 完整的手動驗證報告
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-CONTEXT.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-RESEARCH.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-02-SUMMARY.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 研究 FluentCart 退款 Hook</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
1. 搜尋 FluentCart 原始碼確認退款 Hook 名稱：
   - 檢查 `wp-content/plugins/fluent-cart/` 目錄
   - 搜尋 "refund" 相關的 do_action
   - 確認 Hook 名稱和參數格式

2. 根據發現更新 `register_hooks()` 方法：
   ```php
   public static function register_hooks(): void
   {
       // 監聽訂單付款完成事件
       add_action('fluent_cart/order_paid', [__CLASS__, 'handle_order_paid'], 20);

       // 監聽訂單退款事件（需要確認實際 Hook 名稱）
       // 可能的名稱：
       // - fluent_cart/order_refunded
       // - fluent_cart/order_status_changed（狀態變為 refunded）
       // - fluent_cart/refund_processed
       add_action('fluent_cart/order_refunded', [__CLASS__, 'handle_order_refunded'], 20);
   }
   ```

**注意**：如果找不到專用的退款 Hook，可以監聽 `fluent_cart/order_status_changed` 並檢查新狀態是否為退款相關狀態。
  </action>
  <verify>執行 `grep -r "do_action.*refund" /Users/fishtv/Local\ Sites/buygo/app/public/wp-content/plugins/fluent-cart/ --include="*.php"` 搜尋退款 Hook，或檢查 `wp-content/plugins/fluent-cart/app/Services/OrderService.php` 和 `RefundService.php` 中的 do_action 呼叫</verify>
  <done>確認 FluentCart 退款 Hook 名稱和參數格式</done>
</task>

<task type="auto">
  <name>Task 2: 實作退款處理邏輯</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
新增退款處理方法：

```php
/**
 * 處理訂單退款事件
 *
 * @param array $data FluentCart 事件資料陣列
 */
public static function handle_order_refunded($data): void
{
    $order = $data['order'] ?? null;

    if (!$order) {
        error_log('[BuyGo+1][SellerGrant] Refund hook triggered but no order data');
        return;
    }

    error_log(sprintf(
        '[BuyGo+1][SellerGrant] Order #%d refunded, checking if seller product order',
        $order->id ?? 'unknown'
    ));

    // 檢查是否為賣家商品訂單
    if (!self::is_seller_product_order($order)) {
        return;
    }

    // 檢查是否有之前的成功賦予記錄
    global $wpdb;
    $grant_record = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}buygo_seller_grants
         WHERE order_id = %d AND status = 'success'",
        $order->id
    ));

    if (!$grant_record) {
        error_log(sprintf(
            '[BuyGo+1][SellerGrant] No grant record found for order #%d, skipping revoke',
            $order->id
        ));
        return;
    }

    // 撤銷賣家權限
    self::revoke_seller_access($order, $grant_record);
}

/**
 * 撤銷賣家權限
 *
 * @param object $order 訂單物件
 * @param object $grant_record 原賦予記錄
 */
private static function revoke_seller_access($order, $grant_record): void
{
    $user_id = $grant_record->user_id;
    $user = get_userdata($user_id);

    if (!$user) {
        error_log(sprintf(
            '[BuyGo+1][SellerGrant] Cannot revoke: user #%d not found',
            $user_id
        ));
        return;
    }

    // 移除 buygo_admin 角色
    $user->remove_role('buygo_admin');

    // 刪除 user meta
    delete_user_meta($user_id, 'buygo_product_limit');
    delete_user_meta($user_id, 'buygo_seller_type');

    error_log(sprintf(
        '[BuyGo+1][SellerGrant] SUCCESS: Seller access revoked for user #%d (Order #%d refunded)',
        $user_id,
        $order->id
    ));

    // 記錄撤銷操作到資料表（新增一筆 revoked 記錄）
    global $wpdb;
    $wpdb->insert(
        $wpdb->prefix . 'buygo_seller_grants',
        [
            'order_id' => $order->id,
            'user_id' => $user_id,
            'product_id' => $grant_record->product_id,
            'status' => 'revoked',
            'error_message' => 'Seller access revoked due to refund',
            'granted_role' => null,
            'granted_quota' => null,
            'notification_sent' => 0,
            'notification_channel' => null,
            'created_at' => current_time('mysql')
        ],
        ['%d', '%d', '%d', '%s', '%s', '%s', '%s', '%d', '%s', '%s']
    );

    // 更新原記錄的狀態（可選）
    $wpdb->update(
        $wpdb->prefix . 'buygo_seller_grants',
        ['error_message' => 'Revoked due to refund at ' . current_time('mysql')],
        ['id' => $grant_record->id],
        ['%s'],
        ['%d']
    );
}
```
  </action>
  <verify>檢查程式碼語法：`php -l includes/integrations/class-fluentcart-seller-grant.php`</verify>
  <done>退款處理邏輯已實作，包含角色移除、user meta 刪除、資料記錄</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>完整的 Phase 39 功能：後台設定、自動賦予、通知發送、退款撤銷</what-built>
  <how-to-verify>
**測試環境準備：**
1. 確認已設定賣家商品 ID（在角色權限設定頁面）
2. 準備一個測試帳號（沒有 buygo_admin 角色）

**測試 1：後台設定功能**
1. 訪問 https://test.buygo.me/wp-admin/admin.php?page=buygo-settings&tab=roles
2. 確認頂部有「FluentCart 自動賦予設定」區塊
3. 輸入有效的 FluentCart 商品 ID，點擊「驗證商品」
4. 確認顯示商品名稱、價格、虛擬商品狀態
5. 點擊「儲存設定」

**測試 2：自動賦予功能**
1. 使用測試帳號在前台購買設定的賣家商品
2. 完成付款流程
3. 檢查測試帳號是否獲得 buygo_admin 角色
4. 檢查 user meta：buygo_product_limit = 3, buygo_seller_type = 'test'
5. 檢查 wp_buygo_seller_grants 表中有 status = 'success' 記錄

**測試 3：通知功能**
1. 確認收到 LINE 通知（如果已綁定）或 Email 通知（如果未綁定）
2. 確認通知內容包含：恭喜訊息、配額說明、後台連結

**測試 4：重複購買**
1. 使用同一測試帳號再次購買賣家商品
2. 確認不會重複賦予角色
3. 檢查 wp_buygo_seller_grants 表中有 status = 'skipped' 記錄

**測試 5：退款撤銷（如果退款 Hook 可用）**
1. 在 FluentCart 後台對測試訂單進行退款
2. 確認測試帳號的 buygo_admin 角色已移除
3. 確認 user meta 已刪除
4. 檢查 wp_buygo_seller_grants 表中有 status = 'revoked' 記錄

**驗證 debug.log：**
搜尋 `[BuyGo+1][SellerGrant]` 確認所有步驟有記錄
  </how-to-verify>
  <resume-signal>
回報測試結果：
- 測試 1（後台設定）：通過/失敗 + 說明
- 測試 2（自動賦予）：通過/失敗 + 說明
- 測試 3（通知功能）：通過/失敗 + 說明
- 測試 4（重複購買）：通過/失敗 + 說明
- 測試 5（退款撤銷）：通過/失敗/跳過 + 說明

或輸入 "approved" 表示全部通過
  </resume-signal>
</task>

</tasks>

<verification>
1. 後台設定功能正常運作
2. 購買賣家商品後自動獲得 buygo_admin 角色
3. user meta 正確設定
4. 通知正確發送
5. 重複購買時跳過賦予
6. 退款時權限被撤銷（如果 Hook 可用）
7. 所有操作有 debug log 記錄
8. 資料表記錄完整
</verification>

<success_criteria>
- 5 個測試項目全部通過（測試 5 可選，取決於退款 Hook 是否可用）
- debug.log 記錄完整
- 資料表記錄正確
- 無明顯錯誤或警告
</success_criteria>

<output>
After completion, create `.planning/phases/39-fluentcart-自動賦予賣家權限-/39-04-SUMMARY.md`
</output>
