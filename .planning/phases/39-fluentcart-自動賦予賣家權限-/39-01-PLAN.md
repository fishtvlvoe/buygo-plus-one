---
phase: 39-fluentcart-自動賦予賣家權限
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/admin/class-settings-page.php
  - admin/js/admin-settings.js
autonomous: true

must_haves:
  truths:
    - "角色權限設定頁面有「賣家商品 ID（FluentCart）」輸入框"
    - "可以輸入 FluentCart 商品 ID 並儲存到 buygo_seller_product_id option"
    - "輸入時查詢 FluentCart 資料庫，確認商品存在且為虛擬商品"
    - "顯示商品 ID、商品名稱、商品價格，並提供預覽連結"
  artifacts:
    - path: "includes/admin/class-settings-page.php"
      provides: "賣家商品 ID 設定區塊和驗證 AJAX"
      contains: "buygo_seller_product_id"
    - path: "admin/js/admin-settings.js"
      provides: "即時驗證 AJAX 邏輯"
      contains: "validate_seller_product"
  key_links:
    - from: "admin/js/admin-settings.js"
      to: "ajax handler"
      via: "wp_ajax_buygo_validate_seller_product"
      pattern: "validate_seller_product"
---

<objective>
在角色權限設定頁面新增「賣家商品 ID（FluentCart）」輸入框，讓管理員可以設定自動賦予賣家權限的觸發商品。

Purpose: 提供管理介面，讓管理員可以指定哪個 FluentCart 商品購買後會觸發自動賦予賣家權限流程
Output: 角色權限設定頁面新增設定區塊，包含商品 ID 輸入、即時驗證、商品資訊顯示
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-CONTEXT.md
@.planning/phases/39-fluentcart-自動賦予賣家權限-/39-RESEARCH.md
@includes/admin/class-settings-page.php（角色權限頁面位置）
</context>

<tasks>

<task type="auto">
  <name>Task 1: 新增賣家商品 ID 設定區塊到角色權限頁面</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
在 `render_roles_tab()` 方法的開頭（`<div class="wrap">` 之後、使用者列表之前）新增「自動賦予設定」區塊：

1. 處理表單提交（在方法開頭）：
   ```php
   // 處理賣家商品 ID 設定儲存
   if (isset($_POST['buygo_seller_product_submit']) && wp_verify_nonce($_POST['_wpnonce'], 'buygo_seller_product_settings')) {
       $product_id = sanitize_text_field($_POST['buygo_seller_product_id'] ?? '');
       update_option('buygo_seller_product_id', $product_id);
       echo '<div class="notice notice-success"><p>賣家商品 ID 已儲存！</p></div>';
   }
   ```

2. 取得當前設定值：
   ```php
   $seller_product_id = get_option('buygo_seller_product_id', '');
   ```

3. 在 `<h2>角色權限設定</h2>` 之前新增設定區塊 HTML：
   - 標題：「FluentCart 自動賦予設定」
   - 商品 ID 輸入框（text input，id="buygo-seller-product-id"）
   - 驗證按鈕（「驗證商品」）
   - 驗證結果顯示區（商品名稱、價格、虛擬商品狀態、FluentCart 後台連結）
   - 儲存按鈕
   - 說明文字：「設定後，顧客購買此商品並付款完成時，將自動獲得 BuyGo 管理員角色和預設商品配額（3 個）」

4. 區塊樣式：使用 WordPress 標準 .card 樣式，類似 render_checkout_tab() 的表單結構
  </action>
  <verify>瀏覽 https://test.buygo.me/wp-admin/admin.php?page=buygo-settings&tab=roles 確認設定區塊顯示正確</verify>
  <done>角色權限頁面頂部顯示「FluentCart 自動賦予設定」區塊，包含商品 ID 輸入框、驗證按鈕、儲存按鈕</done>
</task>

<task type="auto">
  <name>Task 2: 實作商品驗證 AJAX handler</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
1. 在 `__construct()` 中註冊新的 AJAX action：
   ```php
   add_action('wp_ajax_buygo_validate_seller_product', [$this, 'ajax_validate_seller_product']);
   ```

2. 新增 `ajax_validate_seller_product()` 方法：
   ```php
   public function ajax_validate_seller_product(): void
   {
       check_ajax_referer('buygo-settings', 'nonce');

       if (!current_user_can('manage_options')) {
           wp_send_json_error(['message' => '權限不足']);
       }

       $product_id = sanitize_text_field($_POST['product_id'] ?? '');

       if (empty($product_id)) {
           wp_send_json_error(['message' => '請輸入商品 ID']);
       }

       global $wpdb;

       // FluentCart 商品儲存在 wp_posts（post_type = fct_product）
       $product = $wpdb->get_row($wpdb->prepare(
           "SELECT ID, post_title, post_status FROM {$wpdb->prefix}posts
            WHERE ID = %d AND post_type = 'fct_product'",
           $product_id
       ));

       if (!$product) {
           wp_send_json_error(['message' => '找不到此 FluentCart 商品 ID']);
       }

       if ($product->post_status !== 'publish') {
           wp_send_json_error(['message' => "商品狀態為 {$product->post_status}，必須是 publish"]);
       }

       // 取得商品價格（從 FluentCart 商品表）
       $fct_product = $wpdb->get_row($wpdb->prepare(
           "SELECT price, is_shippable FROM {$wpdb->prefix}fct_products WHERE id = %d",
           $product_id
       ));

       // 檢查是否為虛擬商品（is_shippable = 0）
       if ($fct_product && $fct_product->is_shippable == 1) {
           wp_send_json_error(['message' => '賣家商品必須是虛擬商品（不需要物流）']);
       }

       wp_send_json_success([
           'product' => [
               'id' => $product->ID,
               'title' => $product->post_title,
               'price' => $fct_product ? $fct_product->price : 0,
               'is_virtual' => $fct_product ? ($fct_product->is_shippable == 0) : true,
               'admin_url' => admin_url('post.php?post=' . $product->ID . '&action=edit')
           ]
       ]);
   }
   ```
  </action>
  <verify>使用瀏覽器開發者工具測試 AJAX 呼叫：輸入有效/無效商品 ID，確認回傳正確</verify>
  <done>AJAX handler 正確驗證商品存在性、狀態、虛擬商品類型，回傳商品詳細資訊或錯誤訊息</done>
</task>

<task type="auto">
  <name>Task 3: 實作前端驗證邏輯</name>
  <files>admin/js/admin-settings.js</files>
  <action>
在 admin-settings.js 中新增賣家商品驗證邏輯：

```javascript
// 賣家商品 ID 驗證
$(document).on('click', '#validate-seller-product', function(e) {
    e.preventDefault();

    var $btn = $(this);
    var $input = $('#buygo-seller-product-id');
    var $result = $('#seller-product-validation-result');
    var productId = $input.val().trim();

    if (!productId) {
        $result.html('<span style="color: #dc3232;">請輸入商品 ID</span>');
        return;
    }

    $btn.prop('disabled', true).text('驗證中...');
    $result.html('<span style="color: #666;">正在驗證商品...</span>');

    $.ajax({
        url: buygoSettings.ajaxUrl,
        type: 'POST',
        data: {
            action: 'buygo_validate_seller_product',
            nonce: buygoSettings.nonce,
            product_id: productId
        },
        success: function(response) {
            if (response.success) {
                var p = response.data.product;
                var html = '<div style="background: #e7f5e7; padding: 10px; border-radius: 4px; margin-top: 10px;">';
                html += '<strong style="color: #00a32a;">✓ 商品驗證成功</strong><br>';
                html += '<table style="margin-top: 8px; font-size: 13px;">';
                html += '<tr><td style="padding: 2px 10px 2px 0; color: #666;">商品名稱：</td><td>' + p.title + '</td></tr>';
                html += '<tr><td style="padding: 2px 10px 2px 0; color: #666;">商品價格：</td><td>NT$ ' + p.price + '</td></tr>';
                html += '<tr><td style="padding: 2px 10px 2px 0; color: #666;">虛擬商品：</td><td>' + (p.is_virtual ? '✓ 是' : '✗ 否') + '</td></tr>';
                html += '<tr><td style="padding: 2px 10px 2px 0; color: #666;">後台連結：</td><td><a href="' + p.admin_url + '" target="_blank">編輯商品</a></td></tr>';
                html += '</table></div>';
                $result.html(html);
            } else {
                $result.html('<span style="color: #dc3232;">✗ ' + response.data.message + '</span>');
            }
        },
        error: function() {
            $result.html('<span style="color: #dc3232;">驗證失敗，請稍後重試</span>');
        },
        complete: function() {
            $btn.prop('disabled', false).text('驗證商品');
        }
    });
});

// 商品 ID 輸入時清除驗證結果
$(document).on('input', '#buygo-seller-product-id', function() {
    $('#seller-product-validation-result').html('');
});
```
  </action>
  <verify>在瀏覽器中測試：輸入商品 ID 後點擊驗證，確認顯示商品資訊或錯誤訊息</verify>
  <done>前端可即時驗證商品 ID，顯示商品名稱、價格、虛擬商品狀態、後台連結</done>
</task>

</tasks>

<verification>
1. 瀏覽角色權限設定頁面，確認「FluentCart 自動賦予設定」區塊顯示
2. 輸入有效的 FluentCart 商品 ID，點擊驗證，確認顯示商品資訊
3. 輸入無效的商品 ID，確認顯示錯誤訊息
4. 輸入實體商品 ID（is_shippable = 1），確認顯示「必須是虛擬商品」錯誤
5. 儲存設定，重新整理頁面，確認設定值保留
6. 檢查 `get_option('buygo_seller_product_id')` 確認值已儲存
</verification>

<success_criteria>
- 角色權限頁面頂部有「FluentCart 自動賦予設定」區塊
- 商品 ID 輸入框可以輸入、驗證、儲存
- 驗證功能可區分有效/無效商品、虛擬/實體商品
- 驗證成功時顯示完整商品資訊和後台連結
- 設定值正確儲存到 `buygo_seller_product_id` option
</success_criteria>

<output>
After completion, create `.planning/phases/39-fluentcart-自動賦予賣家權限-/39-01-SUMMARY.md`
</output>
