---
phase: 39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™
plan: 03
type: execute
wave: 2
depends_on: ["39-01", "39-02"]
files_modified:
  - includes/integrations/class-fluentcart-seller-grant.php
  - includes/services/class-notification-templates.php
autonomous: true

must_haves:
  truths:
    - "æ¬Šé™è³¦äºˆæˆåŠŸå¾Œåœ¨åŒä¸€ HTTP request ä¸­åŒæ­¥ç™¼é€é€šçŸ¥ï¼ˆä¸ä½¿ç”¨æ’ç¨‹ï¼‰"
    - "å·²ç¶å®š LINE çš„ä½¿ç”¨è€…æ”¶åˆ° LINE é€šçŸ¥"
    - "æœªç¶å®š LINE çš„ä½¿ç”¨è€…æ”¶åˆ° Email é€šçŸ¥"
    - "é€šçŸ¥å…§å®¹åŒ…å«æ­å–œè¨Šæ¯ã€é…é¡èªªæ˜ã€å¾Œå°é€£çµã€LINE å®˜æ–¹å¸³è™Ÿé€£çµ"
    - "è³¦äºˆå¤±æ•—æ™‚ç™¼é€ Email é€šçŸ¥çµ¦ç®¡ç†å“¡"
  artifacts:
    - path: "includes/integrations/class-fluentcart-seller-grant.php"
      provides: "é€šçŸ¥ç™¼é€é‚è¼¯"
      contains: "send_seller_grant_notification"
    - path: "includes/services/class-notification-templates.php"
      provides: "è³£å®¶è³¦äºˆé€šçŸ¥æ¨¡æ¿"
      contains: "seller_granted"
  key_links:
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "includes/services/class-identity-service.php"
      via: "LINE ç¶å®šæª¢æŸ¥ï¼ˆå·²å­˜åœ¨çš„æ–¹æ³•ï¼‰"
      pattern: "IdentityService::hasLineBinding"
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "NotificationService"
      via: "LINE é€šçŸ¥ç™¼é€"
      pattern: "NotificationService::sendRawText"
    - from: "includes/integrations/class-fluentcart-seller-grant.php"
      to: "wp_mail"
      via: "Email é€šçŸ¥ç™¼é€"
      pattern: "wp_mail"
---

<objective>
å¯¦ä½œè³£å®¶æ¬Šé™è³¦äºˆçš„é€šçŸ¥ç³»çµ±ï¼Œæ”¯æ´ LINE å„ªå…ˆï¼ˆfallback åˆ° Emailï¼‰çš„é›™ç®¡é“é€šçŸ¥ï¼Œä»¥åŠç®¡ç†å“¡å¤±æ•—é€šçŸ¥ã€‚

Purpose: ç¢ºä¿ä½¿ç”¨è€…åœ¨ç²å¾—è³£å®¶æ¬Šé™å¾Œç«‹å³çŸ¥é“å¦‚ä½•é–‹å§‹ä½¿ç”¨ï¼ŒåŒæ™‚è®“ç®¡ç†å“¡èƒ½å¤ åŠæ™‚ç™¼ç¾è³¦äºˆå¤±æ•—çš„æƒ…æ³
Output: å®Œæ•´çš„é€šçŸ¥é‚è¼¯ï¼ŒåŒ…å«é€šçŸ¥æ¨¡æ¿ã€LINE/Email ç™¼é€ã€ç®¡ç†å“¡å¤±æ•—é€šçŸ¥
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™-/39-CONTEXT.md
@.planning/phases/39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™-/39-RESEARCH.md
@.planning/phases/39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™-/39-01-SUMMARY.mdï¼ˆåƒè€ƒè¨­å®šåŠŸèƒ½ï¼‰
@.planning/phases/39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™-/39-02-SUMMARY.mdï¼ˆåƒè€ƒæ ¸å¿ƒé‚è¼¯ï¼‰
@includes/services/class-notification-handler.phpï¼ˆé€šçŸ¥ç™¼é€åƒè€ƒï¼‰
</context>

<tasks>

<task type="auto">
  <name>Task 1: æ–°å¢é€šçŸ¥ç™¼é€æ–¹æ³•åˆ°æ•´åˆé¡åˆ¥</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
**å¼•ç”¨ IdentityService:**
åœ¨æª”æ¡ˆé ‚éƒ¨çš„ namespace è²æ˜ä¹‹å¾Œï¼Œç¢ºä¿å¯ä»¥ä½¿ç”¨ IdentityServiceï¼š
```php
// IdentityService ä½æ–¼ includes/services/class-identity-service.php
// å‘½åç©ºé–“: BuygoPlus\Services\IdentityService
// ä½¿ç”¨æ–¹å¼: \BuygoPlus\Services\IdentityService::hasLineBinding($user_id)
```

åœ¨ `FluentCartSellerGrantIntegration` é¡åˆ¥ä¸­æ–°å¢ä»¥ä¸‹æ–¹æ³•ï¼š

1. ä¿®æ”¹ `grant_seller_access()` æ–¹æ³•ï¼Œåœ¨æˆåŠŸè³¦äºˆå¾Œå‘¼å«é€šçŸ¥ï¼š
   ```php
   // è¨˜éŒ„åˆ°è³‡æ–™è¡¨
   $grant_id = self::log_grant_attempt($order->id, $user_id, $seller_product_id, 'success', null);

   // ç™¼é€é€šçŸ¥
   $notification_result = self::send_seller_grant_notification($user_id, $grant_id);

   // æ›´æ–°é€šçŸ¥ç‹€æ…‹
   if ($notification_result['sent']) {
       self::update_notification_status($grant_id, true, $notification_result['channel']);
   }
   ```

2. æ–°å¢ `send_seller_grant_notification()` æ–¹æ³•ï¼š
   ```php
   /**
    * ç™¼é€è³£å®¶æ¬Šé™è³¦äºˆé€šçŸ¥
    *
    * é€šçŸ¥ç®¡é“åˆ¤æ–·ï¼š
    * - å·²ç¶å®š LINEï¼šç™¼é€ LINE é€šçŸ¥
    * - æœªç¶å®š LINEï¼šç™¼é€ Email
    *
    * @param int $user_id WordPress ä½¿ç”¨è€… ID
    * @param int $grant_id è³¦äºˆè¨˜éŒ„ ID
    * @return array ['sent' => bool, 'channel' => string|null]
    */
   private static function send_seller_grant_notification(int $user_id, int $grant_id): array
   {
       $user = get_userdata($user_id);
       if (!$user) {
           error_log(sprintf('[BuyGo+1][SellerGrant] Cannot send notification: user #%d not found', $user_id));
           return ['sent' => false, 'channel' => null];
       }

       // æº–å‚™é€šçŸ¥å…§å®¹
       $message = self::get_notification_message($user_id);
       $dashboard_url = home_url('/buygo-admin/');
       $line_official_url = 'https://line.me/ti/p/@317qvsmj'; // BuyGo LINE å®˜æ–¹å¸³è™Ÿ

       // æª¢æŸ¥æ˜¯å¦æœ‰ LINE ç¶å®šï¼ˆä½¿ç”¨ç¾æœ‰çš„ IdentityServiceï¼‰
       // IdentityService ä½æ–¼ includes/services/class-identity-service.php
       $has_line_binding = \BuygoPlus\Services\IdentityService::hasLineBinding($user_id);

       if ($has_line_binding) {
           // ç™¼é€ LINE é€šçŸ¥
           try {
               $line_message = $message . "\n\n";
               $line_message .= "ğŸ“² å¾Œå°ç®¡ç†ï¼š\n{$dashboard_url}\n\n";
               $line_message .= "ğŸ’¬ åŠ å…¥ BuyGo LINE å®˜æ–¹å¸³è™Ÿï¼š\n{$line_official_url}\n\n";
               $line_message .= "ğŸ’¡ æç¤ºï¼šåœ¨ LINE è¼¸å…¥ /id å¯æŸ¥è©¢æ‚¨çš„èº«ä»½";

               $result = \BuyGoPlus\Services\NotificationService::sendRawText($user_id, $line_message);

               if ($result) {
                   error_log(sprintf('[BuyGo+1][SellerGrant] LINE notification sent to user #%d', $user_id));
                   return ['sent' => true, 'channel' => 'line'];
               }
           } catch (\Exception $e) {
               error_log(sprintf('[BuyGo+1][SellerGrant] LINE notification failed: %s', $e->getMessage()));
           }
       }

       // Fallback åˆ° Email
       if ($user->user_email) {
           $email_result = self::send_seller_grant_email($user, $dashboard_url, $line_official_url);
           if ($email_result) {
               error_log(sprintf('[BuyGo+1][SellerGrant] Email notification sent to %s', $user->user_email));
               return ['sent' => true, 'channel' => 'email'];
           }
       }

       error_log(sprintf('[BuyGo+1][SellerGrant] Failed to send notification to user #%d', $user_id));
       return ['sent' => false, 'channel' => null];
   }
   ```

3. æ–°å¢ `get_notification_message()` æ–¹æ³•ï¼š
   ```php
   /**
    * å–å¾—é€šçŸ¥è¨Šæ¯å…§å®¹
    *
    * @param int $user_id ä½¿ç”¨è€… ID
    * @return string
    */
   private static function get_notification_message(int $user_id): string
   {
       $user = get_userdata($user_id);
       $display_name = $user ? $user->display_name : 'æ–°è³£å®¶';

       return "ğŸ‰ æ­å–œ {$display_name} æˆç‚º BuyGo è³£å®¶ï¼\n\n" .
              "æ‚¨å·²ç²å¾—ä»¥ä¸‹æ¬Šé™ï¼š\n" .
              "âœ… BuyGo ç®¡ç†å“¡è§’è‰²\n" .
              "âœ… å•†å“é…é¡ï¼š" . self::DEFAULT_PRODUCT_LIMIT . " å€‹\n\n" .
              "æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹ä¸Šæ¶å•†å“äº†ï¼";
   }
   ```

4. æ–°å¢ `send_seller_grant_email()` æ–¹æ³•ï¼š
   ```php
   /**
    * ç™¼é€è³£å®¶æ¬Šé™è³¦äºˆ Email
    *
    * @param WP_User $user ä½¿ç”¨è€…ç‰©ä»¶
    * @param string $dashboard_url å¾Œå°é€£çµ
    * @param string $line_official_url LINE å®˜æ–¹å¸³è™Ÿé€£çµ
    * @return bool
    */
   private static function send_seller_grant_email($user, string $dashboard_url, string $line_official_url): bool
   {
       $subject = 'ğŸ‰ æ­å–œæˆç‚º BuyGo è³£å®¶ï¼';

       $message = "è¦ªæ„›çš„ {$user->display_name}ï¼Œ\n\n";
       $message .= "æ­å–œæ‚¨æˆç‚º BuyGo è³£å®¶ï¼\n\n";
       $message .= "æ‚¨å·²ç²å¾—ä»¥ä¸‹æ¬Šé™ï¼š\n";
       $message .= "â€¢ BuyGo ç®¡ç†å“¡è§’è‰²\n";
       $message .= "â€¢ å•†å“é…é¡ï¼š" . self::DEFAULT_PRODUCT_LIMIT . " å€‹\n\n";
       $message .= "é–‹å§‹ä½¿ç”¨ï¼š\n";
       $message .= "â€¢ å¾Œå°ç®¡ç†ï¼š{$dashboard_url}\n\n";
       $message .= "åŠ å…¥ BuyGo LINE å®˜æ–¹å¸³è™Ÿç²å¾—æ›´å¤šæ”¯æ´ï¼š\n";
       $message .= "{$line_official_url}\n\n";
       $message .= "ç¶å®š LINE å¾Œï¼Œæ‚¨å¯ä»¥ï¼š\n";
       $message .= "â€¢ ç›´æ¥åœ¨ LINE ä¸Šæ¶å•†å“\n";
       $message .= "â€¢ ä½¿ç”¨ /id æŒ‡ä»¤æŸ¥è©¢èº«ä»½\n";
       $message .= "â€¢ æ¥æ”¶è¨‚å–®å’Œå‡ºè²¨é€šçŸ¥\n\n";
       $message .= "ç¥æ‚¨ç”Ÿæ„èˆˆéš†ï¼\n";
       $message .= "BuyGo åœ˜éšŠ";

       return wp_mail($user->user_email, $subject, $message);
   }
   ```

5. æ–°å¢ `update_notification_status()` æ–¹æ³•ï¼š
   ```php
   /**
    * æ›´æ–°é€šçŸ¥ç‹€æ…‹
    *
    * @param int $grant_id è³¦äºˆè¨˜éŒ„ ID
    * @param bool $sent æ˜¯å¦å·²ç™¼é€
    * @param string|null $channel é€šçŸ¥ç®¡é“
    */
   private static function update_notification_status(int $grant_id, bool $sent, ?string $channel): void
   {
       global $wpdb;
       $wpdb->update(
           $wpdb->prefix . 'buygo_seller_grants',
           [
               'notification_sent' => $sent ? 1 : 0,
               'notification_channel' => $channel
           ],
           ['id' => $grant_id],
           ['%d', '%s'],
           ['%d']
       );
   }
   ```

6. ä¿®æ”¹ `log_grant_attempt()` æ–¹æ³•å›å‚³æ’å…¥çš„ IDï¼š
   ```php
   private static function log_grant_attempt(...): int
   {
       // ... åŸæœ‰ç¨‹å¼ç¢¼ ...

       $wpdb->insert(...);

       return $wpdb->insert_id;
   }
   ```
  </action>
  <verify>æ¸¬è©¦è³¼è²·è³£å®¶å•†å“å¾Œï¼Œç¢ºèªæ”¶åˆ° LINE æˆ– Email é€šçŸ¥</verify>
  <done>é€šçŸ¥ç³»çµ±æ­£ç¢ºç™¼é€ LINEï¼ˆå„ªå…ˆï¼‰æˆ– Email é€šçŸ¥ï¼Œä¸¦æ›´æ–°è³‡æ–™è¡¨ä¸­çš„é€šçŸ¥ç‹€æ…‹</done>
</task>

<task type="auto">
  <name>Task 2: å¯¦ä½œç®¡ç†å“¡å¤±æ•—é€šçŸ¥</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
æ–°å¢ç®¡ç†å“¡å¤±æ•—é€šçŸ¥æ–¹æ³•ï¼š

1. åœ¨ `grant_seller_access()` æ–¹æ³•ä¸­ï¼Œç•¶ç‹€æ…‹ç‚º 'failed' æ™‚å‘¼å«é€šçŸ¥ï¼š
   ```php
   if (!$customer || !$customer->user_id) {
       // ... åŸæœ‰ç¨‹å¼ç¢¼ ...
       self::log_grant_attempt($order->id, 0, $seller_product_id, 'failed', 'Customer not linked to WordPress user');
       self::notify_admin_failure($order->id, 0, 'Customer not linked to WordPress user');
       return;
   }

   if (!$user) {
       // ... åŸæœ‰ç¨‹å¼ç¢¼ ...
       self::log_grant_attempt($order->id, $user_id, $seller_product_id, 'failed', 'WordPress user not found');
       self::notify_admin_failure($order->id, $user_id, 'WordPress user not found');
       return;
   }
   ```

2. æ–°å¢ `notify_admin_failure()` æ–¹æ³•ï¼š
   ```php
   /**
    * é€šçŸ¥ç®¡ç†å“¡è³¦äºˆå¤±æ•—
    *
    * @param int $order_id è¨‚å–® ID
    * @param int $user_id ä½¿ç”¨è€… IDï¼ˆå¯èƒ½ç‚º 0ï¼‰
    * @param string $reason å¤±æ•—åŸå› 
    */
   private static function notify_admin_failure(int $order_id, int $user_id, string $reason): void
   {
       $admin_email = get_option('admin_email');
       if (!$admin_email) {
           error_log('[BuyGo+1][SellerGrant] Cannot notify admin: no admin email configured');
           return;
       }

       $subject = '[BuyGo] è³£å®¶æ¬Šé™è³¦äºˆå¤±æ•—é€šçŸ¥';

       $message = "BuyGo è³£å®¶æ¬Šé™è‡ªå‹•è³¦äºˆæµç¨‹å¤±æ•—\n\n";
       $message .= "è¨‚å–® IDï¼š{$order_id}\n";
       $message .= "ä½¿ç”¨è€… IDï¼š" . ($user_id ?: 'ï¼ˆç„¡ï¼‰') . "\n";
       $message .= "å¤±æ•—åŸå› ï¼š{$reason}\n\n";
       $message .= "è«‹ç™»å…¥å¾Œå°æª¢æŸ¥ä¸¦æ‰‹å‹•è™•ç†ï¼š\n";
       $message .= admin_url('admin.php?page=buygo-settings&tab=roles') . "\n\n";
       $message .= "æ™‚é–“ï¼š" . current_time('Y-m-d H:i:s') . "\n";
       $message .= "---\n";
       $message .= "æ­¤éƒµä»¶ç”± BuyGo+1 å¤–æ›è‡ªå‹•ç™¼é€";

       $sent = wp_mail($admin_email, $subject, $message);

       if ($sent) {
           error_log(sprintf('[BuyGo+1][SellerGrant] Admin notified about failure for order #%d', $order_id));
       } else {
           error_log(sprintf('[BuyGo+1][SellerGrant] Failed to notify admin about order #%d', $order_id));
       }
   }
   ```
  </action>
  <verify>æ¨¡æ“¬å¤±æ•—æƒ…æ³ï¼ˆå¦‚åˆªé™¤ FluentCart customer çš„ user_id é€£çµï¼‰ï¼Œç¢ºèªç®¡ç†å“¡æ”¶åˆ° Email</verify>
  <done>è³¦äºˆå¤±æ•—æ™‚ç®¡ç†å“¡æ”¶åˆ°åŒ…å«è¨‚å–®è³‡è¨Šå’Œå¤±æ•—åŸå› çš„ Email é€šçŸ¥</done>
</task>

<task type="auto">
  <name>Task 3: æ–°å¢é‡è©¦æ©Ÿåˆ¶</name>
  <files>includes/integrations/class-fluentcart-seller-grant.php</files>
  <action>
æ–°å¢ç°¡å–®çš„åŒæ­¥é‡è©¦æ©Ÿåˆ¶ï¼š

1. æ–°å¢ `execute_with_retry()` æ–¹æ³•ï¼š
   ```php
   /**
    * åŸ·è¡Œå¸¶é‡è©¦æ©Ÿåˆ¶çš„æ“ä½œ
    *
    * @param callable $operation è¦åŸ·è¡Œçš„æ“ä½œ
    * @param int $max_retries æœ€å¤§é‡è©¦æ¬¡æ•¸
    * @param int $delay_ms é‡è©¦å»¶é²ï¼ˆæ¯«ç§’ï¼‰
    * @return mixed æ“ä½œçµæœ
    * @throws \Exception æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—æ™‚æ‹‹å‡ºæœ€å¾Œçš„ä¾‹å¤–
    */
   private static function execute_with_retry(callable $operation, int $max_retries = 3, int $delay_ms = 500)
   {
       $last_exception = null;

       for ($attempt = 1; $attempt <= $max_retries; $attempt++) {
           try {
               return $operation();
           } catch (\Exception $e) {
               $last_exception = $e;
               error_log(sprintf(
                   '[BuyGo+1][SellerGrant] Operation failed (attempt %d/%d): %s',
                   $attempt,
                   $max_retries,
                   $e->getMessage()
               ));

               if ($attempt < $max_retries) {
                   usleep($delay_ms * 1000); // è½‰æ›ç‚ºå¾®ç§’
               }
           }
       }

       throw $last_exception;
   }
   ```

2. åœ¨ `send_seller_grant_notification()` ä¸­ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶ï¼š
   ```php
   // ç™¼é€ LINE é€šçŸ¥ï¼ˆå¸¶é‡è©¦ï¼‰
   if ($has_line_binding) {
       try {
           $result = self::execute_with_retry(function() use ($user_id, $line_message) {
               return \BuyGoPlus\Services\NotificationService::sendRawText($user_id, $line_message);
           }, 3, 500);

           if ($result) {
               error_log(sprintf('[BuyGo+1][SellerGrant] LINE notification sent to user #%d', $user_id));
               return ['sent' => true, 'channel' => 'line'];
           }
       } catch (\Exception $e) {
           error_log(sprintf('[BuyGo+1][SellerGrant] LINE notification failed after retries: %s', $e->getMessage()));
       }
   }
   ```
  </action>
  <verify>æª¢æŸ¥ debug.log ç¢ºèªé‡è©¦é‚è¼¯æ­£å¸¸é‹ä½œï¼ˆå¯é€éæš«æ™‚ä¸­æ–·ç¶²è·¯æ¸¬è©¦ï¼‰</verify>
  <done>é€šçŸ¥ç™¼é€æœ‰ 3 æ¬¡é‡è©¦æ©Ÿåˆ¶ï¼Œæ¯æ¬¡é–“éš” 500ms</done>
</task>

</tasks>

<verification>
1. æ¸¬è©¦å·²ç¶å®š LINE çš„ä½¿ç”¨è€…è³¼è²·è³£å®¶å•†å“ï¼Œç¢ºèªæ”¶åˆ° LINE é€šçŸ¥
2. æ¸¬è©¦æœªç¶å®š LINE çš„ä½¿ç”¨è€…è³¼è²·è³£å®¶å•†å“ï¼Œç¢ºèªæ”¶åˆ° Email é€šçŸ¥
3. æª¢æŸ¥é€šçŸ¥å…§å®¹åŒ…å«ï¼šæ­å–œè¨Šæ¯ã€é…é¡èªªæ˜ï¼ˆ3 å€‹ï¼‰ã€å¾Œå°é€£çµã€LINE å®˜æ–¹å¸³è™Ÿé€£çµ
4. æª¢æŸ¥ wp_buygo_seller_grants è¡¨ä¸­çš„ notification_sent å’Œ notification_channel æ¬„ä½
5. æ¨¡æ“¬å¤±æ•—æƒ…æ³ï¼Œç¢ºèªç®¡ç†å“¡æ”¶åˆ°å¤±æ•—é€šçŸ¥ Email
6. æª¢æŸ¥ debug.log ç¢ºèªé‡è©¦æ©Ÿåˆ¶è¨˜éŒ„
</verification>

<success_criteria>
- å·²ç¶å®š LINE çš„ä½¿ç”¨è€…æ”¶åˆ° LINE é€šçŸ¥
- æœªç¶å®š LINE çš„ä½¿ç”¨è€…æ”¶åˆ° Email é€šçŸ¥
- é€šçŸ¥å…§å®¹å®Œæ•´ï¼ˆæ­å–œè¨Šæ¯ã€é…é¡ã€å¾Œå°é€£çµã€LINE å®˜æ–¹å¸³è™Ÿï¼‰
- è³‡æ–™è¡¨æ­£ç¢ºè¨˜éŒ„é€šçŸ¥ç‹€æ…‹å’Œç®¡é“
- å¤±æ•—æ™‚ç®¡ç†å“¡æ”¶åˆ° Email é€šçŸ¥
- é‡è©¦æ©Ÿåˆ¶æ­£å¸¸é‹ä½œï¼ˆ3 æ¬¡é‡è©¦ï¼‰
</success_criteria>

<output>
After completion, create `.planning/phases/39-fluentcart-è‡ªå‹•è³¦äºˆè³£å®¶æ¬Šé™-/39-03-SUMMARY.md`
</output>
