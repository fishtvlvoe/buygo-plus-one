# Plan 23-02: Rewrite Rules 自動 Flush

```yaml
wave: 1
depends_on: []
files_modified:
  - includes/class-routes.php
  - buygo-plus-one.php
autonomous: true
```

## Goal

實作 flag-based rewrite rules flush 機制，確保外掛啟用時自訂路由自動生效。

## Context

- 使用 WordPress transient 作為 flag
- 參考 ShortLinkRoutes 的成功實作
- 在 init hook (priority 20+) 檢查並執行 flush
- activation hook 設定 flag，deactivation hook 清理規則

## Tasks

### Task 1: 在 Routes 類別新增 flush 方法

修改 `includes/class-routes.php`，新增 flag-based flush 機制：

```xml
<edit file="includes/class-routes.php">
<find>
	public function __construct() {
		add_action('init', [$this, 'register_rewrite_rules']);
		add_filter('query_vars', [$this, 'add_query_vars']);
		add_action('template_redirect', [$this, 'handle_buygo_pages']);
	}
</find>
<replace>
	public function __construct() {
		add_action('init', [$this, 'register_rewrite_rules']);
		add_filter('query_vars', [$this, 'add_query_vars']);
		add_action('template_redirect', [$this, 'handle_buygo_pages']);

		// 檢查並執行 rewrite rules flush
		add_action('init', [$this, 'maybe_flush_rewrite_rules'], 20);
	}

	/**
	 * 設定 flush rewrite rules flag（供 activation hook 呼叫）
	 */
	public static function schedule_flush() {
		set_transient('buygo_plus_one_flush_routes', 1, 60);
	}

	/**
	 * 檢查並執行 rewrite rules flush
	 */
	public function maybe_flush_rewrite_rules() {
		if (get_transient('buygo_plus_one_flush_routes')) {
			delete_transient('buygo_plus_one_flush_routes');
			flush_rewrite_rules(false); // soft flush
		}
	}
</replace>
</edit>
```

**Expected:** Routes 類別包含 schedule_flush() 和 maybe_flush_rewrite_rules() 方法。

### Task 2: 修改 activation hook 設定 flush flag

修改 `buygo-plus-one.php` 的 activation hook：

```xml
<edit file="buygo-plus-one.php">
<find>
register_activation_hook(__FILE__, function () {
</find>
<replace>
register_activation_hook(__FILE__, function () {
	// 標記需要 flush rewrite rules
	\BuyGoPlus\Routes::schedule_flush();

</replace>
</edit>
```

**Expected:** activation hook 呼叫 Routes::schedule_flush()。

### Task 3: 新增 deactivation hook 清理規則

在 `buygo-plus-one.php` 新增 deactivation hook：

```xml
<edit file="buygo-plus-one.php">
<find>
register_activation_hook(__FILE__, function () {
</find>
<insert_before>
/**
 * Deactivation Hook
 * 外掛停用時清理 rewrite rules
 */
register_deactivation_hook(__FILE__, function () {
	flush_rewrite_rules(false);
});

</insert_before>
</edit>
```

**Expected:** buygo-plus-one.php 包含 deactivation hook。

### Task 4: 測試 rewrite rules flush

```xml
<bash>
# 檢查 Routes 類別是否存在 schedule_flush 方法
grep -n "schedule_flush" includes/class-routes.php

# 檢查 activation hook 是否呼叫 schedule_flush
grep -n "Routes::schedule_flush" buygo-plus-one.php

echo "手動測試步驟："
echo "1. 停用 BuyGo+1 外掛"
echo "2. 重新啟用外掛"
echo "3. 造訪 https://test.buygo.me/buygo-portal/dashboard"
echo "4. 確認路由正常運作（不出現 404）"
</bash>
```

**手動驗證步驟:**
1. 在 WordPress 後台停用 BuyGo+1
2. 重新啟用 BuyGo+1
3. 不進入「設定 → 永久連結」
4. 直接造訪 https://test.buygo.me/buygo-portal/dashboard
5. 確認頁面正常顯示（不是 404）

## Verification Criteria

- [ ] Routes 類別包含 schedule_flush() 靜態方法
- [ ] Routes 類別包含 maybe_flush_rewrite_rules() 方法
- [ ] activation hook 呼叫 Routes::schedule_flush()
- [ ] deactivation hook 直接呼叫 flush_rewrite_rules()
- [ ] 外掛啟用後路由立即生效（無需手動儲存永久連結）
- [ ] transient 正確設定和刪除（避免重複 flush）

## Must-Haves (Goal-Backward)

為了「外掛啟用時自訂路由自動生效」，必須：
1. ✓ activation hook 設定 flush flag
2. ✓ init hook 檢查 flag 並執行 flush
3. ✓ flush 在所有 add_rewrite_rule 之後執行（priority 20+）
4. ✓ deactivation hook 清理規則

## Notes

- 參考研究文件：`.planning/research/REWRITE-RULES.md`
- 參考現有實作：`includes/class-short-link-routes.php`（已使用相同方法）
- 使用 soft flush (`flush_rewrite_rules(false)`) 即可，效能較好
- transient 60 秒過期防止意外重複 flush

---

*Plan: 23-02*
*Created: 2026-01-31*
