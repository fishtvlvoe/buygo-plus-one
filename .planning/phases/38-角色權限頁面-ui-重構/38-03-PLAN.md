---
phase: 38-角色權限頁面-ui-重構
plan: 03
type: execute
wave: 2
depends_on: [38-01, 38-02]
files_modified:
  - includes/admin/class-settings-page.php
  - admin/js/admin-settings.js
autonomous: true

must_haves:
  truths:
    - "商品限制欄位在所有賣家都可以編輯（無 disabled 狀態）"
    - "新賣家的預設商品限制為 3"
    - "輸入 0 表示無限制，顯示提示文字"
  artifacts:
    - path: "includes/admin/class-settings-page.php"
      provides: "商品限制預設值和 UI 邏輯"
      contains: "product_limit.*3"
  key_links:
    - from: ".product-limit-input"
      to: "buygo_update_product_limit"
      via: "AJAX"
      pattern: "product-limit"
---

<objective>
商品限制邏輯統一：移除「真實賣家」的 disabled 限制，統一預設值為 3

Purpose: 讓所有賣家都能編輯商品限制，並將預設值從 2 改為 3
Output: 統一的商品限制編輯體驗
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/STATE.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/REQUIREMENTS.md
@/Users/fishtv/Development/buygo-plus-one-dev/includes/admin/class-settings-page.php (lines 654-935)
@/Users/fishtv/Development/buygo-plus-one-dev/admin/js/admin-settings.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: 修改預設商品限制為 3</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
在 `render_roles_tab()` 方法中修改預設值（約 line 724-728）：

找到：
```php
// 取得商品限制數量 (0 = 無限制)
$product_limit = get_user_meta($user->ID, 'buygo_product_limit', true);
if ($product_limit === '') {
    $product_limit = 2; // 預設為 2 個商品
}
```

改為：
```php
// 取得商品限制數量 (0 = 無限制)
$product_limit = get_user_meta($user->ID, 'buygo_product_limit', true);
if ($product_limit === '') {
    $product_limit = 3; // 預設為 3 個商品（v1.5 更新）
}
```
  </action>
  <verify>
```bash
cd /Users/fishtv/Development/buygo-plus-one-dev && grep -n "product_limit = 3" includes/admin/class-settings-page.php
```
  </verify>
  <done>新賣家的預設商品限制為 3</done>
</task>

<task type="auto">
  <name>Task 2: 移除 disabled 狀態和更新提示文字</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
在 `render_roles_tab()` 方法中修改商品限制欄位（約 line 840-856）：

找到原本的程式碼：
```php
<td>
    <div style="display: flex; align-items: center; gap: 5px;">
        <input
            type="number"
            class="product-limit-input"
            data-user-id="<?php echo esc_attr($user['id']); ?>"
            value="<?php echo esc_attr($user['product_limit']); ?>"
            min="0"
            step="1"
            style="width: 60px; font-size: 12px;"
            <?php echo ($user['seller_type'] === 'real') ? 'disabled' : ''; ?>
        />
        <span style="font-size: 11px; color: #666;">
            <?php echo ($user['seller_type'] === 'real') ? '(無限制)' : '個商品'; ?>
        </span>
    </div>
</td>
```

改為（移除 disabled 邏輯，更新提示文字）：
```php
<td>
    <div style="display: flex; align-items: center; gap: 5px;">
        <input
            type="number"
            class="product-limit-input"
            data-user-id="<?php echo esc_attr($user['id']); ?>"
            value="<?php echo esc_attr($user['product_limit']); ?>"
            min="0"
            step="1"
            style="width: 60px; font-size: 12px;"
        />
        <span style="font-size: 11px; color: #666;">
            <?php echo ($user['product_limit'] == 0) ? '（無限制）' : '個商品'; ?>
        </span>
    </div>
</td>
```

**重要變更：**
1. 移除 `<?php echo ($user['seller_type'] === 'real') ? 'disabled' : ''; ?>` 行
2. 提示文字改為根據 `product_limit == 0` 判斷，而非 `seller_type`
  </action>
  <verify>
```bash
cd /Users/fishtv/Development/buygo-plus-one-dev && php -l includes/admin/class-settings-page.php
# 確認沒有 disabled 屬性
cd /Users/fishtv/Development/buygo-plus-one-dev && grep -n "disabled" includes/admin/class-settings-page.php | grep "product-limit"
# 應該返回空（沒有 disabled）
```
  </verify>
  <done>商品限制欄位對所有賣家都可編輯，提示文字根據數值顯示</done>
</task>

<task type="auto">
  <name>Task 3: 移除 JavaScript 中的 disabled 切換邏輯</name>
  <files>admin/js/admin-settings.js</files>
  <action>
在 `admin/js/admin-settings.js` 中，修改商品限制更新成功後的提示邏輯（約 line 301-343）。

**注意**：Plan 02 已經移除了賣家類型切換的整個 change 事件處理器，所以這裡的重點是確保商品限制的 AJAX 回調中不再有任何 disabled 相關邏輯。

檢查商品限制的成功回調（約 line 324-333），確認它不會根據賣家類型啟用/禁用輸入框。

如果存在，移除類似以下的程式碼（在 Plan 02 移除賣家類型後可能已經不存在）：
```javascript
// 啟用/禁用商品限制輸入框
const limitInput = select.closest('tr').find('.product-limit-input');
const limitHint = limitInput.next('span');
if (sellerType === 'real') {
    limitInput.prop('disabled', true);
    limitHint.text('(無限制)');
} else {
    limitInput.prop('disabled', false);
    limitHint.text('個商品');
}
```

現在商品限制成功更新後，只需要更新提示文字（根據數值是否為 0）：

確認現有的成功回調已經正確處理：
```javascript
success: function(response) {
    if (response.success) {
        // 顯示提示
        const message = $('<div class="notice notice-success" style="padding: 8px 12px; margin: 10px 0;"><p>✅ 商品限制已更新為：' +
            (productLimit === 0 ? '無限制' : productLimit + ' 個商品') +
            '</p></div>');
        input.closest('tr').find('td:first').append(message);
        setTimeout(function() {
            message.fadeOut(function() { $(this).remove(); });
        }, 3000);
    } else {
        alert('更新失敗：' + (response.data || '未知錯誤'));
    }
}
```

這段程式碼已經正確處理 0 = 無限制的情況，不需要修改。
  </action>
  <verify>
```bash
cd /Users/fishtv/Development/buygo-plus-one-dev && cat admin/js/admin-settings.js | grep -c "disabled"
# 檢查是否有 disabled 相關程式碼（應該很少或沒有）
```
  </verify>
  <done>JavaScript 中沒有根據賣家類型切換 disabled 的邏輯</done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過
2. 預設商品限制為 3
3. 商品限制輸入框對所有使用者都可編輯（無 disabled）
4. 提示文字正確：0 顯示「（無限制）」，其他數字顯示「個商品」
5. JavaScript 中沒有 disabled 切換邏輯
</verification>

<success_criteria>
- UI-05 完成：
  - 商品限制欄位在所有賣家都可以編輯
  - 預設值改為 3
  - 0 = 無限制
</success_criteria>

<output>
After completion, create `.planning/phases/38-角色權限頁面-ui-重構/38-03-SUMMARY.md`
</output>
