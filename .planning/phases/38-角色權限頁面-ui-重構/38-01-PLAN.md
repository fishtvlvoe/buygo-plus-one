---
phase: 38-角色權限頁面-ui-重構
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/admin/class-settings-page.php
autonomous: true

must_haves:
  truths:
    - "使用者欄位顯示格式為「使用者名稱 + 換行 + WP-{user_id}」"
    - "角色欄位顯示 BuyGo ID（小幫手）或「無 BuyGo ID」（賣家）"
  artifacts:
    - path: "includes/admin/class-settings-page.php"
      provides: "ID 對應顯示邏輯"
      contains: "WP-"
  key_links:
    - from: "render_roles_tab()"
      to: "wp_buygo_helpers.id"
      via: "SQL query"
      pattern: "buygo_helpers.*id"
---

<objective>
UI 欄位顯示改造：在角色權限頁面新增 WordPress User ID 和 BuyGo ID 顯示

Purpose: 讓管理員清楚看到 WordPress User ID 和 BuyGo 系統內部 ID 的對應關係，便於除錯和資料追蹤
Output: 使用者欄位和角色欄位顯示格式更新
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/STATE.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-plus-one-dev/.planning/REQUIREMENTS.md
@/Users/fishtv/Development/buygo-plus-one-dev/includes/admin/class-settings-page.php (lines 654-935)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 查詢小幫手的 BuyGo ID 並加入 $all_users 陣列</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
在 `render_roles_tab()` 方法中（約 line 700-777），修改使用者資料建構邏輯：

1. **在 foreach 迴圈開始處，查詢小幫手的 BuyGo ID**（約 line 700 後面）：

```php
// 查詢小幫手的 BuyGo ID（從 wp_buygo_helpers 表的 id 欄位）
$buygo_id = null;
if ($has_buygo_helper_role || $is_in_helpers_list) {
    $buygo_id = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM {$helpers_table} WHERE helper_id = %d LIMIT 1",
        $user->ID
    ));
}
```

2. **在 $all_users 陣列中新增 buygo_id 欄位**（約 line 763-777）：

在現有的陣列項目最後加入：
```php
'buygo_id' => $buygo_id ? intval($buygo_id) : null,
```

完整的 $all_users[] 應該變成：
```php
$all_users[] = [
    'id' => $user->ID,
    'name' => $user->display_name,
    'email' => $user->user_email,
    'role' => $role,
    'line_id' => $line_id,
    'is_bound' => !empty($line_id),
    'is_wp_admin' => $is_wp_admin,
    'has_buygo_admin_role' => $has_buygo_admin_role,
    'has_buygo_helper_role' => $has_buygo_helper_role,
    'is_in_helpers_list' => $is_in_helpers_list,
    'seller_type' => $seller_type,
    'product_limit' => intval($product_limit),
    'binding_info' => $binding_info,
    'buygo_id' => $buygo_id ? intval($buygo_id) : null,
];
```
  </action>
  <verify>
檢查 PHP 語法：
```bash
cd /Users/fishtv/Development/buygo-plus-one-dev && php -l includes/admin/class-settings-page.php
```
  </verify>
  <done>$all_users 陣列中每個使用者都有 buygo_id 欄位（小幫手有數字，賣家為 null）</done>
</task>

<task type="auto">
  <name>Task 2: 更新表格標題列和使用者欄位顯示格式</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
1. **修改表格標題列**（約 line 797-808）：

原本的表頭：
```html
<th>使用者</th>
```

保持不變（因為 WordPress User ID 會顯示在使用者名稱下方）。

2. **修改使用者欄位顯示**（約 line 812）：

將：
```php
<td><?php echo esc_html($user['name']); ?></td>
```

改為：
```php
<td>
    <?php echo esc_html($user['name']); ?>
    <br>
    <code style="font-size: 11px; color: #666;">WP-<?php echo esc_html($user['id']); ?></code>
</td>
```

這樣所有使用者都會顯示：
```
張三
WP-5
```
  </action>
  <verify>
訪問角色權限頁面，確認使用者欄位顯示兩行格式
```bash
# 驗證 PHP 語法
cd /Users/fishtv/Development/buygo-plus-one-dev && php -l includes/admin/class-settings-page.php
```
  </verify>
  <done>使用者欄位顯示「使用者名稱 + 換行 + WP-{user_id}」格式</done>
</task>

<task type="auto">
  <name>Task 3: 更新角色欄位顯示 BuyGo ID</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
修改角色欄位顯示（約 line 830）：

將：
```php
<td><?php echo esc_html($user['role']); ?></td>
```

改為：
```php
<td>
    <?php echo esc_html($user['role']); ?>
    <br>
    <?php if ($user['buygo_id']): ?>
        <code style="font-size: 11px; color: #2271b1;">BuyGo-<?php echo esc_html($user['buygo_id']); ?></code>
    <?php else: ?>
        <span style="font-size: 11px; color: #666;">（無 BuyGo ID）</span>
    <?php endif; ?>
</td>
```

這樣：
- 小幫手會顯示：「BuyGo 小幫手 + 換行 + BuyGo-15」
- 賣家會顯示：「BuyGo 管理員 + 換行 +（無 BuyGo ID）」
  </action>
  <verify>
```bash
cd /Users/fishtv/Development/buygo-plus-one-dev && php -l includes/admin/class-settings-page.php
```
訪問角色權限頁面 https://test.buygo.me/wp-admin/admin.php?page=buygo-plus-one-settings&tab=roles 確認顯示格式
  </verify>
  <done>角色欄位顯示 BuyGo ID（小幫手）或「無 BuyGo ID」（賣家）</done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過：`php -l includes/admin/class-settings-page.php`
2. 角色權限頁面能正常載入
3. 使用者欄位顯示「名稱 + WP ID」兩行格式
4. 角色欄位顯示「角色名稱 + BuyGo ID」兩行格式
</verification>

<success_criteria>
- UI-01 完成：使用者欄位顯示 WordPress User ID（格式：使用者名稱 + WP-{id}）
- UI-02 完成：角色欄位顯示 BuyGo ID（小幫手顯示 BuyGo-{id}，賣家顯示「無 BuyGo ID」）
</success_criteria>

<output>
After completion, create `.planning/phases/38-角色權限頁面-ui-重構/38-01-SUMMARY.md`
</output>
