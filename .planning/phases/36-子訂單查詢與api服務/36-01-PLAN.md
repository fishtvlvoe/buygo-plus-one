---
phase: 36-子訂單查詢與api服務
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-child-order-service.php
autonomous: true

must_haves:
  truths:
    - "ChildOrderService 可以查詢指定父訂單的所有子訂單"
    - "查詢使用 Eager Loading 避免 N+1 問題"
    - "子訂單資料包含狀態資訊（payment_status, shipping_status, fulfillment_status）"
    - "金額正確轉換為元（除以 100）"
    - "賣家名稱從商品的 post_author 取得"
  artifacts:
    - path: "includes/services/class-child-order-service.php"
      provides: "子訂單查詢服務"
      min_lines: 100
      exports: ["getChildOrdersByParentId", "formatChildOrder"]
  key_links:
    - from: "class-child-order-service.php"
      to: "FluentCart\\App\\Models\\Order"
      via: "Eloquent Query with Eager Loading"
      pattern: "Order::where.*with\\("
    - from: "class-child-order-service.php"
      to: "FluentCart\\App\\Models\\Customer"
      via: "customer_id to user_id conversion"
      pattern: "Customer::where\\('user_id'"
---

<objective>
實作 ChildOrderService 服務類別，提供子訂單查詢功能

Purpose: 建立後端資料層，讓 API 端點可以查詢子訂單資料（Phase 35 已完成前端整合點）
Output: `includes/services/class-child-order-service.php` 完整功能
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-子訂單查詢與api服務/36-RESEARCH.md

# 參考現有 Service 實作模式
@includes/services/class-order-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 ChildOrderService 類別</name>
  <files>includes/services/class-child-order-service.php</files>
  <action>
建立 ChildOrderService 類別，包含以下方法：

1. `__construct()` - 初始化 DebugService
2. `getChildOrdersByParentId(int $parent_order_id, int $customer_id): array`
   - 驗證父訂單存在
   - 驗證父訂單屬於此 customer_id（權限驗證第二層）
   - 使用 Eager Loading 查詢子訂單：`Order::where('parent_id', $parent_order_id)->with(['order_items'])->get()`
   - 格式化並回傳子訂單陣列
   - 拋出 Exception 若訂單不存在（code: 404）或無權限（code: 403）

3. `formatChildOrder(Order $order): array`
   - 回傳格式化的子訂單資料：
     - id, invoice_no
     - payment_status, shipping_status, fulfillment_status
     - total_amount（除以 100 轉換為元）
     - currency
     - seller_name（從 getSellerNameFromItems 取得）
     - items（從 formatItems 取得）
     - created_at

4. `getSellerNameFromItems($items): string`
   - 從第一個商品的 post_id 取得商品
   - 若商品是 variation，取得 parent 的 post_author
   - 回傳 display_name，或 '未知賣家' 若無法取得

5. `formatItems($items): array`
   - 格式化商品項目：id, product_id, title, quantity, unit_price（除以 100）, line_total（除以 100）

**Namespace:** `BuyGoPlus\Services`

**Use statements:**
```php
use FluentCart\App\Models\Order;
use FluentCart\App\Models\Customer;
```

**注意事項:**
- 金額單位為「分」，需除以 100 轉換為「元」
- 使用 `$this->debugService->log()` 記錄重要操作
- 空子訂單情況回傳空陣列（不是錯誤）
  </action>
  <verify>
檔案語法檢查：
```bash
php -l includes/services/class-child-order-service.php
```
輸出應為 "No syntax errors detected"
  </verify>
  <done>
1. `includes/services/class-child-order-service.php` 存在且無語法錯誤
2. 類別包含 getChildOrdersByParentId、formatChildOrder、getSellerNameFromItems、formatItems 四個方法
3. 使用 Eager Loading（`with(['order_items'])`）查詢
4. 金額已轉換為元（total_amount / 100）
  </done>
</task>

<task type="auto">
  <name>Task 2: 新增 customer_id 轉換輔助方法</name>
  <files>includes/services/class-child-order-service.php</files>
  <action>
在 ChildOrderService 中新增靜態方法：

```php
/**
 * 從 WordPress user_id 取得 FluentCart customer_id
 *
 * @param int $user_id WordPress 使用者 ID
 * @return int|null FluentCart customer_id，若找不到返回 null
 */
public static function getCustomerIdFromUserId(int $user_id): ?int
{
    $customer = Customer::where('user_id', $user_id)->first();
    return $customer ? $customer->id : null;
}
```

**重點：** 這個方法解決 customer_id 與 user_id 混淆的問題（見 36-RESEARCH.md Pitfall 1）

**使用方式：**
```php
$current_user_id = get_current_user_id();
$customer_id = ChildOrderService::getCustomerIdFromUserId($current_user_id);
```
  </action>
  <verify>
確認方法存在：
```bash
grep -n "getCustomerIdFromUserId" includes/services/class-child-order-service.php
```
應返回方法定義所在行號
  </verify>
  <done>
1. `getCustomerIdFromUserId` 靜態方法存在
2. 方法從 wp_fct_customers 表查詢 user_id 對應的 customer_id
3. 找不到時回傳 null
  </done>
</task>

</tasks>

<verification>
1. 檔案語法正確：`php -l includes/services/class-child-order-service.php`
2. 類別結構完整（grep 確認所有方法存在）
3. Eager Loading 使用：grep 確認 `with(['order_items'])`
4. 金額轉換：grep 確認 `/ 100`
</verification>

<success_criteria>
- includes/services/class-child-order-service.php 存在且無語法錯誤
- 包含 getChildOrdersByParentId、formatChildOrder、getSellerNameFromItems、formatItems、getCustomerIdFromUserId 五個方法
- 使用 Eager Loading 避免 N+1 查詢
- 金額已轉換為元（除以 100）
- 賣家名稱從商品 post_author 取得
</success_criteria>

<output>
After completion, create `.planning/phases/36-子訂單查詢與api服務/36-01-SUMMARY.md`
</output>
