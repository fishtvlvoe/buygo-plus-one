---
phase: 36-子訂單查詢與api服務
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - includes/api/class-child-orders-api.php
  - includes/api/class-api.php
autonomous: true

must_haves:
  truths:
    - "GET /wp-json/buygo-plus-one/v1/child-orders/{parent_order_id} 端點可用"
    - "僅登入使用者可存取（permission_callback 驗證）"
    - "僅訂單所屬顧客可查詢（Service 層驗證）"
    - "回傳格式化的子訂單 JSON 資料"
    - "錯誤情況回傳正確 HTTP 狀態碼（403、404、500）"
  artifacts:
    - path: "includes/api/class-child-orders-api.php"
      provides: "子訂單 REST API 端點"
      min_lines: 80
      exports: ["register_routes", "get_child_orders", "check_customer_permission"]
    - path: "includes/api/class-api.php"
      provides: "API 路由註冊"
      contains: "ChildOrders_API"
  key_links:
    - from: "class-child-orders-api.php"
      to: "class-child-order-service.php"
      via: "Service injection in constructor"
      pattern: "new ChildOrderService\\(\\)"
    - from: "class-api.php"
      to: "class-child-orders-api.php"
      via: "require_once and register_routes"
      pattern: "class-child-orders-api.php"
---

<objective>
實作 ChildOrders_API 類別和 REST API 端點，提供子訂單資料給前端

Purpose: 完成後端 API 層，讓 Phase 35 建立的前端 JavaScript 可以呼叫取得子訂單資料
Output: `includes/api/class-child-orders-api.php` 完整功能，並整合到 `class-api.php`
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-子訂單查詢與api服務/36-RESEARCH.md
@.planning/phases/36-子訂單查詢與api服務/36-01-SUMMARY.md

# 參考現有 API 實作模式
@includes/api/class-orders-api.php
@includes/api/class-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 ChildOrders_API 類別</name>
  <files>includes/api/class-child-orders-api.php</files>
  <action>
建立 ChildOrders_API 類別，參考 class-orders-api.php 的模式：

**檔案開頭：**
```php
<?php
namespace BuyGoPlus\Api;

use BuyGoPlus\Services\ChildOrderService;

if (!defined('ABSPATH')) {
    exit;
}
```

**類別屬性：**
```php
private $namespace = 'buygo-plus-one/v1';
private $childOrderService;
```

**方法：**

1. `__construct()`
   - 初始化 `$this->childOrderService = new ChildOrderService();`

2. `register_routes()`
   - 使用 `register_rest_route()` 註冊端點：
   ```php
   register_rest_route($this->namespace, '/child-orders/(?P<parent_order_id>\d+)', [
       'methods' => 'GET',
       'callback' => [$this, 'get_child_orders'],
       'permission_callback' => [$this, 'check_customer_permission'],
       'args' => [
           'parent_order_id' => [
               'required' => true,
               'validate_callback' => function($param) {
                   return is_numeric($param) && $param > 0;
               },
               'sanitize_callback' => 'absint'
           ]
       ]
   ]);
   ```

3. `check_customer_permission(\WP_REST_Request $request): bool`
   - 第一層權限驗證：`return is_user_logged_in();`
   - **注意：** 這裡只驗證登入狀態，不使用 `API::check_permission()`（那是後台 API 用的）

4. `get_child_orders(\WP_REST_Request $request): \WP_REST_Response`
   - 取得 parent_order_id：`(int) $request->get_param('parent_order_id')`
   - 取得當前用戶的 customer_id：
     ```php
     $current_user_id = get_current_user_id();
     $customer_id = ChildOrderService::getCustomerIdFromUserId($current_user_id);
     ```
   - 若 customer_id 為 null，回傳 404（找不到顧客資料）
   - try-catch 呼叫 Service：
     ```php
     $result = $this->childOrderService->getChildOrdersByParentId($parent_order_id, $customer_id);
     ```
   - 成功回傳：
     ```php
     return new \WP_REST_Response([
         'success' => true,
         'data' => $result
     ], 200);
     ```
   - Exception 處理：
     - code 403 → HTTP 403 + `FORBIDDEN`
     - code 404 → HTTP 404 + `NOT_FOUND`
     - 其他 → HTTP 500 + `SERVER_ERROR`

**回應格式：**
```json
{
    "success": true,
    "data": {
        "child_orders": [...],
        "count": 3,
        "currency": "TWD"
    }
}
```

**錯誤回應格式：**
```json
{
    "success": false,
    "code": "FORBIDDEN",
    "message": "無權限存取此訂單"
}
```
  </action>
  <verify>
檔案語法檢查：
```bash
php -l includes/api/class-child-orders-api.php
```
輸出應為 "No syntax errors detected"
  </verify>
  <done>
1. `includes/api/class-child-orders-api.php` 存在且無語法錯誤
2. 包含 register_routes、check_customer_permission、get_child_orders 三個方法
3. 端點路徑為 `/child-orders/{parent_order_id}`
4. permission_callback 使用 is_user_logged_in()（顧客前台驗證）
5. 正確處理 403、404、500 錯誤情況
  </done>
</task>

<task type="auto">
  <name>Task 2: 整合 API 到 class-api.php</name>
  <files>includes/api/class-api.php</files>
  <action>
修改 `includes/api/class-api.php` 的 `register_routes()` 方法：

1. 在現有 require_once 區塊底部新增：
```php
require_once BUYGO_PLUS_ONE_PLUGIN_DIR . 'includes/api/class-child-orders-api.php';
```

2. 在現有 API 註冊區塊底部新增：
```php
// 註冊子訂單 API（顧客前台用）
$child_orders_api = new ChildOrders_API();
$child_orders_api->register_routes();
```

**注意：** 遵循現有檔案的程式碼風格和註解格式
  </action>
  <verify>
確認整合成功：
```bash
grep -n "ChildOrders_API" includes/api/class-api.php
```
應返回 require_once 和 new ChildOrders_API() 所在行號
  </verify>
  <done>
1. class-api.php 包含 `require_once ... class-child-orders-api.php`
2. class-api.php 包含 `new ChildOrders_API()` 和 `register_routes()` 呼叫
3. 語法正確：`php -l includes/api/class-api.php`
  </done>
</task>

<task type="auto">
  <name>Task 3: 載入 ChildOrderService 依賴</name>
  <files>includes/api/class-child-orders-api.php</files>
  <action>
確保 ChildOrderService 在 API 類別中可用。

在 `class-child-orders-api.php` 的 `__construct()` 方法開頭新增：
```php
// 確保 Service 類別已載入
require_once BUYGO_PLUS_ONE_PLUGIN_DIR . 'includes/services/class-child-order-service.php';
```

**或者**（若 Plugin 類別已在 load_dependencies 中載入所有 Service）確認 class-plugin.php 中有載入 class-child-order-service.php。

檢查 class-plugin.php 的 load_dependencies() 方法，若無則需新增：
```php
require_once BUYGO_PLUS_ONE_PLUGIN_DIR . 'includes/services/class-child-order-service.php';
```
  </action>
  <verify>
確認 Service 可被載入：
```bash
grep -rn "class-child-order-service.php" includes/
```
應找到至少一處 require_once
  </verify>
  <done>
1. ChildOrderService 類別可在 API 中被正確載入
2. 無 "Class not found" 錯誤風險
  </done>
</task>

</tasks>

<verification>
1. 所有檔案語法正確：
   ```bash
   php -l includes/api/class-child-orders-api.php
   php -l includes/api/class-api.php
   ```

2. API 端點已註冊（需要 WordPress 環境）：
   - 訪問 https://test.buygo.me/wp-json/buygo-plus-one/v1
   - 確認 routes 包含 `/child-orders/{parent_order_id}`

3. 權限驗證測試：
   - 未登入訪問 → 應返回 401
   - 登入但非訂單擁有者 → 應返回 403
   - 登入且為訂單擁有者 → 應返回 200 + 子訂單資料
</verification>

<success_criteria>
- includes/api/class-child-orders-api.php 存在且無語法錯誤
- API 端點 GET /child-orders/{parent_order_id} 已註冊
- 權限驗證使用 is_user_logged_in()（第一層）+ Service customer_id 驗證（第二層）
- 錯誤情況回傳正確 HTTP 狀態碼和 JSON 格式
- class-api.php 已整合 ChildOrders_API
</success_criteria>

<output>
After completion, create `.planning/phases/36-子訂單查詢與api服務/36-02-SUMMARY.md`
</output>
