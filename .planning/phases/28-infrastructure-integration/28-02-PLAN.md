# Plan 28-02: NotificationService 通知服務

## Objective

建立 NotificationService 類別，整合 buygo-line-notify 的 MessagingService，提供統一的通知發送介面。

## Tasks

### Task 1: 建立 NotificationService 類別

建立 `includes/services/class-notification-service.php`

**方法設計：**

```php
class NotificationService {
    // 檢查 buygo-line-notify 是否可用
    public static function isLineNotifyAvailable(): bool;

    // 發送文字通知
    public static function sendText(int $user_id, string $template_key, array $args = []): bool;

    // 發送 Flex Message 通知
    public static function sendFlex(int $user_id, string $template_key, array $args = []): bool;

    // 發送通知給多個用戶
    public static function sendToMultiple(array $user_ids, string $template_key, array $args = []): array;

    // 發送通知給賣家和所有小幫手
    public static function sendToSellerAndHelpers(int $seller_id, string $template_key, array $args = []): array;
}
```

### Task 2: 整合 buygo-line-notify MessagingService

**Soft Dependency 處理：**

```php
private static function getMessagingService(): ?object {
    if (!class_exists('\\BuygoLineNotify\\Services\\MessagingService')) {
        return null;
    }
    return new \BuygoLineNotify\Services\MessagingService();
}
```

### Task 3: 使用 NotificationTemplates

整合現有的 `NotificationTemplates::get()` 方法產生訊息內容

### Task 4: 註冊到 Plugin 類別

在 `class-plugin.php` 中載入 NotificationService

## Verification

- [ ] buygo-line-notify 未啟用時優雅降級（返回 false，不報錯）
- [ ] 可以成功呼叫 MessagingService::pushText()
- [ ] 模板變數正確替換
- [ ] sendToMultiple 可以批量發送

## Files Modified

- `includes/services/class-notification-service.php` (新建)
- `includes/class-plugin.php` (修改)
