# Plan 28-01: IdentityService 身份識別服務

## Objective

建立 IdentityService 類別，整合身份識別邏輯，提供統一的介面判斷用戶角色。

## Tasks

### Task 1: 建立 IdentityService 類別

建立 `includes/services/class-identity-service.php`

**方法設計：**

```php
class IdentityService {
    // 根據 LINE UID 取得用戶身份
    public static function getIdentityByLineUid(string $line_uid): array;

    // 根據 WordPress User ID 取得用戶身份
    public static function getIdentityByUserId(int $user_id): array;

    // 判斷用戶是否為賣家
    public static function isSeller(int $user_id): bool;

    // 判斷用戶是否為小幫手
    public static function isHelper(int $user_id): bool;

    // 判斷用戶是否有 LINE 綁定
    public static function hasLineBinding(int $user_id): bool;

    // 取得用戶的 LINE UID
    public static function getLineUid(int $user_id): ?string;
}
```

**返回結構：**

```php
[
    'user_id' => int|null,      // WordPress User ID
    'line_uid' => string|null,  // LINE UID
    'role' => string,           // 'seller' | 'helper' | 'buyer' | 'unbound'
    'is_bound' => bool,         // 是否已綁定 LINE
    'seller_id' => int|null,    // 如果是小幫手，所屬賣家 ID
]
```

### Task 2: 整合現有服務

- 使用 `LineService::get_user_by_line_uid()` 查詢 LINE UID
- 使用 `SettingsService::get_accessible_seller_ids()` 判斷角色
- 使用 `SettingsService::get_line_binding_status()` 查詢綁定狀態

### Task 3: 註冊到 Plugin 類別

在 `class-plugin.php` 中載入 IdentityService

## Verification

- [ ] IdentityService 可以根據 LINE UID 返回正確的身份
- [ ] 賣家身份正確識別
- [ ] 小幫手身份正確識別
- [ ] 買家（有綁定但非賣家/小幫手）正確識別
- [ ] 未綁定用戶正確識別

## Files Modified

- `includes/services/class-identity-service.php` (新建)
- `includes/class-plugin.php` (修改)
