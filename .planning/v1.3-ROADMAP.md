# Roadmap: BuyGo+1 v1.3

**Created:** 2026-02-02
**Milestone:** v1.3 - 出貨通知與 FluentCart 同步系統
**Starting Phase:** 32（延續 v1.2 的 Phase 31）

## Milestones

- ✅ **v1.0 MVP** - Phases 1-22 (shipped 2026-01-29)
- ✅ **v1.1 部署優化與會員權限** - Phases 23-27 (shipped 2026-02-01)
- ✅ **v1.2 LINE 通知觸發機制整合** - Phases 28-31 (shipped 2026-02-01)
- 🚧 **v1.3 出貨通知與 FluentCart 同步系統** - Phases 32-34 (in progress)

## Phase Overview

| # | Phase | Goal | Requirements | Success Criteria |
|---|-------|------|--------------|------------------|
| 32 | 資料庫基礎升級 | 擴充出貨單資料模型支援預計送達時間 | DATA-01, DATA-02 | 3 |
| 33 | 通知觸發與模板引擎 | 實作出貨通知邏輯和模板變數替換 | NOTIF-01~05, TMPL-03, TMPL-05 | 5 |
| 34 | 模板管理介面 | 提供後台 UI 讓賣家自訂通知模板 | DATA-03, TMPL-01, TMPL-02, TMPL-04 | 4 |

---

## 🚧 v1.3 出貨通知與 FluentCart 同步系統 (In Progress)

**Milestone Goal:** 完善出貨流程，實作 LINE 出貨通知功能，讓買家在商品出貨時收到即時通知

**Context:**
- 現有出貨單資料模型已完成（buygo_shipments, buygo_shipment_items）
- 標記出貨時會自動更新子訂單 shipping_status = 'shipped'
- buygo-line-notify 整合基礎已建立（v1.2）
- 缺少：出貨通知觸發器、預計送達時間欄位、模板管理 UI

---

### Phase 32: 資料庫基礎升級

**Goal:** 擴充 buygo_shipments 資料表，支援預計送達時間欄位

**Depends on:** v1.2 Phase 31 完成

**Requirements:**
- DATA-01: 新增 estimated_delivery_at 欄位到 buygo_shipments 表
- DATA-02: 資料庫升級腳本

**Success Criteria** (what must be TRUE):
1. buygo_shipments 表包含 estimated_delivery_at 欄位（DATETIME, NULL allowed）
2. 從舊版本升級到新版本時，dbDelta 自動新增欄位而不影響現有資料
3. Plugin::DB_VERSION 版本號正確更新，確保升級邏輯不重複執行

**Plans:** 1 plan

Plans:
- [x] 32-01-PLAN.md — 資料庫升級腳本（新增 estimated_delivery_at 欄位）

**Status:** ✅ Completed 2026-02-02

---

### Phase 33: 通知觸發與模板引擎

**Goal:** 實作出貨通知觸發邏輯、模板變數替換，和買家 LINE 通知發送

**Depends on:** Phase 32（需要 estimated_delivery_at 欄位）

**Requirements:**
- NOTIF-01: NotificationHandler 監聽出貨單標記為「已出貨」事件
- NOTIF-02: 收集出貨單資訊（商品清單、數量、物流方式、預計送達時間）
- NOTIF-03: 套用出貨通知模板（NotificationTemplates::shipment_shipped）
- NOTIF-04: 透過 NotificationService 發送 LINE 通知給買家
- NOTIF-05: 確保一張出貨單只發送一次通知（即使包含多個子訂單）
- TMPL-03: 預設出貨通知模板
- TMPL-05: 模板變數替換邏輯

**Success Criteria** (what must be TRUE):
1. 賣家標記出貨單為「已出貨」時，自動觸發 buygo/shipment/marked_as_shipped 事件
2. NotificationHandler 正確收集出貨單資訊（商品清單、物流方式、預計送達時間）
3. 出貨通知使用預設模板，變數 {product_list}、{shipping_method}、{estimated_delivery} 正確替換為實際資料
4. 僅買家收到 LINE 通知，賣家和小幫手不收到
5. 同一張出貨單不會重複發送通知（idempotency 機制）

**Plans:** 3 plans

Plans:
- [x] 33-01-PLAN.md — 通知觸發基礎架構（NotificationHandler + Action Hook）
- [x] 33-02-PLAN.md — 模板引擎與變數替換（shipment_shipped 模板 + 格式化方法）
- [x] 33-03-PLAN.md — 通知發送與防重複機制（整合 + Idempotency）

**Status:** ✅ Completed 2026-02-02

---

### Phase 34: 模板管理介面

**Goal:** 提供後台 UI 讓賣家自訂出貨通知模板，並在出貨單建立/編輯表單中新增預計送達時間輸入欄位

**Depends on:** Phase 33（需要通知邏輯完成以測試模板）

**Requirements:**
- DATA-03: 後台出貨單建立/編輯表單新增「預計送達時間」輸入欄位
- TMPL-01: Settings 頁面新增「通知模板」設定區塊
- TMPL-02: 出貨通知模板編輯器（支援變數：{product_list}、{shipping_method}、{estimated_delivery}）
- TMPL-04: 模板儲存到 wp_options（buygo_notification_template_shipment_shipped）

**Success Criteria** (what must be TRUE):
1. Settings 頁面顯示「通知模板管理」區塊，列出所有可用通知類型（商品上架、新訂單、訂單狀態變更、出貨通知）
2. 賣家可以編輯出貨通知模板，系統顯示可用變數列表，並提供「重設為預設值」按鈕
3. 模板儲存到 wp_options（key: buygo_notification_template_shipment_shipped），使用多層快取（static cache + wp_cache）
4. 出貨單建立/編輯頁面顯示「預計送達時間」日期選擇器（選填），儲存時格式化為 MySQL DATETIME 格式

**Plans:** 2 plans

Plans:
- [ ] 34-01-PLAN.md — 出貨通知模板定義（前端 templateDefinitions + 後端 definitions）
- [ ] 34-02-PLAN.md — 預計送達時間輸入欄位（出貨單 Modal + API + 資料庫）

**Status:** Planned

---

## Progress

**Execution Order:**
Phases execute in numeric order: 32 → 33 → 34

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 32. 資料庫基礎升級 | 1/1 | ✅ Complete | 2026-02-02 |
| 33. 通知觸發與模板引擎 | 3/3 | ✅ Complete | 2026-02-02 |
| 34. 模板管理介面 | 0/2 | Planned | - |

---

## Milestone Success Criteria

v1.3 完成時，系統應具備：

1. **資料模型擴充**
   - buygo_shipments 表包含 estimated_delivery_at 欄位
   - 賣家可在建立/編輯出貨單時輸入預計送達時間

2. **LINE 出貨通知**
   - 賣家標記出貨單為「已出貨」→ 自動通知買家
   - 通知內容包含：商品清單、數量、物流方式、預計送達時間
   - 一張出貨單只發送一次通知（即使包含多個子訂單）
   - 僅通知買家（賣家和小幫手不收通知）

3. **通知模板管理**
   - Settings 頁面提供模板管理 UI
   - 預設出貨通知模板清晰易懂
   - 賣家可自訂模板內容（變數替換功能）

4. **整合與相容性**
   - 與 buygo-line-notify 整合（Soft Dependency 模式）
   - 資料庫升級平滑，不影響現有功能
   - 向後相容，未填寫預計送達時間時優雅降級

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| dbDelta 語法錯誤導致升級失敗 | Low | High | 嚴格遵循 WordPress 官方文件格式，測試升級流程 |
| 重複發送通知（idempotency 失敗） | Medium | Medium | 使用 WordPress transient 和嚴格檢查 |
| 模板變數替換錯誤（XSS 漏洞） | Low | High | 使用 esc_html() 防止 XSS，單元測試覆蓋變數替換邏輯 |
| buygo-line-notify 未啟用 | Low | Low | 已實作 Soft Dependency 模式，優雅降級 |

---

*Roadmap created: 2026-02-02*
*Last updated: 2026-02-02 after Phase 32 completion*
